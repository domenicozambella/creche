% !TEX root = creche.tex
\chapter{Lascar invariant sets}
\label{invariantL}

\def\medrel#1{\parbox[t]{6ex}{$\displaystyle\hfil #1$}}
\def\ceq#1#2#3{\parbox[t]{18ex}{$\displaystyle #1$}\medrel{#2}{$\displaystyle #3$}}

\definecolor{brown}{RGB}{150, 50, 10}
\definecolor{green}{RGB}{10,120, 20}
\def\mr{\color{brown}}
\def\gr{\color{green}}

In this chapter we fix a signature $L$, a complete theory $T$ without finite models, and a saturated model $\U$ of inaccessible cardinality $\kappa$ strictly larger than $|L|$.
The notation and implicit assumptions are as in Section~\ref{monster}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Expansions}
\label{expansions}

\def\ceq#1#2#3{\parbox[t]{16ex}{$\displaystyle #1$}\medrel{#2}{$\displaystyle #3$}}

This section is only marginally required in the present chapter so it can be postponed with minor consequences.

We will find it convenient to expand the language $L$ with a predicate for a given $\grD\subseteq\U^{\gr z}$.
We denote by $\<\U,\grD\>$ the corresponding expansion of $\U$.
Generally, we write \emph{$L({\gr\X})$} for the expanded language but, when the intended interpretation of ${\gr\X}$ is only going to be $\grD$, we may write \emph{$L(\grD)$} and abbreviate $\<\U\,;\grD\>\models\phi({\gr\X})$ as $\phi(\grD)$. 


%As usual, $L({\gr\X})$ and $L(\grD)$ denotes also the set of formulas in that language, and we write  $L(A\,;{\gr\X})$ and $L(A\,;\grD)$ for the set of formulas with parameters from $A$.

\begin{remark}
The definitions above are straightforward when ${\gr z}$ finite tuple.
When ${\gr z}$ is an infinite tuple the intuition stays the same but a more involved definition is required.
In fact, first-order logic does not allow predicates with infinite arity.
We think of $L({\gr\X})$ for a two sorted language.
The \textit{home sort}, denoted by $0$, and the ${\gr z}$-\textit{sort}, denoted by ${\gr z}$.
The expansion $\<\U,\grD\>$ has domain $\U$ for the home sort, and $\U^{\gr z}$ for the ${\gr z}$-sort.
Besides the symbols of $L$, there is a function symbol $\pi_i$ for every $i<|{\gr z}|$ which is interpreted as the projection to the $i$-coordinate.
These functions have sort $\<{\gr z},0\>$ (see Section~\ref{many-sorted} for the notation).
There is also a predicate of sort $\<{\gr z}\>$ interpreted as $\grD$.
\end{remark}

What said above is adapted to define the expansion  \emph{$L({\gr\X_i}:i<\lambda)$,} where ${\gr\X_i}$ are predicates of sort ${\gr z_i}$.
Again, when the sets ${\gr\D_i}\subseteq\U^{\gr z_i}$ are the only intended interpretation of  ${\gr\X_i}$, we write \emph{$L({\gr\D_i}:i<\lambda)$.}

\begin{definition}\label{def_ins_sat}
  If $\grC,\grD\subseteq\U^{\gr z}$ we abbreviate $\<\U,\grC\>\equiv_A\<\U,\grD\>$ as $\grC\equiv_A\grD$.
We also say that $\grD$ is \emph{saturated\/} if so is the model $\<\U\,;\grD\>$.
\end{definition}

\begin{remark}\label{rem_el_sat}
For every $\grD\subseteq\U^{\gr z}$ there is a saturated $\grC\equiv\grD$.
In fact, it suffices to find a saturated model $\<\U',{\gr\D'}\>\equiv\<\U,{\gr\D}\>$ of cardinality $\kappa$.
By saturation, there is an isomorphism $f:\U'\to\U$.
Therefore $f[{\gr\D'}]$ is the required set $\grC$.
\end{remark}

\begin{proposition}\label{prop_indiscernible_L(A,D)}
  If $\grD\subseteq\U^{\gr z}$ is invariant over $A$ then every $A$-indiscernible sequence is indiscernible in the language $L(A\,;\grD)$.
\end{proposition}

\begin{proof}
  Let $\bar c=\<c_i:i\in I\>$ be an $A$-indiscernible sequence.
  For every $I_0,I_1\in I^{[n]}$ there is an $f\in\Aut(\U/A)$ such that $fc_{\restriction I_0}=c_{\restriction I_1}$, Hence 

  \ceq{\hfill \phi\big(c_{\restriction I_0}\,;\grD\big)}{\iff}{\phi\big(fc_{\restriction I_0}\,;f[\grD]\big)\medrel{\iff}\phi\big(c_{\restriction I_1}\,;\grD\big)}.
\end{proof}

\begin{exercise}
  Prove that if $\C\subseteq\U^z$ is type-definable over $B$ then $\equiv_{A,B}$ implies $\equiv_{A\,;\C}$.
\end{exercise} 

\begin{exercise}
  Prove that if $\D\subseteq\U^z$ is saturated and invariant over $A$ than it is definable over $A$.
\end{exercise} 



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Lascar strong types}
\label{Lst}
\def\equivL{\stackrel{\smash{\scalebox{.5}{\rm L}}}{\equiv}}


Let $\grD\subseteq\U^{\gr z}$, where ${\gr z}$ is a tuple of length $<\kappa$.
The \emph{orbit of $\grD$ over $A$\/} is the set

\ceq{\hfill\emph{$\oorbit(\grD/A)$}}{=}{\Big\{f[\grD]\ :\ f\in\Aut(\U/A)\Big\}}

So, $\grD$ is invariant over $A$ when $\oorbit(\grD/A)=\big\{\grD\big\}$.
We say that $\grD$ is \emph{Lascar invariant\/} over $A$ if it is invariant over every model $M\supseteq A$.
Recall that this means that if ${\gr a}\equiv_M{\gr c}$ for some model $M$ containing $A$ then ${\gr a}\in\grD\iff{\gr c}\in\grD$.


\begin{proposition}\label{prop_numero_quasi_invarianti}
  Let $\lambda=|L_{\gr z}(A)|$.
There are at most $2^{2^{\lambda}}$ sets $\grD\subseteq\U^{\gr z}$ that are Lascar invariant over $A$.
\end{proposition}

\begin{proof}
  Let $N$ be a model containing $A$ of cardinality $\le\lambda$.
Every set that is Lascar invariant over $A$ is invariant over $N$.
As $|L_{\gr z}(N)|=\lambda$ the bound follows from Proposition~\ref{prop_numberIS}.
\end{proof}

\begin{theorem}\label{thm_Lascar_indiscernibles}
  For every $\grD$ and every $A\subseteq M$ the following are equivalent
  \begin{itemize}
    \item[1.] $\grD$ is Lascar invariant over $A$
    \item[2.] every set in $\oorbit(\grD/A)$ is $M\mbox{-}$invariant
    \item[3.] $\oorbit(\grD/A)$ has cardinality $\le 2^{2^{|L(A)|}}$
    \item[4.] $\oorbit(\grD/A)$ has cardinality $<\kappa$
    \item[5.] ${\gr c_0}\in\grD\iff{\gr c_1}\in\grD$ for every $A\mbox{-}$indiscernible sequence $\<{\gr c_i}:i<\omega\>$.
  \end{itemize}
\end{theorem}

\begin{proof}
  \ssf{1}$\IMP$\ssf{2}. This implication is clear because all sets in $o(\grD/A)$ are Lascar invariant over $A$. 
  
  \ssf{2}$\IMP$\ssf{3}. When $|M|\le|L(A)|$ the implication follows from the bounds discussed in Section~\ref{invariant_sets}.
We temporary add this assumption on $M$.
Once the proof of the proposition is completed, is easily seen to be redundant (by \ssf{4} and Proposition~\ref{prop_numero_quasi_invarianti}). 
  
  \ssf{3}$\IMP$\ssf{4}. This implication holds because $\kappa$ is a strong limit cardinal.

  \ssf{4}$\IMP$\ssf{5}. Assume $\neg$\ssf{5}.
Then we can find an $A\mbox{-}$indiscernible sequence $\<{\gr c_i}:i<\kappa\>$ such that ${\gr c_0}\in\grD\niff {\gr c_1}\in\grD$.
Define

  \ceq{\hfill E({\gr u}\,;{\gr v})}{\IFF}{{\gr u}\in\grC\iff {\gr v}\in\grC}\ \ \ for every $\grC\in o(\grD/A)$.

  Then $E({\gr u}\,;{\gr v})$ is an $A\mbox{-}$invariant equivalence relation.
As $\neg E({\gr c_0}\,;{\gr c_1})$, by Proposition~\ref{prop_indiscernible_L(A,D)}, indiscernibility over $A$ implies that $\neg E({\gr c_i\,},{\gr c_j})$ for every $i<j<\kappa$.
Then $E({\gr u}\,;{\gr v})$ has $\kappa$ equivalence classes.
As $\kappa$ is inaccessible, this implies $\neg$\ssf{4}.

  \ssf{5}$\IMP$\ssf{1}. Fix any ${\gr a}\equiv_N{\gr b}$ where $A\subseteq N$.
It suffices to prove that ${\gr a}\in\grD\iff{\gr b}\in\grD$.
Let $p({\gr z})\in S(\U)$ be a global coheir of $\tp({\gr a}/N)=\tp({\gr b}/N)$.
Let ${\gr\bar c}=\<{\gr c_i}:i<\omega\>$ be a Morley sequence of $p({\gr z})$ over $N,{\gr a},{\gr b}$.
Then both ${\gr a},{\gr\bar c}$ and ${\gr b},{\gr\bar c}$ are $A\mbox{-}$indiscernible sequences.
Therefore, from \ssf{5} we obtain ${\gr a}\in\grD\iff{\gr c_0}\in\grD\iff{\gr b}\in\grD$. 
\end{proof}

For definable sets Lascar invariance reduces to definablity over the algebraic closure.

\begin{corollary}\label{coroll_defble_Lascar_inv}
For every definable set $\grD$ the following are equivalent
  \begin{itemize}
    \item[1.] $\grD$ is Lascar invariant over $A$
    \item[2.] $\grD$ is definable over every model containing $A$
    \item[3.] $\grD\in\acl^\eq\!A$.
  \end{itemize}
\end{corollary}

The following corollary easily follows from Theorem~\ref{thm_Lascar_indiscernibles} and Proposition~\ref{prop_indiscernible_L(A,D)}.
As an exercise the reader may prove it using Proposition~\ref{prop_indiscernibles_set_model}.
 
\begin{corollary}
The following are equivalent
\begin{itemize}
\item[1.] $\grD$ is Lascar invariant over $A$
\item[2.] every sequence of $A$-indiscernibles is $L(A\,;\grD)$-indiscernible.
\end{itemize}
\end{corollary}

\noindent\llap{\textcolor{red}{\Large\warning}\kern1.5ex}%
Given a tuple ${\gr a}\in\U^{\gr z}$, we write \emph{$\Ll({\gr a}/A)$\/} for the intersection of all sets containing ${\gr a}$ that are Lascar invariant over $A$.
Clearly $\Ll({\gr a}/A)$ is Lascar invariant over $A$.
The symbol $\Ll({\gr a}/A)$ is not standard.

\begin{definition}\label{def_Lascar_type}We write \emph{${\gr a}\stackrel{\smash{\scalebox{.5}{\rm L}}}{\equiv}_A{\gr b}$\/} and say that ${\gr a}$ and ${\gr b}$ have the same \emph{Lascar strong type\/} over $A$ if the equivalence ${\gr a}\in\grD\iff{\gr b}\in\grD$ holds for every set $\grD$ that is Lascar invariant over $A$ or, in other words, if $\Ll({\gr a}/A)=\Ll({\gr b}/A)$.
The notation $\mbox{L-stp}({\gr a}/A)=\mbox{L-stp}({\gr b}/A)$ and ${\gr a}E_{_{L/A}}{\gr b}$ are also common in the the literature.
\end{definition}

\begin{proposition}
  The relation $\equivL_A$ is the finest equivalence relation with $<\kappa$ classes that is invariant over $A$.
\end{proposition}

\begin{proof}
  Clearly $\equivL_A$ is an equivalence relation invariant over $A$.
Each equivalence class is Lascar invariant over $A$, hence the number of equivalence classes is bounded by the number of Lascar invariant sets over $A$.
To see that $\equivL_A$ is the finest of such equivalences.
Suppose $\grD$ is an equivalence class of an $A$-invariant equivalence relation with $<\kappa$ classes.
Then $\oorbit(\grD/A)$ has also cardinality $<\kappa$.
Then $\grD$ is Lascar invariant and as such it is union of classes of the relation $\equivL_A$. 
\end{proof}


Let $p({\mr x})\in S(\U)$ be global type.
We say that $p$ is \emph{Lascar invariant\/} over $A$ if the sets ${\gr\D_{p,\phi}}$, for $\phi({\mr x}\,;{\gr z})\in L$, are all Lascar invariant over $A$.
The sets ${\gr\D_{p,\phi}}$ are defined in Section~\ref{invariant_sets}.

\begin{proposition}\label{prop_Lascar_indiscernibles}
  Let $p({\mr x})\in S(\U)$.
  Then the following are equivalent
  \begin{itemize}
    \item[1.] $p({\mr x})$ is Lascar invariant over $A$
    \item[2.] every $A$-indiscernible sequence ${\gr\bar c}$ is indiscernible over $A,{\mr a}$ for every ${\mr a}\models p_{\restriction A,{\gr\bar c}}({\mr x})$
    \item[3.] every $A$-indiscernible sequence ${\gr\bar c}$ is indiscernible over ${\mr a}$ for every ${\mr a}\models p_{\restriction {\gr\bar c}}({\mr x})$.
  \end{itemize}
  For convenience the tuples ${\gr c_i}$ have length $|{\gr z}|=\omega$.
\end{proposition}
\begin{proof} \ssf{1}$\IMP$\ssf{2}.
Assume \ssf{1} and fix an $A$-indiscernible sequence ${\gr\bar c}=\<{\gr c_i}:i<\omega\>$ and some ${\mr a}\models p_{\restriction{\gr\bar c}}$.
  We need to prove that for every formula $\phi({\mr x}\,;{\gr z_1},\dots,{\gr z_n})\in L(A)$

  \ceq{\hfill\phi({\mr a}\,;{\gr c_{\restriction I_0}})}{\iff}{\phi({\mr a}\,;{\gr c_{I_1}}).}

  holds for every $I_0,I_1\subseteq\omega$ of cardinality $n$.
  Without loss of generality we can assume that $I_0<I_1$.
  Define $I_n$ for $n>1$ arbitrarily such that $I_n<I_{n+1}$.
  Then the sequence ${\gr c'_n}={\gr c_{\restriction I_n}}$ is a sequence of $A$-in\-dis\-cern\-i\-bles and ${\gr c'_0}\in{\gr\D_{p,\phi}}\niff {\gr c'_1}\in{\gr\D_{p,\phi}}$.
  By Theorem~\ref{thm_Lascar_indiscernibles} this contradicts \ssf{1}.
  
  \ssf{2}$\IMP$\ssf{3} is trivial.

  \ssf{3}$\IMP$\ssf{1}.
  If $p({\mr x})$ is not Lascar invariant over $A$ then ${\gr c_0}\in{\gr\D_{p,\phi}}\niff {\gr c_1}\in{\gr\D_{p,\phi}}$ for some $A$-indiscernible sequence ${\gr\bar c}=\<{\gr c_i}:i<\omega\>$ and some $\phi({\mr x}\,;{\gr z})\in L$.
  Then $p({\mr x})$ contains the formula $\phi({\mr x}\,;{\gr c_0})\niff \phi({\mr x}\,;{\gr c_1})$.
  Hence, ${\gr\bar c}$ is not indiscernible over any realization of $p({\mr x})_{\restriction{\gr c_0},{\gr c_1}}$.
\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Coheirs over sets}\label{coheirs_sets}

In this section we consider a property that implies the existence of global Lascar invariant types and has simple syntactic characterization.
It is a natural generalization to a set of the notion of finite satisfiability over a model that we introduced in Section~\ref{coheirs}.

In Section~\ref{coheirs} finite satisfiability over a model has been used to prove that every consistent type over a model has a global extension to a type that is invariant over that model. 
Ideally, we would like to prove here a similar existence property for Lascar invariance over a set.
But this is not possible in general.
In fact, in Example~\ref{ex_cyclic_order}, we present a theory that has no global Lascar invariant type.

% We say that $\phi({\mr x})\in L(\U)$ is \emph{almost satisfiable\/} in $A$ if it is satisfiable in every model containing $A$.
% A type $p({\mr x})\subseteq L(\U)$ is \emph{almost (finitely) satisfiable\/} in $A$ if every conjunction of formulas in $p({\mr x})$ is almost satisfiable in $A$. 

A global type $p({\mr x})\in S(\U)$ that is finitely satisfiable in every model containing $A$, is called a \emph{global coheir\/} of $p_{\restriction A}({\mr x})$. 
Note that when $A$ is a model we obtain the same notion defined in Section~\ref{coheirs}.

\begin{proposition} 
  Let $\phi({\mr x}\,;{\gr z})\in L$.
  Every type $p({\mr x})\in S_\phi(\U)$ that is finitely satisfiable in every $M\supseteq A$ is Lascar invariant over $A$.
\end{proposition}

\begin{proof}
  Let $\<{\gr c_i}:i<\omega\>$ be an $A\mbox{-}$indiscernible sequence.
  Suppose for a contradiction that ${\gr c_0}\in\gr\D_{p,\phi}\niff{\gr c_1}\in\gr\D_{p,\phi}$
  Then $\phi({\mr x}\,;{\gr c_0})\niff\phi({\mr x}\,;{\gr c_1})\ \in p$.
  Let $M\supseteq A$ be such that $\<{\gr c_i}:i<\omega\>$ is indiscernible over $M$.
  As $p({\mr x})$ is finitely satisfiable in $M$, for some ${\mr a}\in M^{\mr x}$ we have $\phi({\mr a}\,;{\gr c_0})\niff\phi({\mr a}\,;{\gr c_1})$.
  This contradicts indiscernibility over $M$.
\end{proof}

\noindent\llap{\textcolor{red}{\Large\warning}\kern1.5ex}%
We say that $A$ is a \emph{coheir extension base\/} if every type that is finitely satisfiable in every $M\supseteq A$ has an extension to a global type with the same property.
The terminology is not standard.
It is inspired by the analogy with extensions bases for forking, see e.g.~\cite{Chernikov}, \cite{Simon}.

\begin{proposition}\label{prop_exisntence_coheirs_over_sets}
  The following are equivalent
  \begin{itemize}
    \item[1.] $A$ is a coheir extension base
    \item[2.] for every $\psi({\mr x}),\phi({\mr x})\in L(\U)$, if $\psi({\mr x})\vee\phi({\mr x})$ is finitely satisfied in every $M\supseteq A$, then $\psi({\mr x})$ or $\phi({\mr x})$ is finitely satisfied in every $M\supseteq A$. 
  \end{itemize}  
\end{proposition}
  
\begin{proof} 
  \ssf1$\IMP$\ssf2. Clear.
  
  \ssf2$\IMP$\ssf1. Assume \ssf2 and repeat the proof of Proposition~\ref{prop_exisntence_coheirs}.
\end{proof}
  
Trivially, every model is an extension base for coheirs.
The following example shows that some theories may have no other extension bases.

\begin{example}
  Consider $T_{\rm dlo}$.
  Suppose $A$ is not a model.
  We show that $A$ is not an extension base for coheirs.
  As $A$ is not a model, there are $a<c$ in $A$ such that either $A\cap(a,c)=\varnothing$ or $a\le A$ or $A\le c$.
  In the first case let $b\in(a,c)$. 
  Then every model containing $A$ intersects $(a,b)\cup (b,c)$, but there are both models that omit $(a,b)$ and models that omit $(b,c)$.
  In the second case let $b<a$ and consider $(-\infty,b)\cup (b,a)$.
  The third case is symmetric.
\end{example}

In Chapter~\ref{stability} we will see that for some important class of theories, \textit{stable theories}, all sets are coheir extension bases.

\begin{example}\label{ex_cyclic_order}
  We present a theory without global types that are Lascar invariant over the empty set.
  Let $T$ be the theory of $\QQ$ with the \emph{cyclic order,} i.e.\@ with a ternary predicate ${\rm cyc}(a, b, c)$ that  holds if

  \hfil $(a < b < c)\ \vee\ (c < a < b)\ \vee\ (b < c < a)$.

  The picture to keep in mind is that of a circle, where ${\rm cyc}(a, b, c)$ holds if we encounter $a,b,c$ in that order when going clockwise.

  We will implicitly use that $T$ has elimination of quantifiers.
  Let $p(x)\in S(\U)$.
  We claim that $p(x)$ is not Lascar invariant over the empty set.
  Suppose it is, for a contradiction.
  We can find $a<b$ in $\U$ such that either ${\rm cyc}(a, x, b)$ or ${\rm cyc}(a, b, x)$ is in $p(x)$.
  We show that both these possibilities are contradictory.
  \begin{itemize}
  \item[1.] If $p(x)$ contains ${\rm cyc}(a, x, b)$,
  let $M<a$ be a model and pick $c$ such that $b<c$.
  Then $a, b \equiv_M b, c$, hence ${\rm cyc}(b, x, c)$ is also in $p(x)$.
  A contradiction.
  \item[2.] If $p(x)$ contains ${\rm cyc}(a, b, x)$,
  let $a<M<b$ and pick $a'$ such that $a<a'<M$. 
  As $a, a' \equiv_M b,a$, also  ${\rm cyc}(b, a, x)$ is in $p(x)$.
  A contradiction.
  \end{itemize}
\end{example}

\begin{exercise}
  Let $A$ be a coheir extension base.
  Prove that for every $b\in\U^z$ there is a structure $\V\preceq\U$ isomorphic to $\U$ over $A$ such that $\V\cnonfork_Mb$ for every $A\subseteq M\preceq\V$.
\end{exercise}

% \begin{exercise}
%   Let $\phi(x)\in L(\U)$ be satisfied in every model containing $A$.
%   Let $M\supseteq A$.  
%   Prove that $\phi(x)$ is contained in some global type finitely satisfied in $M$.
% \end{exercise}

% \begin{exercise}
% Let $\lambda>|L(A)|$ be such that saturated models of cardinality $\lambda$ exist. Prove that if $\phi({\mr x})$ is satisfied in every saturated model $N\supseteq A$ of cardinality $\lambda$, then it is almost satisfied in $A$.
% \end{exercise}

\begin{exercise}
  Let $\phi(x\,;z)\in L$.
  Let $p(x)\in\phi(\U)$ be finitely satisfied in every $M\supseteq A$.
  Prove that if $\D_{p,\phi}$ is saturated, see definition~\ref{def_ins_sat}, then it is in $\acl^\eq\!A$.
\end{exercise}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{The Lascar graph}\label{lascar_graph}

Here we study Lascar strong types from a different viewpoint.
The \emph{Lascar graph\/} over $A$ has an arc between all pairs ${\mr a},{\mr b}\in \U^{\mr x}$ such that  ${\mr a}\equiv_M{\mr b}$ for some model $M$ containing $A$.
We write \emph{$d_A({\mr a},{\mr b})$\/} for the distance between ${\mr a}$ and ${\mr b}$ in the Lascar graph over $A$.
Let us spell this out: $d_A({\mr a},{\mr b})\le n$ if there is a sequence ${\mr a_0},\dots,{\mr a_n}$ such that ${\mr a}={\mr a_0}$, ${\mr b}={\mr a_n}$, and ${\mr a_i}\equiv_{M_i}{\mr a_{i+1}}$ for some models $M_i$ containing $A$.
We write \emph{$d_A({\mr a},{\mr b})<\infty$\/} if ${\mr a}$ and ${\mr b}$ are in the same connected component of the Lascar graph over $A$.

\begin{proposition}\label{tipoforteLascarediametro}
  For every ${\mr a}\in\U^{\mr x}$

  \ceq{\hfill\Ll({\mr a}/A)}{=}{\big\{{\mr c}\ :\ d_A({\mr a},{\mr c})<\infty\big\}.}
\end{proposition}


\begin{proof}
To prove inclusion $\supseteq$ it suffices to show that every Lascar $A$-invariant set containing ${\mr a}$ contains the set on the r.h.s.
Let $\mrD$ be Lascar $A$-invariant, and let ${\mr b}\in\mrD$.
Then $\mrD$ contains also every ${\mr c}$ such that ${\mr b}\equiv_M{\mr c}$ for some model $M$ containing $A$.
That is, $\mrD$ contains every ${\mr c}$ such that $d_A({\mr b},{\mr c})\le 1$.
It follows that $\mrD$ contains every ${\mr c}$ such that $d_A({\mr a},{\mr c})<\infty$. 

To prove inclusion $\subseteq$ we prove the set on the r.h.s.\@ is Lascar $A$-invariant.
Suppose the sequence ${\mr a_0},\dots,{\mr a_n}$, where ${\mr a_0}={\mr a}$ and ${\mr a_n}={\mr c}$, witnesses $d_A({\mr a},{\mr c})\le n$ and suppose that ${\mr c}\equiv_M{\mr b}$ for some $M$ containing $A$, then the sequence ${\mr a_0},\dots,{\mr a_n},{\mr b}$ witnesses $d_A({\mr a},{\mr b})\le n+1$.
\end{proof}

We write \emph{$\Autf(\U/A)$\/} for the subgroup of $\Aut(\U/A)$ that is generated by the automorphisms that fix point-wise some model $M$ containing $A$.
(The ``f'' in the symbol stands for \textit{fort\/}, the French word for \textit{strong}.) It is easy to verify that $\Autf(\U/A)$ is a normal subgroup of $\Aut(\U/A)$.
The following is a corollary of Proposition~\ref{tipoforteLascarediametro}. 

\begin{corollary}
The following are equivalent
\begin{itemize}
 \item[1.] ${\mr a}\equivL_A{\mr b}$
 \item[2.] ${\mr a}=f{\mr b}$\ \ for some $f\in\Autf(\U/A)$.
\end{itemize}
\end{corollary}

% \begin{corollary}
% Let $\Ll=\Ll({\mr a}/A)$ then the sets in $o(\Ll/A)$ is a partition of $\U^{\mr x}$.
% \end{corollary}
% \begin{proof}
% We claim that $f[\Ll]=\Ll$ for every $f\in\Aut(\U/A)$ such that $f{\mr a}\in\Ll$. To prove the claim assume $d({\mr a},f{\mr a})<\infty$. It suffices to show $\Ll\subseteq f[\Ll]$. If ${\mr b}\in\Ll$ then  $d({\mr a},{\mr b})<\infty$ so from Proposition~\ref{prop_Lascar_distance_type_def} we obtain $d(f{\mr a},f{\mr b})<\infty$ and therefore $d({\mr a},f{\mr b})<\infty$. Now the corollary follows because $\Ll=\Ll({\mr b}/A)$ for any ${\mr b}\in\Ll$.
% \end{proof}
% 
% \begin{corollary}
% Let $p({\mr x})\in S(A,{\mr a})$, then $p(\U^{\mr x})\subseteq\Ll({\mr a}/A)$.
% \end{corollary}

It may not be immediately obvious that the relation $d_A({\mr x},{\mr y})\le n$ is type-definable.

\begin{proposition}\label{prop_Lascar_distance_type_def}
There is a type $p_n({\mr x},{\mr y})\subseteq L(A)$ equivalent to $d_A({\mr x},{\mr y})\le n$.  
\end{proposition}
\begin{proof}
It suffices to prove the proposition with $n=1$.
Let $\lambda=|L(A)|$ and fix a tuple of distinct variables $w=\<w_i:i<\lambda\>$, then $p_1({\mr x},{\mr y})\;=\;\E w\;p(w,{\mr x},{\mr y})$ where

\ceq{\hfill p(w,{\mr x},{\mr y})}{=}{q(w)\ \cup\ \Big\{\phi({\mr x},w)\iff\phi({\mr y},w)\ :\ \phi({\mr x},w)\in L(A)\Big\}}

and $q(w)\subseteq L(A)$ is a consistent type with the property that all its realizations enumerate a model containing $A$.

It remains to verify that such a type exist.
Let $\<\psi_i(z,w_{\restriction i}):i<\lambda\>$ be an enumeration of the formulas in $L_{z,w}(A)$, where $z$ is a single variable.
Let 

\ceq{\hfill q(w)}{=}{\Big\{\E z\;\psi_i(z,w_{\restriction i})\;\imp\;\psi_i(w_i,w_{\restriction i})\ :\ i<\lambda\Big\}.}

Any realization of $q(w)$ satisfy the Tarski-Vaught test therefore it enumerates a model containing $A$.
Vice versa it is clear that we can realize $q(w)$ in any model containing $A$.
\end{proof}

\begin{exercise}
  Let $p(x)\in S(A)$.
  Define $Q=\big\{q(x)\in S(\acl^\eq\!A)\, :\, p(x)\subseteq q(x)\big\}$.
  Also, for any $f\in\Aut(\U/A)$, let $fq(x)=\{\phi(x,fb):\phi(x,b)\in q\}$.
  This defines an action of $f\in\Aut(\U/A)$ on $Q$.
  Prove that this action is transitive.
\end{exercise}

\begin{exercise}\label{ex_Lstp_indiscernibles}
  Prove that the equivalence relation $a\stackrel{\smash{\scalebox{.5}{\rm L}}}{\equiv}_Ab$ is the transitive closure of the relation: there is a sequence $\<{\mr c_i}:i<\omega\>$ indiscernible over $A$ such that $c_0=a$ and $c_1=b$.
  Hint: use Exercise~\ref{ex_symmetry_ind} to prove symmetry, then reason as in Proposition~\ref{tipoforteLascarediametro}.
\end{exercise}

\begin{exercise}
  Let $G=\{f\in\Aut(\U/A) : f\D=\D \textrm{ for every }\D \textrm{ with }o(\D/A)\textrm{ bounded}\}$. 
  Prove that $G=\Autf(\U/A)$.
\end{exercise}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Kim-Pillay types}\label{KPtypes}

Given a tuple ${\gr a}\in\U^{\gr z}$, we write \emph{$\K({\gr a}/A)$\/} for the intersection of all type-definable sets containing ${\gr a}$ that are Lascar invariant over $A$.
Or, more concisely, the intersection of all sets that are type-definable over every model containing $A$.
We call $\K({\gr a}/A)$ the \emph{Kim-Pillay strong type\/} over $A$.
Clearly $\K({\gr a}/A)$ is Lascar invariant over $A$.
It also easy to see that $\K({\gr a}/A)$ is type-definable.
In fact, by invariance, we can assume that all types in the intersection above are over $M$, for any fixed model containing $A$.
Hence $\K({\gr a}/A)$ is the minimal type-definable set containing ${\gr a}$ and closed under the relation $\equivL_A$.
It follows that if ${\gr b}\in\K({\gr a}/A)$ then $\K({\gr b}/A)\subseteq\K({\gr a}/A)$.

To summarize, we recall that we have defined a whole hierarchy of strong types obtained from the intersection of different sets with various sots of invariance

\hfil$\Ll({\gr a}/A)\ \subseteq\ \K({\gr a}/A)\ \subseteq\ \S({\gr a}/A)\ \subseteq\ \Orbit({\gr a}/A)$. 

Recall that $\S({\gr a}/A)$ was defined after Proposition~\ref{prop_Shelah_strong_types}.

If $\K({\gr a}/A)=\K({\gr b}/A)$, we say that ${\gr a}$ and ${\gr b}$ have the same \emph{Kim-Pillay strong type\/} over $A$.
We abbreviate this by \emph{${\gr a}\stackrel{\smash{\scalebox{.5}{\rm KP}}}{\equiv}_A{\gr b}$.}
In other words, we write ${\gr a}\equivKP_A{\gr b}$ when ${\gr a}\in\grD\iff{\gr b}\in\grD$ for every type-definable set $\grD$ that is Lascar invariant over $A$.

%We say that ${\gr a}$ and ${\gr b}$ have the same \emph{Kim-Pillay strong type over $A$\/} if $\K({\gr a}/A)=\K({\gr b}/A)$ or, in other words, when ${\gr a}\in\grD\iff{\gr b}\in\grD$ for every type-definable set $\grD$ that is Lascar invariant over $A$. We write \emph{$a\stackrel{\smash{\scalebox{.5}{\rm KP}}}{\equiv}_Ab$}.

\noindent\llap{\textcolor{red}{\Large\warning}\kern1.5ex}%
Warning: the symbol $\K({\gr a}/A)$ is not standard.
The symbol ${\gr a}\equivKP_A{\gr b}$ is not unusual, but some author write $\mbox{KP-stp}({\gr a}/A)=\mbox{KP-stp}({\gr b}/A)$ or ${\gr a}\mathrel{E_{_{{\rm KP}/A}}}{\gr b}$.

\begin{proposition}\label{prop_bardotto}
  Fix some ${\gr a}\in\U^{\gr z}$ and some $A\subseteq\U$.
Then there is a type $e({\gr z}\,;{\gr w})\subseteq L(A)$ such that $\K({\gr b}/A)=e(\U\,;{\gr b})$ for all ${\gr b}\in\orbit({\gr a}/A)$ and $e({\gr z}\,;{\gr w})$ defines an equivalence relation on $\orbit({\gr a}/A)$.
\end{proposition}

\begin{proof}
  Notice that $\K({\gr a}/A)$ is type-definable over $A,{\gr a}$.
  In fact, if $f\in\Aut(\U/A,{\gr a})$ and $\grD$ is a set containing ${\gr a}$ that is type-definable and Lascar invariant over $A$, then so is $f[\grD]$.
  Therefore $\K({\gr a}/A)$ is invariant over $A,{\gr a}$.
  As $\K({\gr a}/A)$ is type-definable, invariance implies that it is type-definable over $A,{\gr a}$.
  Let $e({\gr z}\,;{\gr w})\subseteq L(A)$ be such that $\K({\gr a}/A)=e(\U\,;{\gr a})$. 
    
  We prove that $\K({\gr b}/A)=e(\U\,;{\gr b})$ for all ${\gr b}\in\orbit({\gr a}/A)$.
  Let $f\in\Aut(\U/A)$ be such that $f{\gr a}={\gr b}$.
  If $\grD$ is a type-definable Lascar invariant over $A$, then so is $f[\grD]$.
  Therefore, $f$ is a bijection between type-definable sets that are Lascar invariant over $A$ and contain ${\gr a}$ and analogous sets containing ${\gr b}$.
  Then $f[\K({\gr a}/A)]=\K({\gr b}/A)$ and $\K({\gr b}/A)=e(\U\,;{\gr b})$ follows.
    
  We prove that $e({\gr b}\,;\U)\cap \orbit({\gr a}/A)$ is Lascar invariant over $A$.
  Let $f\in\Autf(\U/A)$ and ${\gr c}\in\orbit({\gr a}/A)$.
  Then $e({\gr b}\,;f{\gr c})$ is equivalent to  $e(f^{-1}{\gr b}\,;{\gr c})$ which in turn is equivalent to $e({\gr b}\,;{\gr c})$, by the invariance of $e(\U\,;{\gr c})$. 
    
  Finally we are ready to prove that $e({\gr z}\,;{\gr w})$ defines a symmetric relation on $\orbit({\gr a}/A)$.
  From what proved above, $e({\gr b}\,;\U)\cap \orbit({\gr a}/A)$ is a type-definable Lascar invariant set containing ${\gr b}$ and therefore it contains $\K({\gr b}/A)$.
  We conclude that for all ${\gr b},{\gr c}\in\orbit({\gr a}/A)$
    
  \ceq{\hfill e({\gr c}\,;{\gr b})}{\iff}{{\gr c}\in e(\U\,;{\gr b})}\medrel{\iff}${\gr c}\in\K({\gr b}/A)$\medrel{\imp}$e({\gr b}\,;{\gr c})$
    
  Reflexivity is clear; we prove transitivity.
  As remarked above, $\K({\gr b}/A)\subseteq\K({\gr c}/A)$, for all ${\gr b}\in\K({\gr c}/A)$ or equivalently $e({\gr b}\,;{\gr c})$.
  Hence if $e({\gr b}\,;{\gr c})$ then
  
  \ceq{\hfill e({\gr d}\,;{\gr b})}{\imp}{{\gr d}\in\K({\gr b}/A)}\medrel{\iff}${\gr d}\in\K({\gr c}/A)$\medrel{\imp}$e({\gr d}\,;{\gr c})$.
    
  Which completes the proof.
\end{proof}

\begin{corollary}\label{corol_KP_simmetry}
For every ${\gr a},{\gr b}\in\U^{\gr z}$ and $A\subseteq\U$ the following are equivalent
\begin{itemize}
\item[1.] ${\gr a}\in\K({\gr b}/A)$
\item[2.] ${\gr b}\in\K({\gr a}/A)$
\item[3.] $\K({\gr a}/A)=\K({\gr b}/A)$.
\end{itemize}
\end{corollary}

The following useful lemma is the key ingredient in the proof of Theorem~\ref{thm_Krupinski}.

\begin{lemma}\label{lem_beq_global}
Let $p({\gr z})\subseteq L(A)$ and let $e({\gr z}\,;{\gr w})\subseteq L(A)$ define a bounded equivalence relation on $p(\U)$.
Then there is a type $e'({\gr z}\,;{\gr w})\subseteq L(A)$ which defines a bounded equivalence relation (on $\U$) and refines $e({\gr z}\,;{\gr w})$ on  $p(\U)$.
\end{lemma}
\begin{proof} 
Let $\grC=\<\grC_i:i<\lambda\>$ enumerate the partition of $p(\U)$ induced by $e({\gr z}\,;{\gr w})$.
Note that each $\grC_i$ is type-definable over $A,{\gr a}$ for any ${\gr a}\in\grC_i$.
If $x=\<{\gr x_i}:i<\lambda\>$, we write $x\in\grC$ for the type that is the conjunction of ${\gr x_i}\in\grC_i$ for $i<\lambda$. 

We claim that the required type is 

\ceq{\hfill e'({\gr a}\,;{\gr b})}{=}{\E x'\in\grC\ \E  x''\in\grC \quad {\gr a},x'\equiv_A{\gr b},x''}

As the type above is invariant over $A$, we can assume that $e'({\gr a}\,;{\gr b})$ is type-definable over $A$.
Moreover, it is clearly a reflexive and symmetric relation, so we only check it is transitive.
Suppose ${\gr a},x'\equiv_A{\gr b},x''$ and  ${\gr b},y'\equiv_A{\gr c},y''$ for some $x',x'',y',y''\in \grC$.
Let $z$ be such that ${\gr a},x',z\equiv_A{\gr b},x'',y'$ then   $z\in\grC$ and ${\gr a},z\equiv_A{\gr c},y''$.

The relation $e'({\gr a}\,;{\gr b})$ clearly refines the equivalence defined by $e({\gr z}\,;{\gr w})$ when restricted to  to $p(\U)$.
To prove that it is bounded fix some $c\in\grC$ and note that $e'({\gr a}\,;{\gr b})$  is refined by ${\gr a}\equiv_{A,c}{\gr b}$, which is bounded. 
\end{proof}

Finally, we have the following.

\begin{theorem}\label{thm_Krupinski}
Denote by $e_A(z\,;w)$ be the finest bounded equivalence relation on $\U^{\gr z}$ that is type-definable over $A$.
Then for every ${\gr a}, {\gr b}\in\U^{\gr z}$ the following are equivalent
 \begin{itemize}
\item[1.] ${\gr a}\equivKP{\gr b}$
\item[2.] $e_A({\gr a}\,;{\gr b})$.
\end{itemize} 
\end{theorem}
\begin{proof} 
  As  ${\gr a}\equivKP{\gr b}$ is equivalent to ${\gr a}\in\K({\gr b}/A)$, it suffices to prove that $e_A(\U\,;{\gr b})=\K({\gr b}/A)$ for every ${\gr b}\in\U^{\gr z}$. 
 
  $\subseteq$. The orbit of $e_A(\U\,;{\gr b})$ under $\Aut(\U/A)$ has cardinality $<\kappa$.
Hence, by Theorem~\ref{thm_Lascar_indiscernibles}, it is  Lascar invariant over $A$.
As $\K({\gr b}/A)$ is the least of such sets, $\K({\gr b}/A)\subseteq e_A(\U\,;{\gr b})$.
  
  $\supseteq$. Let $e({\gr z}\,;{\gr w})$ be the type-definable equivalence relation given by Proposition~\ref{prop_bardotto}. 
  The orbit of $\K({\gr b}/A)$ under $\Aut(\U/A)$ has cardinality $<\kappa$. 
  Hence the equivalence relation $e({\gr z}\,;{\gr w})$ that defines on $\orbit({\gr b}/A)$ is bounded. 
  By Lemma~\ref{lem_beq_global} there is a type-definable bounded equivalence relation $e'({\gr z}\,;{\gr w})\subseteq L(A)$ that refines $e({\gr z}\,;{\gr w})$ on $\orbit({\gr b}/A)$. 
  As $e'({\gr z}\,;{\gr w})$ is refined by $e_A({\gr z}\,;{\gr w})$, we obtain $e_A(\U\,;{\gr b})\subseteq e(\U\,;{\gr b})=\K({\gr b}/A)$.
\end{proof}

The \emph{logic $A$-topology,} or simply the \emph{logic topology\/} when $A$ is empty, is the topology on $\U^{\gr z}$ whose closed sets are the type-definable Lascar $A$-invariant sets.
It is clearly a compact topology.
Its Kolmogorov quotient, that is $\U^{\gr z}/\equivKP$, is Hausdorff.

\begin{exercise}
Prove that the clopen sets in the logic $A$-topology are exactly the sets that are definable over $\acl^\eq A$.
\end{exercise}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Notes and references}


\begin{biblist}[]\normalsize
 \bib{Chernikov}{book}{
  author={Chernikov, Artem},
  title={\href{https://www.ams.org/open-math-notes/omn-view-listing?listingId=110792}{Lecture notes on stability theory}},
  series={Open Math Notes},
  publisher={Amercan Mathematical Society},
  date={2019},
 }\smallskip
  \bib{Simon}{book}{
    author={Simon, Pierre},
    title={\href{http://www.normalesup.org/~simon/NIP_guide.pdf}{A guide to NIP theories}},
    series={Lecture Notes in Logic},
    volume={44},
    publisher={Association for Symbolic Logic, Cambridge University Press},
    date={2015},
  %   pages={vii+156},
  %   isbn={978-1-107-05775-3},
  %   review={\MR{3560428}},
  %   doi={10.1017/CBO9781107415133},
  }\smallskip
\end{biblist}

\begin{comment}


\section{Ziegler's example}

The language $L$ consists of a binary relation symbol $<$ and, for every positive integer $n$, a binary relation denoted by $|x-y|<n$.
Consider the structure with domain $\QQ$ and the relation symbols interpreted in the natural way.
Let $T$ be the theory of this structure.

\begin{proposition}
The theory $T$ has elimination of quantifiers.
\end{proposition}



$n\le d(x,z)\ \wedge\ m\le d(x,y)\ \imp\ n+m\le d(y,z)$

$x<y<z\ \wedge\ d(x,y)<n\ \wedge\ d(y,z)<m\ \imp\ d(x,z)<m+n$


$n\le d(x,y) \ \imp\ n+1\le d(x,y)$

$x<y\ \wedge\ n+1\le d(x,y) \ \imp\ \E z\ \big[x<z<y\ \wedge\ n\le d(x,z)\ \wedge\ 1\le d(z,y)\big]$







The language contains a ternary relation which we denote by $x<_zy$ and a unary function $f(x)$. 
\begin{itemize}
  \item[1.] $x<_zy$ is a dense liner order with least element $z$;
  \item[2.] $x<_zy<_zw\imp y<_xw$;
  \item[3.] $\displaystyle f^nz=z\wedge\bigwedge^{n-1}_{i=0}f^i(z)<_zf^{i+1}(z)$.
\end{itemize}

 
Write $r(x,y)$ for $x=y\vee y<_xf(x)\vee x<_yf(y)$


\section{Externally definable sets}
The set $\grD\cap A^{\gr z}$ is called the \emph{trace\/} of $\grD$ over $A$.
For every formula $\psi({\gr z})\in L(\U)$ we define \emph{$\psi(A)$\/} $=$ $\psi(\U^{\gr z})\cap A^{\gr z}$, that is, the trace on $A$ of the definable set $\psi(\U^{\gr z})=\big\{{\gr a}\in\U^{\gr z}:\psi({\gr a})\big\}$. 

A set $\grD$ is called \emph{externally definable\/} if there are a global type $p({\mr x})\in S(\U)$ and a formula $\phi({\mr x}\,;{\gr z})$ such that $\grD=\grD_{p,\phi}$.
Equivalently, a set $\grD$ is externally definable if it is the trace on $\U^{\gr z}$ of a set which is definable in some elementary extension of $\U$.
This explains the terminology.

We prefer to deal with external definability in a different, though equivalent, way. 

\begin{definition}\label{def_epprox}
We say that $\grD$ is \emph{approximable\/} by the formula $\phi({\mr x}\,;{\gr z})$ if for all finite $B\subseteq\U^{\gr z}$ there is a ${\mr b}\in\U^{|{\mr x}|}$ such that $\phi({\mr b}\,;B)=\grD\cap B$.
We may call the formula $\phi({\mr x}\,;{\gr z})$ the \emph{sort} of $\grD$.
If in addition we have that $\phi({\mr b}\,;\U^{\gr z})\subseteq\grD$, we say that  $\grD$ is \emph{approximable from below}.
If  $\grD\subseteq\phi({\mr b}\,;\U^{\gr z})$ we say that  $\grD$ is \emph{approximable from above}.
\end{definition} 

The following proposition is clear by compactness.

\begin{proposition}\label{lem_approx=external}
For every $\grD$ the following are equivalent:
\begin{itemize}
\item[1.] $\grD$ is approximable;
\item[2.] $\grD$ is externally definable. 
\end{itemize}
\end{proposition}

\begin{example}
Let $T$ be the theory a dense linear orders without endpoints and let $\grD\subseteq\U$ be an interval.
Then $\grD$ is approximable both from below and from above by the formula \mbox{$x_1<z<x_2$}.
Now let $T$ be the theory of the random graph.
Then every $\grD\subseteq\U$ is approximable and, when $\grD$ has small cardinality, it is approximable from above but not from below.
\end{example}

In Definition~\ref{def_epprox}, the sort $\phi({\mr x}\,;{\gr z})$ is fixed (otherwise any set would be approximable).
This requirement of uniformity may be dropped if the sets $B$ are allowed to be large enough.

\begin{proposition}\label{lem_approx_nonunif}
For every $\grD$ the following are equivalent:
\begin{itemize}
\item[1.] $\grD$ is approximable;
\item[2.] for every $B\subseteq\U^{\gr z}$ of cardinality $\le|L|$ there is $\psi({\gr z})\in L(\U)$ such that $\psi(B)=\grD\cap B^{\gr z}$.
\end{itemize}
Similarly, the following are equivalent:
\begin{itemize}
\item[3.] $\grD$ is approximable from below;
\item[4.]  for every $B\subseteq\grD$ of cardinality $\le|L|$ there is $\psi({\gr z})\in L(\U)$ such that $B^{\gr z}\subseteq \psi(\U^{\gr z})\subseteq\grD$.
\end{itemize}
\end{proposition}

\begin{proof}
To prove \ssf{2}$\IMP$\ssf{1}, for a contradiction assume \ssf{2} and $\neg$\ssf{1}.
For each formula $\psi({\mr x}\,;{\gr z})\in L$ choose a finite set $B$ such that $\psi({\mr b}\,;B)\neq\grD\cap B$ for every ${\mr b}\in\U^{|{\mr x}|}$.
Let $C$ be the union of all these finite sets.
Clearly $|C|\le|T|$.
By \ssf{2} there are a formula $\phi({\mr x}\,;{\gr z})$ and a tuple ${\mr c}$ such that $\phi({\mr c}\,;C)=\grD\cap C$, contradicting the definition of $C$.

The implication \ssf{1}$\IMP$\ssf{2} is obtained by compactness and the equivalence \ssf{3}$\IFF$\ssf{4} is proved similarly. 
\end{proof}

\begin{proposition}\label{prop_approx_el_eq}
If $\grD$ is approximable of sort $\phi({\mr x}\,;{\gr z})$ then so is any $\grC$ such that $\grC\equiv\grD$.
The same holds for approximability from below and from above.
\end{proposition}

\begin{proof}
If the set $\grD$ is approximable by $\phi({\mr x}\,;{\gr z})$ then for every $n$

\hfil$\displaystyle\A {\gr z_1},\dots,{\gr z_n}\;\E x\ \bigwedge^n_{i=1}\big[\phi({\mr x}\,;{\gr z_i})\ \iff\ {\gr z_i}\in\grD\big]$. 

So the same holds for any $\grC\equiv\grD$.
As for approximability from below, add the conjunct $\A {\gr z}\,\big[\phi({\mr x}\,;{\gr z})\imp {\gr z}\in\grD\big]$ to the formula above, and similarly for approximability from above.
\end{proof}






Let $x$ be a possibly infinite tuple of variables and let $p(x)\subseteq L(\U)$.
We can identify $p$ with the following family of sets

\ceq{\hfill\grD_{p,\phi}}{=}{\big\{a\in\U^{|z|}\ :\ \phi(x,a)\in p\big\}}

as $\phi(x;z)$ ranges over pure formulas (the tuple $x$ is fixed while $z$ varies with $\phi$).

Given $A\subseteq\U$ and $\grD\subseteq\U^{|z|}$ we call $D=\grD\cap A^{|z|}$ the \emph{trace\/} of $\grD$ on $A$.
For $\psi(z)\in L(\U)$ we write \emph{$\psi(A)$\/} for $\psi(\U)\cap A^{|z|}$, the trace of $\psi(\U)$ on $A$.

Let $p(x)\in S(\U)$ be a global type and let $\phi(x;z)$ be a pure formula.
Sets of the form $\grD_{p,\phi}$ are called \emph{externally definable sets\/} as they may be seen as the trace on $\U$ of a set definable in an elementary extension of $\U$.
We now give an equivalent description of externally definable sets.

We say that $\grD\subseteq\U^{|z|}$ is an \emph{approximable set\/} if for some formula  $\phi(x;z)$, for every finite set $B\subseteq\U^{|z|}$ there exists a $b\in\U^{|x|}$ such that $\phi(b;B)=\grD\cap B$.
We may say that $\phi(x;z)$ approximates $\grD$.
We say that $\grD$ is approximable \emph{in\/} $A$ if we can further require that $b\in A^{|x|}$.
Terminology in this paragraph is not standard.

The following is immediate by compactness.

\begin{proposition}\label{lem_approx=external}
For every $\grD\subseteq\U^{|z|}$ the following are equivalent:
\begin{itemize}
\item[1.] $\grD$ is approximable;
\item[2.] $\grD$ is externally definable. 
\end{itemize}
\end{proposition}

In the definition of approximable we fixed a sort $\phi(x;z)$ otherwise every set would be trivially approximable.
We leave to the reader to check that, if we require $\grD$ to be approximable on sufficiently large sets, uniformity follows.

\begin{proposition}\label{lem_approx_nonunif}
For every $\grD\subseteq\U^{|z|}$ the following are equivalent
\begin{itemize}
\item[1.] $\grD$ is approximable;
\item[2.] for every $B\subseteq\U^{|z|}$ of cardinality $\le(|L|+\omega)^+$ there is a  $\psi(z)\in L(\U)$ such that $\psi(B)=\grD\cap B$.
\end{itemize}
\end{proposition}

We say that a type $p(x)\subseteq L(\U)$ is \emph{finitely satisfiable in\/} $A$ if $\psi(A)\neq\varnothing$ for every $\psi(x)\in p$.
Notice that by elementarity every type $p(x)\subseteq L(M)$ is finitely satisfiable in $M$, for any model $M$.
The following is clear:

\begin{proposition}\label{lem_approx_from=external_fin_sat}
For every $\grD\subseteq\U^{|z|}$ the following are equivalent:
\begin{itemize}
\item[1.] $\grD$ is approximable in $A$;
\item[2.] $\grD$ is externally definable by a type finitely satisfiable in $A$.
\end{itemize}
\end{proposition}

\begin{proposition}\label{prop_coeredi_invarienti}
Let  $\grD\subseteq\U^{|z|}$ be approximable in $A$, than it is invariant over $A$.
\end{proposition}

\begin{proof}
Suppose $\grD$ is not invariant, say $a\in\grD$ and $fa\notin\grD$ for some $f\in\Aut(\U/A)$.
Let $\phi(x;z)$ be the formula that approximates $\grD$ in $A$.
Then there is a $b\in A^{|x|}$ such that  $\phi(b;a)\wedge\neg\phi(b;f\!a)$ a contradiction.
\end{proof}

Of course, a similar fact holds for global types.




%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Il prodotto di tipi}\label{tipi_prodotto}

La seguente proposizione mostra che possiamo ragionevolmente parlare di tipo delle di Morley di $p$.
Questo paragrafo \`e dedicato alla descrizione sintattica di questo tipo.

\begin{proposition}\label{prop_tiposequenzaMorley}
Sia $p\in S_x(\U)$ un tipo globale $A$-invariante e supponiamo che $a$ e $b$ siano due sequenze di Morley di $p$ su $A$.
Allora $a\equiv_A c$. 
\end{proposition}
\begin{proof}
%Possiamo assumere che $a=\<a_i:i<\omega\>$ e $\bar c=\<c_i:i<\omega\>$ abbiano lunghezza $\omega$. 
Per indiscernibilit\`a, \`e sufficiente mostrare che $a_{\restriction i}\equiv_Ac_{\restriction i}$ per ogni $i<\omega$.
Ragioniamo per induzione, assumiamo l'equivalenza come ipotesi induttiva, fissiamo una formula $\phi(\bar x_{\restriction i},{\gr x})\in L(A)$ e dimostriamo che 

\ceq{\hfill \phi(a_{\restriction i},{\gr a_i})}{\iff}{\phi(c_{\restriction i},{\gr c_i})} 

Se $\phi(a_{\restriction i},{\gr a_i})$ allora $\phi(a_{\restriction i},{\gr x})\in p$.
Per l'ipotesi induttiva e per l'invarianza di $p$ otteniamo che anche  $\phi(c_{\restriction i},{\gr x})\in p$ e di qui $\phi(c_{\restriction i},{\gr c_i})$.
L'equivalenza segue per simmetria.
\end{proof}

Per poter semplificare la definizione~\ref{def_prodotto_tipi} abbiamo bisogno del seguente lemma tecnico:

\begin{lemma}\label{lemma_prodotto}
Dati $p(x), q(y)\in S(\U)$, e due insiemi $A_i$, per $i=0,1$ su cui $q(y)$ \`e invariante, fissiamo $\phi(x,y)\in L(A_0\cap A_1)$ e delle tuple $a_i,b_i$ tali che $a_i\models p_{\restriction A_i}$ e $b_i\models q_{\restriction A_i,a_i}$.
Allora $\phi(a_0,b_0)\iff\phi(a_1,b_1)$.
\end{lemma}
\begin{proof}
Supponiamo per cominciare che $A_0=A_1$ e denotiamo questo insieme con $A$.
Assumiamo $\phi(a_0,b_0)$ e quindi, per la completezza di $q$, che $\phi(a_0,y)\in q$. Per la completezza di $p$  abbiamo che $a_0\equiv_Aa_1$. Quindi, per l'invarianza di $q$ otteniamo $\phi(a_1,y)\in q$ e da questo segue $\phi(a_1,b_1)$.

Per concludere, consideriamo il caso $A_0\neq A_1$. Sia $A=A_0\cup A_1$ e fissiamo $a_2\models  p_{\restriction A}$ e $b_2\models q_{\restriction A,a_2}(y)$. Per quanto sopra dimostrato otteniamo $\phi(a_0,b_0)\iff\phi(a_2,b_2)$ ed anche $\phi(a_2,b_2)\iff\phi(a_1,b_1)$.
\end{proof}

Conviene immaginarsi questa operazione di prodotto come il passo induttivo per la costruzione di una sequenza di Morley.

\begin{definition}\label{def_prodotto_tipi}
Dati $p(x),q(y)\in S(\U)$ dove $q(y)$ \`e un tipo invariante, definiamo il prodotto di $p$ e $q$ come il tipo:

%\ceq{\hfill p(x)\otimes q(y)}{=}{\Big\{\phi(x,y)\ :\ \phi(b,c) \textrm{ per qualche } a\models p_{\restriction A},\ b\models q_{\restriction A,a}(y) ed $A$ t\Big\}}

\ceq{\hfill\mbox{\emph{$p(x)\otimes q(y)$}}}{=}{\Big\{\phi(x,y)\ :\ \textrm{esistono } a,b\ \models\ \phi(x,y)\ \wedge\ p_{\restriction A}(x)\ \wedge\ q_{\restriction A,a}(y)\Big\}}

L'insieme $A$ nella definizione \`e uno qualsiasi che contiene i parametri di $\phi(x,y)$ e su cui $q(y)$ \`e invariante. Il lemma~\ref{lemma_prodotto} assicura che la definizione non dipende dal particolare insieme scelto.
\end{definition}

Il lemma~\ref{lemma_prodotto} ha anche la seguente importante conseguenza:

\begin{corollary}\label{cor_otimes_completo}
Se $p(x),q(y)\in S(\U)$ e $q(y)$ \`e invariante, allora $p(x)\otimes q(y)$ \`e un tipo completo.
\end{corollary}

\begin{proof}
Sia $\phi(x,y)\in L(\U)$. Fissiamo un insieme $A$ contenente i parametri di $\phi(x,y)$ e su cui $q(y)$ sia invariante. Fissiamo $a,b$ arbitrari tali che $a\models p_{\restriction A}(x)$ e $b\models q_{\restriction A,a}(y)$. Dal lemma~\ref{lemma_prodotto} otteniamo che $\phi(x,y)\in p(x)\otimes q(y)$ se e solo se $\phi(a,b)$.
\end{proof}


\begin{corollary}
Se $p(x),q(y)\in S(\U)$ sono tipi globali $A$-invarianti, allora anche $p(x)\otimes q(y)$ \`e $A$-invariante.
\end{corollary}

\begin{proof}
Sia $\phi(x,y,z)\in L$, sia $c$ arbitrario tale che  $\phi(x,y,c)\in p(x)\otimes q(y)$, e sia $c'\equiv_Ac$. Fissiamo $a\models p_{\restriction A,c,c'}$. Poich\'e $p$ \`e invariante su $A$, otteniamo $a,c\equiv_Aa,c'$. Ora fissiamo un $b$ arbitrario tale che $b\models q_{\restriction A,c,c',a}$. Per l'invarianza di $q$ su $A$ otteniamo  $a,b,c\equiv_Aa,b,c'$ e quindi $\phi(a,b,c')$. Seque che $\phi(x,y,c)\in p(x)\otimes q(y)$.
\end{proof}

\begin{proposition}
Se $p(x),q(y)\in S(\U)$ sono finitamente soddisfacibili su $A$, allora $p(x)\otimes q(y)$ \`e finitamente soddisfacibile su $A$.
\end{proposition}

\begin{proof}
Sia $\phi(x,y)\in p(x)\otimes q(y)$ arbitraria e fissiamo un $B$ contenente $A$ ed i parametri di $\phi(x,y)$. Quindi esistono $a,b\models\phi(x,y)\,\wedge\,p_{\restriction B}(x)\,\wedge\,q_{\restriction B,a}(y)$. Allora $\phi(a,y)\in q$, e quindi $\phi(a,b')$ per un qualche $b'\in A$. Allora $\phi(x,b')\in p$, e quindi $\phi(a',b')$ per qualche $a'\in A$.
\end{proof}


Dato $p(x)\in S(\U)$ un tipo globale invariante. Sia $\<x_i:i<\omega\>$ una sequenza di tuple di variabili con $|x|=|x_i|$. Definiamo induttivamente

\ceq{\hfill p^{(1)}(x_0)}{=}{p(x_0)}; 

\ceq{\hfill p^{(n+1)}(x_0,\dots,x_n)}{=}{p^{(n)}(x_0,\dots,x_{n-1})\otimes p(x_n)};

\ceq{\hfill p^{(\omega)}(x_i:i<\omega)}{=}{\bigcup_{n<\omega}p^{(n+1)}(x_0,\dots, x_n)}.

La seguente proposizione giustifica la definizione di $p^{(\omega)}$, la dimostrazione \`e immediata.

\begin{proposition}\label{prop_p^omega_Morley}
Sia $p(x)\in S(\U)$ un tipo globale $A$-invariante. Allora le seguenti affermazioni sono equivalenti
\begin{itemize}
\item[1.]$\<c_i:i<\omega\>$ \`e una sequenze di Morley di $p$ su $A$;
\item[2.] $\<c_i:i<\omega\>\models p^{(\omega)}|_A$
\end{itemize}
\end{proposition}

La seguente proposizione torner\`a utile nei prossimi paragrafi, si osservi che  non \`e una conseguenza della proposizione~\ref{prop_p^omega_Morley} perch\'e qui l'invarianza su $A$ non \`e tra le ipotesi.

\begin{proposition}
Sia $p(x)\in S(\U)$ un tipo globale invariante ed $A$ un insieme arbitrario. Allora ogni $\<c_i:i<\omega\>\models p^{(\omega)}|_A$ \`e una sequenza di indiscernibili su $A$.
\end{proposition}


\begin{proof}
\`E sufficiente verificare che se $\<c_i:i<\omega\>\models p^{(\omega)}|_A$ allora $c_{i_0},\dots,c_{i_n}\models p^{(n+1)}|_A$ per ogni $i_0<\dots<i_n<\omega$. 
\end{proof}


%\ceq{\hfill p(x)\otimes q(y)}{=}{\Bigg\{\phi(x,y)\ :\ \parbox{50ex}{$\phi(x,y)\in L(A)\textrm{ per un } A \textrm{ contenente su cui }q(y)\textrm{ \`e invariante e }\\\phi(b,c) \textrm{ per qualche } a\models p_{\restriction A}(x)\textrm{ e }\ b\models q_{\restriction A,a}(y)$}\Bigg\}}
\end{comment}
