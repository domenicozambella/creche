% !TEX root = creche.tex
\documentclass[creche.tex]{subfiles}
\begin{document}
\chapter{Ultraproducts}
\label{ultraprodotti}

\def\medrel#1{\parbox[t]{6ex}{$\displaystyle\hfil #1$}}
\def\ceq#1#2#3{\parbox{25ex}{$\displaystyle #1$}\medrel{#2}$\displaystyle  #3$}

In these notes we use ultraproducts only to prove the compactness theorem. As a syntactic proof of the compactness theorem is also given, this chapter is, strictly peaking, not required. However the importance of ultraproducts transcends its application to model theory.


\section{Filters and ultrafilters}\label{ultrafiltri}

The matter in this section will be reconsidered in a more general setting in Chapter~\ref{types}.

Let $I$ be any set. A \emph{filter on $I$\/} (or a \emph{filter of $\P(I)$}), is a non empty set $F\subseteq \P(I)$ such that for evry $a, b\in \P(I)$:

\ceq{\ssf{f1}\hfill a\in F\ \ \textrm{and}\ \ a\subseteq b}{\IMP}{b\in F}

\ceq{\ssf{f2}\hfill a\in F\ \ \textrm{and}\ \ b\in F}{\IMP}{a\cap b\in F}

A filter $F$ is \emph{proper\/} if $F\neq\P(I)$, equivalently if $\0\notin F$. Otherwise it is \emph{improper}. By \ssf{f1} above, $F$ is proper if and only if $\0\notin F$. A filter $F$ is \emph{principal\/} if $F=\{a\subseteq I\; :\; b\subseteq a\}$ for some set $b\subseteq I$. We say that $\{b\}$ \emph{generates\/} $F$. When $I$ is finite every filter $F$ is principal generated by $\{\cap F\}$. Non principal filters on $I$ exist as soon as $I$ is infinite. In fact, if $I$ is infinite it is easy to check that the following is filter

\ceq{\hfill F}{=}{\Big\{a\subseteq I\ :\ a \ \mathrm{\ is\ cofinite\ in\ }\ I\Big\}}

where \emph{cofinite (in $I$)} means that $I\sm a$ is finite. This is called the \emph{Fr\'echet's filter on $I$}. Fr\'echet's filter is the minimal non principal filter.

\begin{exercise}
Let $I$ be infinite. Prove that  Fr\'echet's filter on $I$ contains all non principal filters on $I$.\QED
\end{exercise}

A proper filter $F$ is \emph{maximal\/} if there is no proper filter $H$ such that $F\subset H$. A proper filter $F$ is an \emph{ultrafilter\/} if for every $a\subseteq I$:

\ceq{\hfill a\notin F}{\IMP}{\neg a\in F}\hfill where \emph{$\neg a$}$\ \ \deq\ \ I\sm a$

Below we prove that ultrafilters are exactly the maximal filters.

Let $B\subseteq\P(I)$ the \emph{filter generated by $B$\/} is the intersection of all filters containing $B$. It is easy to check that the intersection of a family of filters is a filter, so the notion is well defined. The following easy proposition gives a workable characterization of the filter generated by a set.

\begin{proposition} The filter generated by $B$ is $\big\{a\subseteq I\ :\ \bigcap C\subseteq a\ \textrm{ for some finite }\ C\subseteq B\big\}$.\QED

\end{proposition}

We say that $B$ has the \emph{finite intersection property\/} if $\bigcap C\neq\emptyset$ for every finite $C\subseteq B$. The following proposition is immediate.

\begin{proposition} The following are equivalent
\begin{itemize}
\item[1.] the filter generated by $B$ is non principal;
\item[2.] $B$ has the finite intersection property.\QED
\end{itemize}
\end{proposition}




A proper filter $F$ is \emph{prime\/} if for every $a,b\subseteq I$.

\ceq{\hfill a\cup b\in F}{\IMP}{a\in F\ \ \textrm{ or }\ \ b\in F}

Prime filters coincide with maximal filter. (However, in Chapter~\ref{types} we introduce more a general context where primeness is distinct from maximality.)

\begin{proposition}
For every filter $F$ on $I$, the following are equivalent:
\begin{itemize}
\item[1.] $F$ is a maximal filter;
\item[2.] $F$ is a prime filter;
\item[3.] $F$ is an ultrafilter.
\end{itemize}
\end{proposition}
\begin{proof}
\ssf{1}$\IMP$\ssf{2}. Suppose $a,b\notin F$, where $F$ is maximal. We claim that $a\cup b\notin F$. By maximality, there is a $c\in F$ such that $a\cap c= b\cap c= \0$. Therefore $(a\cup b)\cap c= \0$. Hence  $a\cup b\notin F$. 

\ssf{2}$\IMP$\ssf{3}. It suffices to note that $I=a\cup \neg a\in F$. 

\ssf{3}$\IMP$\ssf{1}. If $a\notin F$, where $F$ is an ultrafilter, then $\neg a\in F$ and no proper filter contains $F\cup\{a\}$.
\end{proof}

\begin{proposition}\label{esistenzamassimale1}
Let $B\subseteq\P(I)$ have the finite intersection property, then $B$ is contained in a maximal filter.
\end{proposition}

\begin{proof}
First prove that the union of a chain of subsets of $\P(I)$ with the finite intersection property has the finite intersection property. Let $\B$ be such a chain and suppose for a contradiction that $\bigcup\B$ does not have the finite intersection property. Fix a finite $C\subseteq\bigcap\B$ such that $\bigcap  C=\0$. As $C$ is finite, $C\subseteq B$ for some $B\in\B$. Hence $B$ does not have the finite intersection property. A contradiction.


Now apply Zorn lemma to obtain a $B\subseteq\P(I)$ which is maximal among the sets with the finite intersection property. It is immediate that $B$ is a filter.
\end{proof}

\begin{exercise}
Prove that all principal ultrafilters are generated by a singleton.\QED
\end{exercise}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Direct products}
\label{prodottidiretti}

In this and the next section $\<M_i:i\in I\>$ is a sequence of $L$-structures. (We are abusing of the word sequence, $I$ is only a set.) The \emph{direct product\/} of this sequence is a structure denoted by

\ceq{}{}{\emph{$\displaystyle\ \prod^{}_{i\in I}M_i$}}\hfill below this is abbreviated by  \emph{$N$\/}\bigskip

and is defined by conditions \ssf{1}-\ssf{3} below. If $M_i=M$ for all $i\in I$ we say that $N$ is a \emph{direct power\/} of $M$ and denote it by \emph{$M^I$}.

The domain of $N$ is the set containing all functions

\ceq{\ssf{1.}\hfill \hat a}{:}{I\ \to\ \bigcup_{i\in I}M_i}\smallskip

\ceq{\hfill \hat a}{:}{i\ \ \mapsto\ \ \hat ai\ \in\ M_i}

We confuse tuples of elements of $N$ with tuple-valued functions, for instance, the tuple $\hat a=\<\hat a_1\dots\hat a_n\>$ is confused with the function $\hat a:i\mapsto\hat ai=\<\hat a_1i,\dots,\hat a_ni\>$. But at a first reading it might be convenient to pretend that all functions and relations are unary.

The interpretation of $f\in L_{\rm fun}$ is defined as follows

\ceq{\ssf{2.}\hfill\big(f^N\hat a\big)i}{=}{f^{M_i}(\hat ai)}\hfill  for all $i\in I$,

The interpretation of $r\in L_{\rm fun}$ is the product of the relations $r^{M_i}$, that is, we define

\ceq{\ssf{3.}\hfill\hat a\in r^N}{\IFF}{\hat ai\in r^{M_i}}\hfill  for all $i\in I$.


The following proposition is immediate.

\begin{proposition}\label{proposizioneprodottidiretti}
If only the connectives $\wedge$, $\A$ and $\E$ occur in $\phi(x)\in L$ then for every $\hat a\in N^{|x|}$

\ceq{\sharp\hfill N\models \phi(\hat a)}
{\IFF}
{M_i\models\phi(\hat a i)}\hfill for all $i\in I$.

\end{proposition}

\begin{proof}
By induction on syntax. First note that we can extend \ssf{2} to all terms $t(x)$

\ceq{\ssf{2'.}\hfill\big(t^N\hat a\big)i}{=}{t^{M_i}(\hat ai)}\hfill  for all $i\in I$. 

Combining \ssf{3} and \ssf{2'} we obtain that for every $r\in L_{\rm rel}\cup\{=\}$ and every $L$-term $t(x)$

\ceq{\ssf{3'.}\hfill N\models rt\hat a}{\IFF}{M_i\models rt\hat a i}\hfill  for all $i\in I$

This shows that $\,\sharp\,$ holds for $\phi(x)$ atomic. Induction for the connectives $\wedge$, $\A$ ed $\E$ is immediate.
\end{proof}

A consequence of Proposition~\ref{proposizioneprodottidiretti} is that the direct product of groups, rings and vector spaces are structures of the same sort. Notably, the product of fields is not a field.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{\L o\'{s}'s Theorem}
Assume the notation of the previous sections. In particular, $\<M_i:i\in I\>$ is a sequence of structures and $N$ is the direct product of this sequence. 

Let $F$ be a filter on $I$. We define the following congruence relation on $N$

\ceq{\hfill \hat a\sim_F\hat c}{\IFF}{\big\{\, i\in I\ :\ \hat ai=\hat ci\,\big\}\in F\,.}

It is easy to verify that $\sim_F$ is indeed an equivalence relation: reflexivity and symmetry are evident, transitivity follows from \ssf{f2} in Section~\ref{ultrafiltri}. It is also clear that $\sim_F$ satisfies \ssf{c1} of Section~\hyperref[quotient]{\ref*{teorie}.\ref*{quotient}}. Hence it is a congruence. 

For brevity, we write $N/F$ for $N/{\sim}_F$ and $[\hat a]_F$ for $[\hat a]_{\sim_F}$. Then \ssf{c3} of in Section~\hyperref[quotient]{\ref*{teorie}.\ref*{quotient}} we obtain

\ceq{\ssf{c3'.}\hfill [\hat a]_F\ \in\ r^{N/F}}{\IFF}{\big\{\,i\; :\; \ \hat ai=\hat bi\in r^{M_i}\,\big\}\,\in\, F}\quad for some $\hat b\in N$.

\smallskip
The structure $N/F$ is called the \emph{reduced product\/} of the structures $\<M_i:i\in I\>$ or, when $M_i=M$ for all $i\in I$, the \emph{reduced power\/} of $M$. When $F$ is an ultrafilter we say \emph{ultraproduct}, respectively \emph{ultrapower}.

\begin{void_thm}[\L o\'{s} Theorem]\label{thm_los}
Let $\phi(x)\in L$ and let $F$ be an ultrafilter on $I$. Then for every $\hat a\in N^{|x|}$, the following are equivalent
\begin{itemize}
\item[1.] $N/F\ \pmodels\ \phi(\hat a)$,\hfill see  Definition~\ref{def_pseudostructure};
\item[2.] $\big\{\,i\ :\ M_i\models \phi(\hat a i)\,\big\}\ \in\ F$.
\end{itemize}
\end{void_thm}

\begin{proof}
We proceed by induction of the syntax of $\phi(x)$. Suppose $\phi(x)$ is of the form $rt(x)$ for some tuple of terms $t(x)$ and $r\in L_{\rm rel}\cup\{=\}$. Then \ssf{1}$\IFF$\ssf{2} is clear.

We prove the inductive step for the connectives $\neg$, $\wedge$, and $\E$. We begin with $\neg$. This is the only place in the proof where the assumption that $F$ is an \textit{ultra\kern.2ex}filter is required. From the inductive hypothesis we obtain

\ceq{\hfill N/F\ \pmodels\ \neg\phi\big(\hat a\big)}%
{\IFF}%
{\big\{i\ :\ M_i\; \models\; \phi(\hat a i)\;\big\}\ \notin\ F}

So, as $F$ is an \textit{ultra\kern.2ex}filter

\ceq{}{\IFF}%
{\big\{i\ :\ M_i\; \models\; \neg\phi(\hat a i)\;\big\}\ \in\ F\,.}

Now consider $\wedge$. Assume as inductive hypothesis that the equivalence \ssf{1}$\IFF$\ssf{2} holds for $\phi(x)$ and $\psi(x)$, then

\ceq{\hfill N/F\ \pmodels\ \phi\big(\hat a\big)\wedge\psi\big(\hat a\big)}%
{\IFF}%
{\big\{i\,:\, M_i\models\phi(\hat a i)\big\}\,\in\, F\ \ {\rm and}\ \ \big\{i\, :\, M_i\models\psi(\hat a i)\big\}\, \in\, F}

As filters are closed under intersection we obtain

\ceq{}{\IFF}{\big\{i\ :\ M_i\; \models\; \phi(\hat a i)\wedge\psi(\hat a i)\;\big\}\ \in\ F\,.}

Finally consider $\E y$.  Assume as inductive hypothesis that the equivalence \ssf{1}$\IFF$\ssf{2} holds for $\phi(x,y)$, then

\ceq{\hfill N/F\ \pmodels\ \E y\,\phi\big(\hat a,y\big)}%
{\IFF}%
{N/F\ \pmodels\  \phi\big(\hat a,\hat b\big)}\hfill for some $\hat b\in N$\phantom{.}

\ceq{}{\IFF}%
{\big\{i\ :\ M_i\; \models\; \phi(\hat a i,\hat b i)\;\big\}\ \in\ F}\hfill for some $\hat b\in N$.

We claim this is equivalent to

\ceq{}{\IFF}%
{\big\{i\ :\ M_i\; \models\; \E y\,\phi(\hat a i,y)\;\big\}\ \in\ F.}

In fact, direction $\IMP$ is trivial and, as for $\PMI$, we choose as $\hat b$ a sequence that picks a witness of $M_i\models\E y\,\phi(\hat a i,y)$ if it exists, some arbitrary element of $M_i$ otherwise.
\end{proof}

Let \emph{$a^I$\/} denote the element of $M^I$ that has constant value $a$. The following is an immediate consequence of \L o\'{s} theorem.

\begin{corollary}\label{ultrapotenzeelementari}
For every $a\in M$

\ceq{\hfill M^I/F\ \pmodels\ \phi(a^I)}%
{\IFF}%
{M\ \models\ \phi(a)\,.}\QED
\end{corollary}


Often one identifies $M$ with its image under the map $h:a\mapsto [a^I]_F$ and say that $M^I/F$ is an elementary extension of $M$.

The following is an immediate consequence of the compactness theorem that we prove in the next chapter. Below a construction that uses ultrapowers.

\begin{corollary}
Every infinite structure has a proper elementary extension.
\end{corollary}

\begin{proof}
Let $M$ be an infinite structure and let $F$ be an \textit{non principal\/} ultrafilter on $\omega$. By the above remark, it suffices to show that $h[M]$ is a \textit{proper\/} substructure of $M^\omega/F$.  As $M$ is infinite, there is an injective function  $\hat d\in M^\omega$. Then for every $a\in M$ the set $\big\{i:\hat di=a\big\}$ is either empty or a singleton and, as $F$ is non principal, it does not belong to $F$. So, by \L o\v{s} Theorem $M^\omega/F\ \pmodels\ \hat d\neq a^I$ for every $a\in M$, that is, $[\hat d]_F\notin h[M]$.
\end{proof}

\end{document}
