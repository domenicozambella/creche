% !TEX root = creche.tex
\documentclass[creche.tex]{subfiles}
\begin{document}
\chapter{Ultraproducts}
\label{ultraprodotti}

\def\medrel#1{\parbox[t]{6ex}{$\displaystyle\hfil #1$}}
\def\ceq#1#2#3{\parbox[b]{25ex}{$\displaystyle #1$}\medrel{#2}$\displaystyle  #3$}

In these notes we only use ultraproducts to prove the compactness theorem. Since a syntactic proof of the compactness theorem is also given, this chapter is, strictly speaking, not required. However, the importance of ultraproducts transcends its application to model theory.


\section{Filters and ultrafilters}\label{ultrafiltri}

The material in this section will appear again in a more general setting in Chapter~\ref{types}.

Let $I$ be any set. A \emph{filter on $I$\/} (or a \emph{filter of $\P(I)$}), is a non empty set $F\subseteq \P(I)$ such that for every $a, b\in \P(I)$:

\ceq{\ssf{f1}\hfill a\in F\ \ \textrm{and}\ \ a\subseteq b}{\IMP}{b\in F}

\ceq{\ssf{f2}\hfill a\in F\ \ \textrm{and}\ \ b\in F}{\IMP}{a\cap b\in F}

A filter $F$ is \emph{proper\/} if $F\neq\P(I)$, equivalently if $\0\notin F$. Otherwise it is \emph{improper}. By \ssf{f1} above, $F$ is proper if and only if $\0\notin F$. A filter $F$ is \emph{principal\/} if $F=\{a\subseteq I\; :\; b\subseteq a\}$ for some set $b\subseteq I$. When this happens, we say that $\{b\}$ \emph{generates\/} $F$. When $I$ is finite every filter $F$ is principal and generated by $\{\cap F\}$. Non-principal filters on $I$ exist as soon as $I$ is infinite. In fact, if $I$ is infinite it is easy to check that the following is a filter:

\ceq{\hfill F}{=}{\Big\{a\subseteq I\ :\ a \ \mathrm{\ is\ cofinite\ in\ }\ I\Big\}\, .}

where \emph{cofinite (in $I$)} means that $I\sm a$ is finite. This is called the \emph{Fr\'echet filter on $I$}. The Fr\'echet filter is the minimal non-principal filter.

A proper filter $F$ is \emph{maximal\/} if there is no proper filter $H$ such that $F\subset H$. A proper filter $F$ is an \emph{ultrafilter\/} if for every $a\subseteq I$

\ceq{\hfill a\notin F}{\IMP}{\neg a\in F}\, \hfill where \emph{$\neg a$}$\ \ =\ \ I\sm a\, .$

Below we prove that the ultrafilters are exactly the maximal filters.

\begin{exercise}
Let $I$ be infinite. Prove that every non-principal ultrafilter on $I$ contains Fr\'echet's filter. Show that this does not hold for plain filters. \QED
\end{exercise}

Let $B\subseteq\P(I)$. Then the \emph{filter generated by $B$\/} is the intersection of all the filters that contain $B$. It is easy to check that the intersection of a family of filters is a filter, so the notion is well defined. The following easy proposition gives a workable characterization of the filter generated by a set.

\begin{proposition} The filter generated by $B$ is $\big\{a\subseteq I\ :\ \bigcap C\subseteq a\ \textrm{ for some finite }\ C\subseteq B\big\}$.\QED

\end{proposition}

We say that $B$ has the \emph{finite intersection property\/} if $\bigcap C\neq\emptyset$ for every finite $C\subseteq B$. The following proposition is immediate.

\begin{proposition} The following are equivalent:
\begin{itemize}
\item[1.] the filter generated by $B$ is non principal;
\item[2.] $B$ has the finite intersection property.\QED
\end{itemize}
\end{proposition}

A proper filter $F$ is \emph{prime\/} if for every $a,b\subseteq I$.

\ceq{\hfill a\cup b\in F}{\IMP}{a\in F\ \ \textrm{ or }\ \ b\in F}

Prime filters coincide with maximal filters. However, in Chapter~\ref{types}, we introduce a more general context where primality is distinct from maximality.

\begin{proposition}
For every filter $F$ on $I$, the following are equivalent:
\begin{itemize}
\item[1.] $F$ is a maximal filter;
\item[2.] $F$ is a prime filter;
\item[3.] $F$ is an ultrafilter.
\end{itemize}
\end{proposition}
\begin{proof}
\ssf{1}$\IMP$\ssf{2}. Suppose $a,b\notin F$, where $F$ is maximal. We claim that $a\cup b\notin F$. By maximality, there is a $c\in F$ such that $a\cap c= b\cap c= \0$. Therefore $(a\cup b)\cap c= \0$. Hence  $a\cup b\notin F$. 

\ssf{2}$\IMP$\ssf{3}. It suffices to note that $I=a\cup \neg a\in F$. 

\ssf{3}$\IMP$\ssf{1}. If $a\notin F$, where $F$ is an ultrafilter, then $\neg a\in F$ and no proper filter contains $F\cup\{a\}$.
\end{proof}

\begin{proposition}\label{esistenzamassimale1}
Let $B\subseteq\P(I)$ have the finite intersection property. Then $B$ is contained in a maximal filter.
\end{proposition}

\begin{proof}
First we prove that the union of a chain of subsets of $\P(I)$ with the finite intersection property has the finite intersection property. Let $\B$ be such a chain and suppose for a contradiction that $\bigcup\B$ does not have the finite intersection property. Fix a finite $C\subseteq\bigcap\B$ such that $\bigcap  C=\0$. As $C$ is finite, we have $C\subseteq B$ for some $B\in\B$. Hence $B$ does not have the finite intersection property, which is a contradiction.


Now apply Zorn's lemma to obtain a $B\subseteq\P(I)$ which is maximal among the sets with the finite intersection property. It is immediate that $B$ is a filter.
\end{proof}

\begin{exercise}
Prove that all principal ultrafilters are generated by a singleton.\QED
\end{exercise}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Direct products}
\label{prodottidiretti}

In this and in the next section $\<M_i:i\in I\>$ is a sequence of $L$-structures. (We are abusing of the word sequence, since $I$ is only a set.) The \emph{direct product\/} of this sequence is a structure denoted by

\ceq{}{}{\emph{$\displaystyle\ \prod^{}_{i\in I}M_i$}}\hfill (below this product is denoted by  \emph{$N$\/}).\bigskip

and defined by conditions \ssf{1}-\ssf{3} below. If $M_i=M$ for all $i\in I$, we say that $N$ is a \emph{direct power\/} of $M$ and denote it by \emph{$M^I$}.

The domain of $N$ is the set containing all functions

\ceq{\ssf{1.}\hfill \hat a}{:}{I\ \to\ \bigcup_{i\in I}M_i}\smallskip

\ceq{\hfill \hat a}{:}{i\ \ \mapsto\ \ \hat ai\ \in\ M_i}

We do not distinguish between tuples of elements of $N$ and tuple-valued functions. For instance, the tuple $\hat a=\<\hat a_1\dots\hat a_n\>$ is identified with the function $\hat a:i\mapsto\hat ai=\<\hat a_1i,\dots,\hat a_ni\>$. On a first reading of what follows, it may help to pretend that all functions and relations are unary.

The interpretation of $f\in L_{\rm fun}$ is defined as follows:

\ceq{\ssf{2.}\hfill\big(f^N\hat a\big)i}{=}{f^{M_i}(\hat ai)}\hfill  for all $i\in I$.

The interpretation of $r\in L_{\rm rel}$ is the product of the relations $r^{M_i}$, that is, we define

\ceq{\ssf{3.}\hfill\hat a\in r^N}{\IFF}{\hat ai\in r^{M_i}}\hfill  for all $i\in I$.


The following proposition is immediate.

\begin{proposition}\label{proposizioneprodottidiretti}
If $=, \wedge, \A$, $\E$ are the only logical symbol that occur in $\phi(x)\in L$, then for every $\hat a\in N^{|x|}$

\ceq{\sharp\hfill N\models \phi(\hat a)}
{\IFF}
{M_i\models\phi(\hat a i)}\hfill for all $i\in I$.

\end{proposition}

\begin{proof}
By induction on syntax. First note that we can extend \ssf{2} to all terms $t(x)$ as follows:

\ceq{\ssf{2$^\prime$.}\hfill\big(t^N\hat a\big)i}{=}{t^{M_i}(\hat ai)}\hfill  for all $i\in I$. 

Combining \ssf{3} and \ssf{2$^\prime$} gives that for every $r\in L_{\rm rel}\cup\{=\}$ and every $L$-term $t(x)$

\ceq{\hfill N\models rt\hat a}{\IFF}{M_i\models rt\hat a i}\hfill  for all $i\in I$.

This shows that $\,\sharp\,$ holds for $\phi(x)$ atomic. Induction for the connectives $\wedge$, $\A$ ed $\E$ is immediate.
\end{proof}

A consequence of Proposition~\ref{proposizioneprodottidiretti} is that a direct product of groups, rings or vector spaces is a structure of the same sort. However, a product of fields is not a field.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{\L o\'{s}'s Theorem}
Let $\<M_i:i\in I\>$ be a sequence of structures.
In this section by $N$ we denote the following structure.
The domain and the interpretation of the function symbols is as in \ssf{1}, respectively \ssf{2}, of the previous section
As interpretation of $r\in L_{\rm rel}$ we take

\ceq{\ssf{3$'$.}\hfill\hat a\in r^{N}}{\IFF}{\big\{\, i\in I\ :\ \hat a i\in r^{M_i}\,\big\}\in F\,.}

Let $F$ be a filter on $I$. We define the following congruence on $N$ (see Definition~\ref{def_congruence}):

\ceq{\hfill\emph{$\hat a\sim_F\hat c$}}{\IFF}{\big\{\, i\in I\ :\ \hat ai=\hat ci\,\big\}\in F\,.}

%It is easy to verify that $\sim_F$ is indeed an equivalence relation: reflexivity 
To check that $\sim_F$ is indeed a congruence, first we need to check that it is an equivalence relation. Reflexivity and symmetry are immediate, and transitivity follows from \ssf{f2} in Section~\ref{ultrafiltri}. Then we check that $\sim_F$ is compatible with the functions of $L$, that is, that \ssf{c1} of Definition~\ref{def_congruence} is satisfied. This follows from~\ssf{f1} in Section~\ref{ultrafiltri}.

For brevity, we write $N/F$ for $N/{\sim}_F$ and $[\hat a]_F$ for $[\hat a]_{\sim_F}$.
We write $N/F\pmodels\phi(\hat a)$ for $N/F\models\phi([\hat a]_F)$.
A more formal interpretation of $\,\pmodels\,$ is given in Definition~\ref{def_pseudostructure}.


The structure $N/F$ is called the \emph{reduced product\/} of the structures $\<M_i:i\in I\>$ or, when $M_i=M$ for all $i\in I$, the \emph{reduced power\/} of $M$. When $F$ is an ultrafilter we say \emph{ultraproduct}, respectively \emph{ultrapower}.

\begin{exercise}
  Let $N'$ be defined as $N$ in the previous section.
  Prove that if $M_i=M$ for all $i\in I$ then $N'/F=N/F$. 
  More generally, prove that if for every $r\in L_{\rm rel}$, either $r^{M_i}\neq\0$ for all $i$ or $r^{M_i}=\0$ for all $i$ then $N'/F=N/F$.\QED
\end{exercise}

The following proposition is almost tautological.
Note that it is a special case of \L o\v{s}'s Theorem below (but it is does not require $F$ to be an \textit{ultra\kern.2ex}filter).

\begin{proposition}\label{prop_eq_ultra}
  Let $r\in L_{\rm rel}$.
  Let $t(x)$ be tuple of terms of length $n_r$, the arity of $r$.
  Then for every $\hat a\in N^{|x|}$ and every filter $F$ the following are equivalent
  \begin{itemize}
  \item[1.] $N/F\,\pmodels r\,t(\hat a)$;

  \item[2.] $\big\{i\; :\ M_i\,\models r\,t(\hat ai)\,\big\}\,\in\, F$.
  \end{itemize}
\end{proposition}

\begin{proof}
  \ssf{1}$\IMP$\ssf{2} 
  Assume \ssf{1}.
  Then, by \ssf{2*} of Definition~\ref{def_pseudostructure}, there is a $\hat b\sim t^N(\hat a)$ such that $N\models r\,\hat b$.
  Therefore $\{i:M_i\models r\,\hat bi\}$ is in $F$.
  But $\hat b\sim t(\hat a)$ means that $\big\{i\, :\, \hat bi= t(\hat ai)\big\}$ is in $F$, hence \ssf{2} follows.

  \ssf{2}$\IMP$\ssf{1} Is clear.
\end{proof}

\begin{void_thm}[\L o\'{s}'s Theorem]\label{thm_los}
Let $\phi(x)\in L$ and let $F$ be an ultrafilter on $I$. Then for every $\hat a\in N^{|x|}$ the following are equivalent:
\begin{itemize}
\item[1.] $N/F\ \pmodels\ \phi(\hat a)$\hfill (see  Definition~\ref{def_pseudostructure});
\item[2.] $\big\{\,i\ :\ M_i\models \phi(\hat a i)\,\big\}\ \in\ F$.
\end{itemize}
\end{void_thm}

\begin{proof}
We proceed by induction on the syntax of $\phi(x)$. 
If $\phi(x)$ is equality, then equivalence holds by definition of $\sim$. 
If $\phi(x)$ is of the form $r\,t(x)$ for some tuple of terms $t(x)$ and $r\in L_{\rm rel}$ then \ssf{1}$\IFF$\ssf{2} is Proposition~\ref{prop_eq_ultra}.

We prove the inductive step for the connectives $\neg$, $\wedge$, and the quantifier $\E$. We begin with $\neg$. This is the only place in the proof where the assumption that $F$ is an \textit{ultra\kern.2ex}filter is required. By the inductive hypothesis,

\ceq{\hfill N/F\ \pmodels\ \neg\phi\big(\hat a\big)}%
{\IFF}%
{\big\{i\ :\ M_i\; \models\; \phi(\hat a i)\;\big\}\ \notin\ F}

So, as $F$ is an \textit{ultra\kern.2ex}filter

\ceq{}{\IFF}%
{\big\{i\ :\ M_i\; \models\; \neg\phi(\hat a i)\;\big\}\ \in\ F\,.}

Now consider $\wedge$. Assume inductively that the equivalence \ssf{1}$\IFF$\ssf{2} holds for $\phi(x)$ and $\psi(x)$. Then

\ceq{\hfill N/F\ \pmodels\ \phi\big(\hat a\big)\wedge\psi\big(\hat a\big)}%
{\IFF}%
{\big\{i\,:\, M_i\models\phi(\hat a i)\big\}\,\in\, F\ \ {\rm and}\ \ \big\{i\, :\, M_i\models\psi(\hat a i)\big\}\, \in\, F\,.}

As filters are closed under intersection, we obtain

\ceq{}{\IFF}{\big\{i\ :\ M_i\; \models\; \phi(\hat a i)\wedge\psi(\hat a i)\;\big\}\ \in\ F\,.}

Finally, consider $\E y$.  Assume inductively that the equivalence \ssf{1}$\IFF$\ssf{2} holds for $\phi(x,y)$. Then

\ceq{\hfill N/F\ \pmodels\ \E y\,\phi\big(\hat a,y\big)}%
{\IFF}%
{N/F\ \pmodels\  \phi\big(\hat a,\hat b\big)}\hfill for some $\hat b\in N$\phantom{.}

\ceq{}{\IFF}%
{\big\{i\ :\ M_i\; \models\; \phi(\hat a i,\hat b i)\;\big\}\ \in\ F}\hfill for some $\hat b\in N$.

We claim this is equivalent to

\ceq{}{\IFF}%
{\big\{i\ :\ M_i\; \models\; \E y\,\phi(\hat a i,y)\;\big\}\ \in\ F.}

The $\IMP$ direction is trivial. For $\PMI$, we choose as $\hat b$ a sequence that picks a witness of $M_i\models\E y\,\phi(\hat a i,y)$ if it exists, and some arbitrary element of $M_i$ otherwise.
\end{proof}

Let \emph{$a^I$\/} denote the element of $M^I$ that has constant value $a$. The following is an immediate consequence of \L o\'{s}'s theorem.

\begin{corollary}\label{ultrapotenzeelementari}
Let $N=M^I$. For every $a\in M$

\ceq{\hfill N/F\ \pmodels\ \phi(a^I)}%
{\IFF}%
{M\ \models\ \phi(a)\,.}\QED
\end{corollary}

We often identify $M$ with its image under the embedding $h:a\mapsto [a^I]_F$, and say that $M^I/F$ is an elementary extension of $M$.

The following corollary is an immediate consequence of the compactness theorem that we prove in the next chapter but here we give a direct proof.

\begin{corollary}
Every infinite structure has a proper elementary extension.
\end{corollary}

\begin{proof}
Let $M$ be an infinite structure and let $F$ be a \textit{non-principal\/} ultrafilter on $\omega$.
It suffices to show that $h[M]$, the image of the embedding defined above, is a \textit{proper\/} substructure of $M^\omega\!/F$. 
As $M$ is infinite, there is an injective function  $\hat d\in M^\omega$.
Then for every $a\in M$ the set $\big\{i:\hat d\,i=a\big\}$ is either empty or a singleton and, as $F$ is non principal, it does not belong to $F$.
So, by \L o\v{s} Theorem, we have $M^\omega\!/F\ \pmodels\ \hat d\neq a^I$ for every $a\in M$, that is, $[\hat d\,]_F\notin h[M]$.
\end{proof}

\begin{exercise}
Consider $\NN$ as a structure in the language of strict orders. 
Let $F$ be a non-principal ultrafilter on $\omega$.
Prove that in $\NN^\omega$ there is a sequence $\<\hat a_i: i\in\omega\>$ such that $\NN^\omega\!/F\,\pmodels\,\hat a_{i+1}<\hat a_i$.\QED 
\end{exercise}

\begin{exercise}
Let $I$ be the set of integers $i>1$. For $i\in I$, let $\ZZ_i$ denote the additive group of integers modulo $i$, and let $N$ denote the product \smash{$\displaystyle\prod_{i\in I}\ZZ_i$}. Prove that, if $F$ is a non-principal ultrafilter on $I$,

\begin{itemize}
\item[1.] for some $F$, $N/F$ does not contain any element of finite order;
\item[2.] for some $F$, $N/F$ has some elements of order $2$;
\item[3.] for all $F$, $N/F$ contains an element of infinite order;
\item[4.] for some $F$, $N/F\models \A x\,\E y\ my=x$ for every integer $m>0$;
\item[5.] for some $F$, $N/F$ contains an element $\hat a$ such that $N/F\models \A x\ mx\neq\hat a$ for every positive integer $m$.\QED
\end{itemize}
\begin{comment}
\textbf{Soluzione.} Dimostriamo \ssf{1} osservando che $\ZZ_i\models\neg\E x\,[x\neq 0 \wedge mx=0]$  per ogni intero $m$ ed ogni primo $i\nmid m$. Quindi, se $F$ \`e un un ultrafiltro non principale che contiene l'insieme dei numeri primi, $N/F\models\neg\E x\,[x\neq 0 \wedge mx=0]$ per ogni $m$. Per dimostrare \ssf{2} osserviamo che $\ZZ_{2i}\models\E x\,[x\neq 0 \wedge 2x=0]$ per ogni $i$. Quindi se $F$ contiene l'insieme dei numeri pari, $N/F$ contiene un elemento di ordine 2. Per dimostrare \ssf{3} sia $\hat a\in N$ la sequenza che ha valore costante $1$. Chiaramente $\ZZ_i\models m\neq0$ per ogni intero positivo $m$ ed ogni $i>m$. Quindi, se $F$ contiene il filtro di Fr\'echet, $N/F\models m [\hat a]_F\neq 0$ per ogni intero positivo $m$. Dimostriamo \ssf{4} osservando che  $\ZZ_i\models\A x\,\E y\ my=x$ per ogni intero $m$ ed ogni primo $i\nmid m$. Quindi se $F$ \`e un ultrafiltro non principale che contiene l'insieme dei numeri primi,  $N/F\models\A x\,\E y\ my=x$ per ogni $m$. Dimostriamo \ssf{5}. Sia $F$ un ultrafiltro non principale che contiene l'insieme $\{i\,!:i\in I\}$ e sia $\hat a$ la sequenza che ha valore costante $1$. Poich\'e $\ZZ_{i\,!}\models\neg\E x\ mx=1$ per ogni $i>m$, otteniamo $N/F\models\neg\E x\ mx=[\hat a]_F$ per ogni $m>1$.
\end{comment}
\end{exercise}

\end{document}
