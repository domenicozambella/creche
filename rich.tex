% !TEX root = creche.tex
\documentclass[creche.tex]{subfiles}
\begin{document}

\chapter{Fra\"iss√© limits}
\label{fraisse} 

\def\ceq#1#2#3{\parbox[b]{20ex}{$\displaystyle #1$}\parbox[b]{4ex}{\hfil$#2$}$\displaystyle #3$}

We introduce \textit{Fra\"iss\'e limits}, aleas \textit{homogeneous-universal\/} or \textit{generic\/} structures, which here we call \textit{rich\/} models, after Poizat.
Rich models generalize the examples in Chapters~\ref{relational} and the many more to come.

\textit{Elimination of quantifiers} is briefly discussed at the end of Section~\ref{rich}.
For the time being we identify  quantifier elimination with the property that says that all partial isomorphisms are elementary maps.
Proofs are easier with this notion in mind.
The equivalence with its syntactic counterpart is only proved in Chapter~\ref{elimination}, when the reader is more familiar with arguments of compactness.

\section{Rich models.}\label{rich}
We now define \textit{categories of models and partial morphisms}.
These are example of concrete categories as intended in category theory.
However, apart from the name, in what follows we dispense with all notions of category theory as they would make the exposition less basic than intended (without providing more technical instruments).
%We refer the interested reader to the references at the end of the chapter.

\noindent\llap{\textcolor{red}{\Large\danger}\kern1.5ex}Warning: the terminology introduced in this section is not standard.
In the literature many details are left implicit.
This is generally safe when the category used is fixed.
Here we prefer to be more explicit because, when discussing saturation, quantifier elimination, and model completeness, it helps to compare different categories.

A \emph{category (of models and partial morphisms)\/} is a class $\M$ which is disjoint union of two classes: \emph{$\M_{\textrm{ob}}$} and \emph{$\M_{\textrm{hom}}$}.
The first is the class of \emph{objects\/} and contains structures with a common signature $L$ which we call \emph{models}.
The second is the class of \emph{morphisms\/} and contains (partial) maps between models.
We require that the identity maps are morphisms and that composition of two morphism is again morphism.
This makes $\M$ a well-defined category.

For example, $\M$ could consist of all models of some theory $T_0$ and of all partial isomorphisms between these.
Alternatively, as morphisms we could take elementary maps between models.
At a first reading the reader may assume $\M$ is as in one of these two examples.
In the general case we need to make some assumptions on $\M$.

\begin{definition}\label{def_com_c}For ease of reference we list together all properties required below
\begin{itemize} 
\item[c1.] the (partial) identity map $\id_A:M\to M$ is a morphism, for any $A\subseteq M$;
\item[c2.] if $k':M\to N$ is a morphism for every finite $k'\subseteq k$, then $k:M\to N$ is a morphism.
\item[c3.] morphisms are invertible maps and the inverse of a morphism is a morphism;
\item[c4.] morphisms preserve the truth of $\atL$\,-formulas;
\item[c5.] if $M$ is a model and $N\equiv M$, then also $N$ is a model;
\item[c6.] every elementary map between models a is morphism.\QED
\end{itemize}
\end{definition}

The \emph{connected component\/} of a model $M$ is the subclass of models $N$ such that there is any morphism with domain $M$ and codomain $N$ (or vice versa, by \ssf{c3}).
By axiom \ssf{c1} the restriction of a morphism is a morphism, therefore $M$ and $N$ are in the same connected component if and only if the empty map $\0:M\to N$ is a morphism.
If the whole category $\M$ consists of one connected component we say that $\M$ is \emph{connected}.

We call \ssf{c2} the \emph{finite character of morphisms}.
Note that it implies the following

\begin{itemize} 
\item[c7.] if $k_i:M\to N$ is a chain of morphisms, then $\displaystyle\bigcup_{i<\lambda} k_i:M\to N$ is a morphism.
\end{itemize}

Notably, the following two definitions require \ssf{c3}.
The generalization to non injective morphisms is not straightforward (in fact, there are two generalizations: \textit{projective\/} and \textit{inductive\/}).
These generalizations are not very common and will not be considered here.

\begin{definition}
Assume that $\M$ satisfies \ssf{c1}-\ssf{c3} of Definition~\ref{def_com_c}.
We say that a model $N$ is \emph{$\lambda\jj$rich\/} if for every model $M$, every ${\mr b}\in M$ and every morphism $k:M\imp N$ of cardinality $<\lambda$ there is a ${\mr c}\in N$ such that $k\cup\{\<{\mr b},{\mr c}\>\}:M\to N$ is a morphism.
We say that $N$ is \emph{rich\/} if it is $\lambda\jj$rich for $\lambda=|N|$.
When $\M_{\rm ob}=\Mod(T_0)$ for some theory $T_0$ and $\M_{\rm hom}$ is clear from the context, we say \emph{rich model of $T_0$}.\QED
\end{definition}

Rich models are also called \textit{Fra\"iss\'e limits} or \textit{homogeneous-universal\/} for a reason that will soon be clear; they are also called \textit{generic}.
Unfortunately these names are either too long or too generic, so we opt for the less common term \textit{rich\/} that was proposed by Poizat.

The following two notions are closely connected with richness.

\begin{definition}\label{def_omogenea_universale}
Assume that $\M$ satisfies \ssf{c1}-\ssf{c3} of Definition~\ref{def_com_c}.
We say that a model $N$ is \emph{$\lambda\jj$universal\/} if for every model $M$ of cardinality $\le\lambda$ in the same connected component of $N$ there is an embedding $k:M\hookrightarrow N$.
We say that a model $N$ is \emph{$\lambda\jj$homogeneous\/} if every $k:N\to N$ of cardinality $<\lambda$ extends to a bijective morphism $h:N\isomap N$ (an automorphism when \ssf{c4} below holds).

Note that the larger $\M_{\rm hom}$, the stronger notion of homogeneity.
When  $\M_{\rm hom}$ contains all partial isomorphisms between models (the largest class of morphisms considered here), it is common to say \emph{$\lambda$-ultra\-homo\-geneous\/} for $\lambda\jj$homogeneous.

As above, when $\lambda=|N|$ we say \emph{universal}, \emph{homogeneous} and \emph{ultrahomogeneous}.\QED
\end{definition}


In Section~\hyperref[dlo]{\ref*{relational}.\ref*{dlo}} we implicitly used $\M_{\rm ob}=\Mod(T_{\rm lo})$ and partial isomorphisms as $\M_{\rm hom}$.
In Section~\hyperref[randomgraph]{\ref*{relational}.\ref*{randomgraph}} we used $\M_{\rm ob}=\Mod(T_{\rm gph})$ and again partial isomorphisms as $\M_{\rm hom}$.
Corollary~\ref{coroll_ordinericco} proves that every model of $T_{\rm dlo}$ is $\omega\jj$rich.
Corollary~\ref{coroll_graforicco} claims the analogous fact for $T_{\rm rg}$.

In the following we frequently work under the following assumption (even when not all properties are strictly necessary).
 
\begin{assumption}\label{ass_c1-6}
Assume  $|L|\le\lambda$ and suppose that $\M$ satisfies \ssf{c1-c6} of Definition~\ref{def_com_c}
\end{assumption} 
 
The assumption on the cardinality $L$ is only necessary to apply the downward L\"owenheim-Skolem Theorem when required.

\begin{proposition}\label{prop_6.1}
(Assume~\ref{ass_c1-6})  \  The following are equivalent
\begin{itemize}
\item[1.] $N$ is a $\lambda\jj$rich model;
\item[2.] for every model $M$ of cardinality $\le\lambda$ and every morphism $k:M\imp N$ of cardinality, say $<\lambda$ there is a embedding $h:M\hookrightarrow N$ that extends $k$.
\end{itemize}
\end{proposition}
\begin{proof}
Closure under union of chains of morphisms, which is ensured by \ssf{c7}, immediately yields \ssf{1}$\IMP$\ssf{2}.
As for implication \ssf{2}$\IMP$\ssf{1} we only need to consider the case $\lambda<|M|$.
Let $k:M\imp N$ be a morphism of cardinality $<\lambda$ and $b\in M$.
By the downward L\"owenheim-Skolem theorem there is an  $M'\preceq M$ of cardinality $\lambda$ containing $\dom k \cup\{b\}$.
Let $h:M'\hookrightarrow N$ be the embedding obtained from \ssf{2}.
By \ssf{c4}, the map  $h:M\to N$ is a composition of morphisms, hence a morphism.
\end{proof}

The following theorem subsumes both Theorem~\ref{thm_zigzagcantor} and Theorem~\ref{gaomegacat}.

\begin{theorem}\label{thm_riccozigzag}
(Assume~\ref{ass_c1-6})  \  Let $M$ and $N$ be two rich models of the same cardinality $\lambda$.
Then every morphism $k:M\imp N$ of cardinality $<\lambda$ extends to an isomorphism.
\end{theorem}

\begin{proof}
When $\lambda=\omega$, we can take the proof of Theorem~\ref{thm_zigzagcantor} and replace \textit{partial isomorphism\/} by \textit{morphism\/} and the references to Lemma~\ref{lem_ordinericco} by references to Proposition~\ref{prop_6.1}.
As for uncountable $\lambda$, we only need to extend the construction through limit stages.
By \ssf{c7} we can simply take the union.
\end{proof}


\begin{corollary}\label{coroll_riccozigzag}
(Assume~\ref{ass_c1-6})  \  Then all rich models of cardinality $\lambda$ in the same connected component are isomorphic.\QED
\end{corollary}

It is obvious that $\lambda\jj$rich models are $\lambda\jj$universals and, by Theorem~\ref{thm_riccozigzag}, they are $\lambda\jj$ho\-mo\-ge\-ne\-ous.
These two notions are weaker than richness.
For instance, when $\M$ is as in Section~\hyperref[randomgraph]{\ref*{relational}.\ref*{randomgraph}}, the countable graph that has no arc is trivially ultrahomogeneous but it is not universal and a fortiori not rich.
On the other hand if we add to a countable random graph an isolated point we obtain an universal graph which is not ultrahomogeneous.
However, when taken together, these two properties are equivalent to richness.

\begin{theorem}\label{ricco<->universaleomogeneo}
(Assume~\ref{ass_c1-6}) \ The following are equivalent:
\begin{itemize}
\item[1.] $N$ is rich;
\item[2.] $N$ is homogeneous and universal.
\end{itemize}
\end{theorem}
\begin{proof} 
Implication \ssf{1}$\IMP$\ssf{2} is clear as noted above, so we prove \ssf{2}$\IMP$\ssf{1}.
We use the characterization of richness given in Proposition~\ref{prop_6.1}.
Let $k:M\imp N$ be a morphism such that $|k|<|N|$ and $|M|\le|N|$.
As $N$ is universal, there is a total morphism \hbox{$f:M\hookrightarrow N$}.
By \ssf{c3} the map $k\circ f^{-1}:N\imp N$ is a morphism of cardinality $<|N|$.
By homogeneity it has an extension to an automorphism $h:N\isomap N$.
It is immediate that $h\circ f:M\hookrightarrow N$ is the required extension of $k$.
\end{proof}


\begin{exercise}
Let $N$ be the structure obtained by adding to a countable random graph an isolated point.
Show that $N$ is homogeneous if morphisms are elementary maps but it is not if morphisms are simply partial isomorphisms.\QED
\end{exercise}

A consequence of Theorem~\ref{thm_riccozigzag} is that morphisms between rich models of the same cardinality are elementary maps.
However, the theorem gives no information when the models have different cardinality nor when they are merely $\lambda$-rich.
This case is dealt with by next theorem, arguably the main result of this section.

To test the theorem below in a simple case we propose the following exercise.

\begin{exercise}
Every partial isomorphism $k:M\to N$ between models of $T_{\rm dlo}$ (or models of  $T_{\rm rg}$) is an elementary map.
Hint: use downward L√∂wenheim-Skolem and Theorem~\ref{thm_zigzagcantor}.\QED
\end{exercise}


\begin{theorem}\label{thm_morphism_rich_elementary}
(Assume~\ref{ass_c1-6})  \  Every morphism between $\lambda\jj$rich models is elementary.
In particular, $\lambda\jj$rich models in the same connected component are elementary equivalent.
\end{theorem}

\begin{proof}
Let $k:M\to N$ be a morphism between rich models.
It suffices to prove that every finite restriction of $k$ is elementary.
By \ssf{c2}, we may as well assume that $k$ itself is finite.
It suffices to construct $M'\preceq M$ and  $N'\preceq N$ together with a morphism $h:M\to N$ that extends $k$ and maps $M'$ bijectively to $N'$.
Then by \ssf{c6} the map $h:M'\isomap N'$ is the composition of morphisms, hence it is a morphism.
Finally, by \ssf{c4}, it is an isomorphism, in particular an elementary map.

In general, richness is not preserved under elementary equivalence.
Therefore $M'$ and $N'$ need to be constructed simultaneously with $h$.
We define a chain of functions $\<h_i:i{<}\lambda\>$ such that $h_i:M\to N$ are mor\-phisms and in the end we set

\hfil  $\displaystyle h\ \ =\ \ \bigcup_{i<\lambda}h_i$,\hfil $\displaystyle M'\ =\ \dom h$,\hfil $\displaystyle N'\ =\ \range h$.

We interweave the usual back-and-forth-argument with the L√∂wenheim-Skolem construction~\ref{diym_II_lowenheimskolemallingiu} in order to obtain $M'\preceq M$ and  $N'\preceq N$.

The chains start with $h_0=k$.
At limit stages we take the union.
Now assume we have $h_i$.
Let $\phi(x)\in L(\dom h_i)$ some formula consistent in $M$ and pick a solution $b\in M$.
By $\lambda$-richness there is a $c\in N$ such that $h_i\cup\{\<b,c\>\}:M\to N$ is a morphism.
Let $h_{i+^1\!\!/\!_2}=h_i\cup\{\<b,c\>\}$.

Finally, as in the proof of Theorem~\ref{thm_zigzagcantor}, we extend $h_{i+^1\!\!/\!_2}$ to obtain $h_{i+1}$.
We use procedure with the roles of $M$ and $N$ inverted and with $h^{-1}_{i+^1\!\!/\!_2}$ for $h_i$.

In the end we obtain $M'\preceq M$ if all formulas $\phi(x)\in L(M')$ are eventually considered.
A similar consideration holds for $N'$.
This is achieved using the same dovetail enumeration as in our second proof the downward L√∂wenheim-Skolem Theorem~\ref{diym_II_lowenheimskolemallingiu}.
\end{proof}

The \emph{theory of rich models\/} of $\M$ is the set $T_1$ of sentences that hold in all rich models (or, equivalently, in any $|L|$-rich model), assuming they exist.
By the theorem above, $T_1$ is complete as soon as $\M$ is connected.

Assume for simplicity that $L$ is countable and that $\M$ is connected.
Then all $\omega\jj$rich models belong to $\Mod(T_1)$ for some complete theory $T_1$.
It is interesting to ask if the converse is true: if $T_1$ is the theory of the $\omega\jj$rich models of $\M$, do all models in $\M\cap \Mod(T_1)$ are rich?  The answer is affirmative when $T_1$ is either $T_{\rm dlo}$ or $T_{\rm rg}$, but this is not always the case, see Example~\ref{ex_infiniti_colori} for an easy counterexample.
An affirmative answer implies that the theory of rich models is $\omega\jj$categorical.
An interesting variant of this question is considered in Theorem~\ref{thm_ricchezza_saturazione_QE}.

For convenience of the reader, we instantiate Theorem~\ref{thm_morphism_rich_elementary} with the two categories used in Chapter~\ref{relational}.

\begin{corollary}\label{coroll_tutteleimmersionisonoelementari_QE}
Partial isomorphisms between models of $T_{\rm dlo}$ and between models of $T_{\rm rg}$ are elementary maps.\QED
\end{corollary}

When partial isomorphism between models of a given theory $T$ coincide with elementary maps, it is always by a fundamental reason.
Let us introduce some terminology.
Let $T$ be a consistent theory.
We say that \emph{$T$ has (or admits) elimination of\/} \emph{quantifiers\/} if for every $\phi(x)\in L$ there is a quantifier-free formula $\psi(x)\in L_{\rm qf}$ such that 

\ceq{\hfill T}{\proves}{\psi(x)\iff\phi(x).}

We will discuss general criteria for elimination of quantifiers in Chapter~\ref{elimination}.
Here we report without proof the following theorem.

\begin{theorem}\label{thm_tutteleimmersionisonoelementari_QE}
The following are equivalent
\begin{itemize}
\item[1.] $T$ has elimination of quantifiers;
\item[2.] every partial isomorphism between models $T$ is an elementary map.\QED
\end{itemize}
\end{theorem}

\noindent\llap{\textcolor{red}{\Large\danger}\kern1.5ex}For the time being when saying that \textit{$T$ has quantifier elimination\/} we intend \ssf{2} of the theorem above.
The equivalence with \ssf{1} will be proved only in Corollary~\ref{corol_QE} and it is not required in the meanwhile (if you accept the theorem above as a definition).
For instance we rephrase Corollary~\ref{coroll_tutteleimmersionisonoelementari_QE} above as follows.

\begin{corollary}\label{coroll_tutteleimmersionisonoelementari_QE2}
The theories $T_{\rm dlo}$ and $T_{\rm rg}$ have elimination of quantifiers.\QED
\end{corollary}

In the next chapter we introduce important examples of $\omega\jj$rich models that do not have an $\omega\jj$categorical theory.
These are algebraic structures (groups, fields etc.) hence more complex than pure relational structures.
So, we conclude this section with an example of this phenomenon in almost trivial context.

\begin{example}\label{ex_infiniti_colori}
Let $L$ contain a unary predicate $r_n$ for every positive integer $n$.
The theory $T_0$ contains the axioms $\neg\E x\, \big[r_n(x)\wedge r_m(x)\big]$ for $n\neq m$ and $\E^{\le n}x\,r_n(x)$ for every $n$.
Work in the the category of models of $T_0$ and partial isomorphisms.
Let $T_1$ be the theory that extends $T_0$ with the axioms $\E^{= n} x\, r_n(x)$ for every  $n$.
Let $q(x)$ be the type $\big\{\neg r_n(x):n\in\omega\big\}$.
There are models of $T_1$ that do not realize $q(x)$, hence $T_1$ is not $\omega$-categorical.
It is easy to verify that the following are equivalent.
\begin{itemize}
 \item[1.] $N$ is an $\omega$-rich model;
 \item[2.] $N\models T_1$ and  $q(N)$ is infinite.
\end{itemize}
The reader may use Theorem~\ref{thm_morphism_rich_elementary} and Compactess Theorem for Types~\ref{thm_compattezzatipi} to prove that $T_1$ is complete and has elimination of quantifiers.
It is also easy to verify that every uncountable model of $T_1$ is rich and consequently that $T_1$ is uncountably categorical.\QED
\end{example}

\begin{exercise}\label{ex_finiti_colori}
Let $T_0$ and $\M$ be as in Example~\ref{ex_infiniti_colori} except that we restrict the language to the relations $r_0,\dots,r_n$ for a fixed $n$.
Do $\omega\jj$rich models of $T_0$ exist? Is their theory $\omega\jj$categorical? What if we add to $T_0$ the axiom $r_0(x)\vee\dots\vee r_n(x)$~?\QED
\end{exercise}

\begin{exercise}
The language contains only the binary relations $<$ and $e$.
The theory $T_0$ says that $<$ is a strict linear order and that $e$ is an equivalence relation.
Let $\M$ consists of models of $T_0$ and partial isomorphisms.
Do rich models exist? Can we axiomatize their theory? If so, does it have elimination of quantifiers? Is it $\lambda$-categorical for some $\lambda$?\QED
\end{exercise}

\begin{exercise}
The language contains only two binary relations.
The theory $T_0$ says that they are equivalence relations.
Let $\M$ consists of models of $T_0$ and partial isomorphisms.
Do rich models exist? Can we axiomatize their theory? If so, does it have elimination of quantifiers? Is it $\lambda$-categorical for some $\lambda$?\QED
\end{exercise}

\begin{exercise}
In the language of graphs let $T_0$ say that there are no cycles (equivalently, there is at most one path between any two nodes).
In combinatorics these graphs are called \textit{forests}, and their connected components are called \textit{trees}.
Let $\M$ consists of models of $T_0$ and partial isomorphisms.
Do rich models exist? Can we axiomatize their theory? If so, does it have elimination of quantifiers? Is it $\lambda$-categorical for some $\lambda$?\QED
\end{exercise}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Weaker notions of universality and homogeneity}\label{weak}

We want to extend the equivalence in Theorem~\ref{ricco<->universaleomogeneo} to $\lambda\jj$rich models.
For that we need to weaken the notions of $\lambda\jj$universality and  $\lambda\jj$homogeneity.
This section is more technical and could be skipped at a first reading.

\begin{definition}
We say that a structure $N$ is \emph{weakly $\lambda$-homogeneous\/} if for every ${\mr b}\in N$ every morphism $k:N\imp N$ of cardinality $<\lambda$ extends to one defined in ${\mr b}$.
The term \emph{back-and-forth $\lambda$-homogeneous\/} is also used.\QED
\end{definition}

The following easy exercise on back-and-forth is required in the sequel.

\begin{exercise}\label{omogeneo=debolmenteaomogeneo}
(Assume~\ref{ass_c1-6}) \ Prove that any weakly $\lambda\jj$ho\-mo\-ge\-ne\-ous structure of cardinality $\lambda$ is homogeneous.\QED
\end{exercise}

\begin{definition}\label{def_weakly_universal}
We say that a structure $N$ is \emph{weakly $\lambda$-universal\/} if for every model $M$ in the connected component of $N$ and every $A\subseteq M$ of cardinality $<\lambda$ there is a morphism $k:M\to N$ such that $A\subseteq\dom k$.\QED
\end{definition}

\begin{lemma}\label{debolmenteomogeneoandirivieni}
(Assume~\ref{ass_c1-6})  \  Let $N$ be a weakly $\lambda\jj$ho\-mo\-ge\-ne\-ous model.
Let $A\subseteq N$ have cardinality $\le\lambda$ and let $k:N\to N$ be a morphism of cardinality $<\lambda$.
Then there is a model  $M\preceq N$ containing $A$ and an automorphism $h:M\isomap M$ that extends $k$.
\end{lemma}

\begin{proof}
Similar to the proof of Theorem~\ref{thm_morphism_rich_elementary}.
We shall construct simultaneously a chain $\<A_i:i<\lambda\>$ of subsets of $N$ and a chain functions $\<h_i:i<\lambda\>$, such that $h_i:N\to N$ are morphisms.
In the end we will set

\hfil $\displaystyle M\ \ =\ \ \bigcup_{i<\lambda}A_i$\hfil  and\hfil  $\displaystyle h\ \ =\ \ \bigcup_{i<\lambda}h_i$ 

The chains start with $A_0=A\cup\dom k\cup\range k$ and $h_0=k$.
As usual, at limit stages we take the union.
Now we consider successor stages.
At stage $i$ we fix some enumerations of $A_i$ and of $L_{\mr x}(A_i)$, where $|{\mr x}|=1$.
Let $\<i_1,i_2\>$ be the $i\jj$th pair of ordinals $<\lambda$.
If the $i_2\jj$th formula in $L_{\mr x}(A_{i_1})$ is consistent in $N$, let ${\gr a}$ be any of its solutions.
Also let ${\mr b}$ be the $i_2\jj$th element of $A_{i_1}$.
Let $h_{i+1}:N\to N$ be a minimal morphism that extends $h_i$ and is such that ${\mr b}\in\dom h_{i+1}\cap\range h_{i+1}$.
Define $A_{i+1}=A_i\cup\big\{{\gr a},\ h_{i+1}{\mr b},\  h_{i+1}^{-1}{\mr b}\big\}$.
\end{proof}

\begin{theorem}\label{ricco=universaledebolmenteomogeneo}
(Assume~\ref{ass_c1-6})  \  For every model $N$ the following are equivalent
\begin{itemize}
\item[1.] $N$ is $\lambda$-rich;
\item[2.] $N$ is  weakly $\lambda\jj$universal and weakly $\lambda\jj$homogeneous.
\end{itemize}
\end{theorem}

\begin{proof} 
Implication \ssf{1}$\IMP$\ssf{2} is clear.
To prove \ssf{2}$\IMP$\ssf{1} we generalize the proof of Theorem~\ref{ricco<->universaleomogeneo}.
We assume \ssf{2} fix some morphism $k:M\imp N$ of cardinality $<\lambda$ and let $b\in M$.
By weak $\lambda\jj$universality there is a morphism $f:M\imp N$ with domain of definition $\dom k\cup\big\{b\big\}$.
The map $f\circ k^{-1}:N\imp N$ has cardinality $<\lambda$ and, by Lemma~\ref{debolmenteomogeneoandirivieni}, it has an extension to an automorphism $h:N'\isomap N'$ for some $N'\preceq N$ containing $\range k\cup\range f$.
Then $h\circ f:M\imp N$ extends $k$ and is defined on $b$.
\end{proof}

\section{The amalgamation property}

In this section we discuss conditions that ensure the existence of rich models.

We say that $\M$ has the \emph{amalgamation property\/} if for every pair of morphisms $f_1:M\to M_1$ and $f_2:M\to M_2$ there are two of embeddings $g_1:M_1\hookrightarrow N$ and $g_2:M_2\hookrightarrow N$ such that $g_1\circ f_1\, (a) = g_2\circ f_2\, (a)$ for every $a$ in the common domain of definition, $\dom (f_1)\; \cap\; \dom (f_2)$.


\hfil\begin{tikzcd}[row sep=tiny]
& M_1  \arrow[dr, hook, "g_1\strut" above] & \\
M \arrow[ur, "f_1" above] \arrow[dr, "f_1" below] &  & N \\
& M_2  \arrow[ur, hook, "g_2\rule{0ex}{1ex}" below] & \\
\end{tikzcd}

As we assume that morphisms are invertible, we may express the amalgamation property in a more concise form.
Namely, for every morphism $k:M\to N$ there is morphism  $g:M'\to N'$ such that the following diagram commutes

\hfil\begin{tikzcd}[row sep=tiny]
& N  \arrow[dr, hook, "\kern2ex{\rm id}_N" above] & \\
M \arrow[ur, "k\kern1ex" above] \arrow[rr, hook, "g" below] &  & N' \\
\end{tikzcd}

It is convenient to use the following terminology.
We write \emph{$M\le N$\/} for $M\subseteq N$ and $\id_M:M\hookrightarrow N$ is a morphism.
We say that $k:M\to N$ \emph{extends to\/} $g:M'\to N'$ if $k\subseteq h$, $M\le M'$, and  $N\le N'$.


\begin{proposition}\label{prop_amalgamation_def}
Assume \ssf{c3}, then the following are equivalent
\begin{itemize}
\item[1.] $\M$ has the amalgamation property;
\item[2.] every morphism $k:M\to N$ extends to an embedding $g : M\hookrightarrow N'$.
\end{itemize}
\end{proposition}

\begin{proof}
\ssf{1}$\IMP$\ssf{2} Given $k:M\to N$, the amalgamation property yields the following commutative diagram which can be simplified to the diagram at the right

\hfil\begin{tikzcd}[row sep=tiny]
& N  \arrow[dr, hook, "g_1\strut" above] & \\
M \arrow[ur, "\kern1ex k" above, near start] \arrow[dr, "\id_M" below, near start] &  & N' \\
& M  \arrow[ur, hook, "g_2\rule{0ex}{1ex}" below] & \\
\end{tikzcd}
\hfil\begin{tikzcd}[row sep=tiny]
& N  \arrow[dr, hook, "g_1\strut" above] & \\
M \arrow[ur, "\kern1ex k" above, near start] \arrow[rr, hook, "g_2" below] &  & N' \\
\end{tikzcd}

Up to isomorphism we can assume $g_2=\id_M$, i.e.\@ that $N\le N'$.
Hence $g_2:M\hookrightarrow N'$ is the required extension of $k:M\to N$.

\ssf{2}$\IMP$\ssf{1} Let  $f_1:M\to M_1$ and $f_2:M\to M_2$ be given.
Let $k=f_2\circ f_1^{-1}:M_1\to M_2$ and let  $g:M_1\hookrightarrow N'$ be the extension ensured by \ssf{2}.
Then we obtain

\hfil\begin{tikzcd}[row sep=normal, column sep=large]
& M_1  \arrow[dd, "f_2\circ f_1^{-1}"] \arrow[dr, hook, "\kern1ex g" above] & \\
M \arrow[ur, "f_1\kern1ex" above] \arrow[dr, "f_2\kern1ex" below] &  & N' \\
& M_2  \arrow[ur, hook, "\kern3ex\id_{M_2}\rule{0ex}{1.5ex}" below] & \\
\end{tikzcd}

as required.
\end{proof}

We say that $\<M_i:i<\lambda\>$ is a \emph{$\le$-chain\/} if $M_i\le M_j$ for all $i<j<\lambda$.
For the next theorem to hold we need the following property:

\begin{definition}
We say that $\M$ is \emph{closed under union of $\le$-chains\/} if
\begin{itemize}
\item[c8.] if $\<M_i:i<\lambda\>$ is a $\le$-chain,  then \smash{$\displaystyle M_i\le\bigcup_{j<\lambda}M_j$} \ for all $i<\lambda$.\QED
\end{itemize}
\end{definition}

The following is a general existence theorem for rich models.
This general form requires large cardinalities.
We leave to the reader to verify that if the number if finite morphisms is countable (up to isomorphism) then countable rich models exit.

\begin{theorem}  Assume~\ref{ass_c1-6}.
Assume further \ssf{c8} and that $\M$ has the amalgamation property.
Let $\lambda$ be such that $|L|<\lambda=\lambda^{<\lambda}$.
Then there is a rich model $N$ of cardinality $\lambda$.
\end{theorem}

\begin{proof} We construct $N$ as union of a $\le$-chain of models $\langle N_i:i < \lambda\rangle$ such that $|N_i| = \lambda$.
Let $N_0$ be any model of cardinality $\lambda$.
At stage $i+1$, let $f:M\imp N_i$ be the least morphism (in a well-ordering that we specify below) such that $|f|\le|M|<\lambda$ and $f$ has no extension to an embedding $f':M\hookrightarrow N_i$.
Apply the amalgamation property to obtain an total morphism $f':M\hookrightarrow N'$ that extends $f:M\imp N_i$.
By the downword L\"owenheim-Skolem Theorem we may assume $|N'|=\lambda$.
Let $N_{i+1}=N'$.
At limit stages take the union.

The well-ordering mentioned needs to be chosen so that in the end we forget nobody.
So, first at each stage we well-order the isomorphism-type of the morphisms $f:M\imp N_i$ such that  $f\le|M|<\lambda$.
Then the required well-ordering is obtained by dovetailing all these well-orderings.
The length of this enumeration is at most $\lambda^{<\lambda}$, which is $\lambda$ by hypothesis.

We check that $N$ is rich.
Let $f:M\imp N$ be a morphism and $|f|<|M|\le\lambda$.
As $|L|<\lambda$ we can approximate $M$ with an elementary chain of structures of cardinality $<\lambda$.
Hence we may as well assume that $|f|\le|M|<\lambda$.
The cofinality of $\lambda$ is larger than $|f|$, hence $\range f\subseteq N_i$ for some $i<\lambda$.
So $f:M\imp N_i$ is a morphism and at some stage $j$ we have ensured the existence of an embedding of $f':M\hookrightarrow N_{j+1}$ that extends $f$.
\end{proof}

\begin{proposition}\label{prop_elementary_amalg}
Let $\M$ consist of all structures of some fixed signature and the elementary maps between these.
Then $\M$ has the amalgamation property.
\end{proposition}

\begin{proof}
Let $k:M\to N$ be an elementary map.
Let ${\gr a}$ enumerate $\dom k$ and let ${\mr b}$ enumerate $M$.
Let $p({\mr x}\,;{\gr z})=\tp_M({\mr b}\,;{\gr a})$.
The type $p({\mr x}\,;{\gr a})$ is consisent in $M$, in particular, it is finitely consistent and, by elementarity,  $p({\mr x}\,;k{\gr a})$ is finitely consistent in $N$.
By the compactness theorem, there is $N'\succeq N$ such that $N'\models p({\mr c}\,;k{\gr a})$ for some ${\mr c}\in N'^{|{\mr x}|}$ .
Hence $g=\{\<{\mr b},{\mr c}\>\}:M\to N'$ is the required elementary map that extends $k:M\to N$.
\end{proof}
% \section{Notes and references}
% 
%  We refer the interested reader to the references at the end of the chapter.
% 
% 
% \begin{biblist}[]\normalsize
% 
%  \bib{LR}{article}{
%    author={Lieberman, Michael},
%    author={Rosick\'y, Jir\'i},
%    title={Classification theory for accessible categories},
%    %eprint={https://arxiv.org/abs/1404.2528},
%    status={\href{https://arxiv.org/abs/1404.2528}{arXiv:1404.2528}},
%    date={2014}
% }  
%    
% 
% \end{biblist}


\begin{comment}


%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{A non $\omega$-categorical example}\label{eserciziorisolto}

In the next chapter we introduce important examples of $\omega\jj$rich models that do not have an $\omega\jj$categorical theory.
They are algebraic structures (groups, fields etc.) hence more complex than pure relational structures.
So, it may be useful to observe the phenomenon in a simpler context.
(It is not the simplest one, see Exercise~\ref{ex_infiniti_colori}.)

Let $L$ be the language that contains a binary relation $<$ and a unary predicate $r_n$ for every $n\in\omega$.
The theory  $T_0$ contains $T_{\rm lo}$ and the axioms $\neg\E x\, \big[r_n(x)\wedge r_m(x)\big]$ for $n\neq m$.
Let $T$ be the theory that contains $T_0$ and the axioms
\begin{itemize}
\item[1.] $\E y,z\ (y<x<z)$;
\item[d$_n$] $x<y\ \imp\ \E z\,\big[\,x<z<y\ \wedge\ r_n(z)\big]$;
\end{itemize}
We claim that $T$ is consistent.
In fact, $\QQ$ is a model of $T$ if we interpret $r_n$ in the set of rationals of the form $k\cdot p_n^{-i}$, where $p_n$ is the $n$-th prime, $i\in\ZZ$ is positive, and $k\in\ZZ$ is coprime with $p_n$.

For the rest of this section $\M$ is the c.o.m.\@ with $\M_{\rm ob}=\Mod(T_0)$ and $\M_{\rm hom}$ the class of partial isomorphisms between models.

\begin{proposition}
For every model $N$ and $a,b\in N$ define 

\ceq{\hfill p_{a,b}(x)}{=}{\Big\{a<b\ \imp\ a<x<b\wedge\neg r_n(x)\ :\ n\in\omega\Big\}}

Then the following are equivalent
\begin{itemize}
 \item[1.] $N$ is an $\omega$-rich model;
 \item[2.] $N\models T$ and  $N\models \E x\, p_{a,b}(x)$ for every $a,b\in N$.
\end{itemize}
\end{proposition}

Note that it is easy to find a countable model of $T$ that does not realizes all the types in \ssf{2}.
For instance, we could take the model described above and throw away all rationals that are not in any of the sets $r_n(\QQ)$.

\begin{proof}
The proof of implication \ssf{1}$\IMP$\ssf{2} is left to the reader.
(It is similar to Exercise~\ref{ex_ricco->dlo}.)

As for \ssf{2}$\IMP$\ssf{1}, we adapt the proof of Lemma~\ref{lem_ordinericco}.
We assume for simplicity that $A\neq\0\neq B$, the reader may easily adapt the argument to the general case.
Suppose first that $M\models r_n(a_i)$ for some $n$.
As the $r_n$ are mutually exclusive, for $h_{i+1}$ to be a partial isomorphism it sufficient to find $c\in N$ such that $h_i[A]<c<h_i[B]$ and $N\models r_n(c)$.
This we can do by axiom \ssf{d$_{n}$}.
It could also be the case that  $M\models \neg r_n(a_i)$ for every $n$.
In this case the required $c$ is any witness of $M\models \E x\, p_{a,b}(x)$ with $h_i[A]=a$ and $h_i[B]=b$
\end{proof}

We sum up: $\Mod(T)$ contains countable models that not rich, hence $T$ is not $\omega$-categorical; still, by Theorem~\ref{thm_morphism_rich_elementary}, $T$ is complete and has elimination of quantifiers.
\end{comment}


\end{document}
