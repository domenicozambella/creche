% !TEX root = creche.tex
\documentclass[creche.tex]{subfiles}
\begin{document}

\chapter{Ramsey theory}
\label{ramsey}

In Section~\ref{Ramsey} we prove Ramsey's theorem and in Section~\ref{EM} we present its major application in model theory: 
Ehrenfeucht-Mostowsky's construction of indiscernibles.

In the remaining sections we prove two important results of Ramsey theory.
These results will not be used elsewhere in these notes.
Our only purpose is to illustrate a concrete (relatively speaking) application of the notion of coheir.

\def\medrel#1{\parbox[t]{6ex}{$\displaystyle\hfil #1$}}
\def\ceq#1#2#3{\parbox[t]{12ex}{$\displaystyle #1$}\medrel{#2}{$\displaystyle #3$}}



%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Ramsey theorem from coheir sequences}
\label{Ramsey}

In this chapter we are interest in finite partitions.
We may represent the partition of a set $X$ into $k$ subsets with a map $f:X\to [k]$.
The elements of $[k]=\{1,\dots,k\}$ are also called \emph{colors},
and the partition a \emph{coloring},
or \emph{$k$-coloring}, of $X$.
We say that $Y\subseteq X$ is \emph{monochromatic\/} if $f_{\restriction Y}$ is constant on $Y$.

Let $M$ be an arbitrary infinite set.
Fix $n,k<\omega$ and fix a coloring $f$ of the set of all \emph{$n$-subsets} of $M$,
aleas the \emph{complete $n$-uniform hypergraph\/} with vertex set $M$,

\ceq{\hfill f}{:}{ {M\choose n}\ \ \to\ \ [k]}.

We say that $H\subseteq M$ is a \emph{monochromatic subgraph\/} if the subgraph induced by $H$ is monocromatic.
In the literature monochromatic subgraph are also called \emph{homogeneous sets}.

The following is a very famous theorem which here we prove it in unusual way.
It will serve as blueprint for other constructions in this chapter.

\theoremstyle{mio}
\newtheorem{Ramsey}[thm]{Ramsey Theorem}
\begin{Ramsey}\label{thm_Ramsey}
Let $M$ be an infinite set and fix some positive integers $n$ and $k$.
Fix also an arbitrary $k$-coloring of the (edges of the) complete $n$-uniform hypergraph with vertex set $M$.
Then there infinite monochromatic subgraph $H\subseteq M$.
\end{Ramsey}
\begin{proof}
Let $L$ be a language that contains $k$ relation symbols $r_1,\dots,r_k$ of arity $n$.
Given a $k$-coloring $f$ we define a structure with domain $M$.
The interpretation the relation symbols is

%\ceq{\hfill r_i^M}{=}{\Big\{ ({\mr a_0},\dots,a_{n-1})\ :\ |\{{\mr a_0},\dots,a_{n-1}\}|=n \ \textrm { e \ }f\big(\{{\mr a_0},\dots,a_{n-1}\}\big)= i\Big\}}

%\ceq{\hfill r_i^M}{=}{\Big\{ \<{\mr a_0},\dots,{\mr a_{n-1}}\>\ :\  \big|\big\{{\mr a_0},\dots,{\mr a_{n-1}}\big\}\big|=n \ \textrm { and \ }f\big(\big\{{\mr a_0},\dots,{\mr a_{n-1}}\big\}\big)= i\Big\}} 

\ceq{\hfill r_i^M}{=}{\Big\{ {\mr a_1},\dots,{\mr a_n}\in M \ : \ f\big(\{{\mr a_1},\dots,{\mr a_n}\}\big)= i\Big\}.} 

We may assume that $M$ is an elementary substructure of some large saturated model $\U$.
Pick any type $p({\mr x})\in S(\U)$ finitely satisfied in $M$ but not realized in $M$ and let ${\mr\bar c}=\<{\mr c_i}:i<\omega\>$ be a coheir sequence of $p({\mr x})$.

There is a first-order sentence saying that the formulas $r_i({\mr x_1},\dots,{\mr x_n})$ are a coloring of ${M\choose n}$.
Then by elementarity the same hols in $\U$.
By indiscernibility,
all tuples of $n$ distinct elements of ${\mr\bar c}$ have the same color, say \textit{red}.

%\ceq{\ssf{\#}\hfill M}{\models}{\A {\mr x_0},\dots,{\mr x_{n-1}}\ \left[\bigwedge_{0\le i<j<n} {\mr x_i}\neq {\mr x_j}\quad\imp\quad\bigvee_{i<k}r_i({\mr x_0},\dots,{\mr x_{n-1}})\right].}

Note parenthetically that no element of ${\mr\bar c}$ is in $M$.
The theorem is proved if we can find in $M$ a sequence ${\mr\bar a}=\<{\mr a_i}:i<\omega\>$ with the same color.
We construct ${\mr a_{\restriction i}}$ by induction on $i$ as follows.

Assume as induction hypothesis that the subsequences of length $n$ of ${\mr a_{\restriction i}},{\mr c_{\restriction n}}$ are all red.
Our goal is to find ${\mr a_i}$ such as the same property holds for ${\mr a_{\restriction i}},{\mr a_i},{\mr c_{\restriction n}}$.
By the indiscernibility of ${\mr\bar c}$,
the property holds for  ${\mr a_{\restriction i}},{\mr c_{\restriction n}},{\mr{c_n}}$.
And this can be written by a formula $\phi({\mr a_{\restriction i}},{\mr c_{\restriction n}},{\mr{c_n}})$.
As ${\mr\bar c}$ is a coheir sequence,
by Lemma~\ref{lem_coheir_property} we can find  ${\mr a_i}\in M$ such that  $\phi({\mr a_{\restriction i}},{\mr c_{\restriction n}},{\mr a_i})$.
So,
as the order is irrelevant,
${\mr a_{\restriction i}},{\mr a_i},{\mr c_{\restriction n}}$ satisfies the induction hypothesis.
\end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Ehrenfeucht-Mostowski construction of indiscernibles}\label{EM}

Let $I,<_I$ be an infinite linear order and let ${\mr\bar a}$ be an $I\jj$sequence.
Fix a tuple of distinct variables ${\mr\bar x}=\<{\mr x_i}: i<\omega\>$.
We write \emph{$p({\mr\bar x})\;=\;\textrm{{\small EM}-tp}({\mr\bar a}/A)$} and say that $p({\mr\bar x})$ is the \emph{Ehren\-feucht-Mostowski type\/} of ${\mr\bar a}$ over $A$ if

\ceq{\hfill p({\mr\bar x})}{=}{\Big\{\phi({\mr x_{\restriction n}})\in L(A)\ :\ \phi({\mr a_{\restriction I_0}})\ \textrm{ holds for every }\ I_0\in{I\choose n}\Big\}.}

Note that ${\mr\bar x}$ is always of order-type $\omega$,
while ${\mr\bar a}$ is an arbitrary infinite sequence.
Clearly,
${\mr x_i}$ and  ${\mr a_i}$ are tuple of the same sort.

Note also that if ${\mr\bar a}$ is $A\jj$indiscernible then $\EMtp({\mr\bar a}/A)$ is a complete type,
and vice versa.
So,
if ${\mr\bar a}$ and ${\mr\bar c}$ are two $A\jj$indiscernible $I\jj$sequences with the same Ehren\-feucht-Mostowski type over $A$,
then ${\mr\bar a}\equiv_A {\mr\bar c}$.

\theoremstyle{mio}
\newtheorem{EhrenfeuchtMostowski}[thm]{Ehrenfeucht-Mostowski Theorem}
\begin{EhrenfeuchtMostowski}\label{thm_EM}
Let $I,<_I$ and $J,<_J$ be two infinite linear orders such that $|J|\le \kappa$.
Then for every sequence ${\mr\bar a}=\<{\mr a_i}:i\in I\>$ there is an $J\jj$sequence of $A$-indiscernibles ${\mr\bar c}$ such that $\EMtp({\mr\bar a}/A)\subseteq\EMtp({\mr\bar c}/A)$.
\end{EhrenfeuchtMostowski}


\begin{proof}
We prove the theorem for $I=J=\omega$ and leave the general case to the reader.
Let ${\mr\bar c}$ be any realization of the following type yields a $J$-sequence of $A$-indiscernibles.

\ceq{\hfill q({\mr\bar x})}
{\cup}
{\Big\{\phi({\mr x_{\restriction I_0}})\iff\phi({\mr x_{\restriction J_0}})\ :\  \phi({\mr x_{\restriction n}})\in L(A), \ I_0, J_0\in{\omega\choose n}, \ n<\omega\Big\}.}

We will prove that any finite subset of the type above is realized by a finite subsequence of ${\mr\bar a}$.
First note that any finite subset of $q({\mr\bar x})$ is realized by any subsequence of ${\mr\bar a}$ of the proper length by the definition of EM-type.
Then we only need to pay attention to the set on the right.

We prove that for $k$ and $n$ arbitrary large and every $\phi_1,\dots,\phi_k\in L_{\mr x_{\restriction n}}(A)$ there is an infinite $H\subseteq\omega$ such that ${\mr a_{\restriction H}}$ realizes

\ceq{\ssf{\#}}
{}
{\Big\{\phi_i({\mr x_{\restriction J_0}})\iff\phi_i({\mr x_{\restriction I_0}})\ :\  I_0, J_0\in{\omega\choose n}\textrm{ and } i\in[k]\Big\}.}

Consider the subsets of $[k]$ as colors and let $f$ be the coloring of ${\omega\choose n}$ that maps $I_0$ to the set $\big\{i\ :\ \phi_i({\mr a_{\restriction I_0}})\big\}$.
By the Ramsey theorem,
there is some infinite monochromatic set $H\subseteq\omega$.
As $\omega$ has order type $\omega$,
so does $H$,
and it is immediate that ${\mr a_{\restriction H}}$ realizes \ssf{\#},
as required to prove the theorem with $I=J=\omega$.
\end{proof}


\begin{proposition}\label{prop_indiscernibles_set_model}
  Let ${\mr\bar a}=\<{\mr a_i}:i\in I\>$ be a sequence of $A$-indiscernibles.
Then ${\mr\bar a}$ is indiscernible over some model $M$ containing $A$.
\end{proposition}

\begin{proof}
  Fix an arbitrary model $M$ containing $A$.
By Theorem~\ref{thm_EM} there is an $I\jj$sequence of $M\jj$indiscernibles ${\mr\bar c}$ such that $\EMtp({\mr\bar a}/M)\subseteq\EMtp({\mr\bar c}/M)$.
As ${\mr\bar a}$ is an $A\jj$indiscernible sequence ${\mr\bar a}\equiv_A{\mr\bar c}$.
Therefore $h\,{\mr\bar c}={\mr\bar a}$ for some some $h\in\Aut(\U/A)$.
Hence ${\mr\bar a}$ is indiscernible over $h[M]$.
\end{proof}

\begin{exercise}
Let $\bar a=\<a_i:i\in I\>$ be an $A\jj$indiscernible sequence and let $J\supseteq I$ with $|J|\le \kappa$.
Then there is an $A\jj$indiscernible sequence $\bar c=\<c_i:i\in J\>$ such that $c_{\restriction I}=\bar a$.\QED
\end{exercise}

\begin{exercise}
Let  $p({\mr x})\in S(\U)$ be a global type invariant over $A$.
Let ${\mr a},
{\mr b}\models p_{\restriction A}({\mr x})$.
Prove that there is a sequence ${\mr\bar c}=\<{\mr c_i}:i<\omega\>$ such that ${\mr a},{\mr\bar c}$ and ${\mr b},{\mr\bar c}$ are both sequences of $A\jj$indiscernibles.\QED
\end{exercise}

\begin{comment}
\section{Indempotents types in semigroups}\label{semigroups}

\def\medrel#1{\parbox[t]{6ex}{$\displaystyle\hfil #1$}}
\def\ceq#1#2#3{\parbox[t]{22ex}{$\displaystyle #1$}\medrel{#2}{$\displaystyle #3$}}

In this and the following sections we focus on semigroups definable in a first-order structure.
For a lighter notation,
we identify our semigroup with $\mrU$,
which here denotes the domain of a sort in a many-sorted monster model.
The language contains,
among others,
the symbol \emph{$\ \cdot\ $} which is interpreted as binary associative operation on $\mrU$.

We fix a set of parameters $A$,
not necessarily all of the same sort.
For any two sets $\mrA,\mrB\subseteq\mrU$ we define

\ceq{\hfill\emph{$\mrA\cdot_{\!A}\mrB$}}
{=}
{\Big\{ {\mr a}{\cdot}{\mr b}\ :\ {\mr a}\in\mrA, \ {\mr b}\in\mrB\textrm{ and }\ {\mr a}\nonforkc_{\!A}{\mr b}\Big\}}

We write \emph{${\mr a}\cdot_{\!A}\mrB$} for $\{{\mr a}\}\cdot_{\!A}\mrB$.
Similarly for \emph{$\mrA\cdot_{\!A}{\mr b}$} and \emph{${\mr a}\cdot_{\!A}{\mr b}$}.
Clearly,
the latter is either $\{{\mr a}{\cdot}{\mr b}\}$  or empty set.

Note that unless we add assumptions on $\nonforkc_{\!A}$ or on the underlying theory,
there is no guarantee that $\mrA\cdot_{\!A}\mrB$ is non empty,
not even when these sets are $A$-invariant.
With this proviso,
we proceed but with caution.

By the invariance of $\nonforkc_{\!A}$,
for every $f\in\Aut(\mrU/A)$ we have $f[\mrA\cdot_{\!A}\mrB]=f[\mrA]\cdot_{\!A}f[\mrB]$.
Therefore when $\mrA$ and $\mrB$ are invariant over $A$,
also $\mrA\cdot_{\!A}\mrB$ is invariant over $A$.
% And we also have that
% 
% \ceq{\hfill{\mr a}\cdot_{\!A}\mrB}{=}{\O({\mr a}/A)\cdot_{\!A}\mrB}
% 
% \ceq{\hfill\mrA\cdot_{\!A}{\mr b}}{=}{\mrA\cdot_{\!A}\O({\mr b}/A)}
% 
% Below we mainly deal with invariant sets and these identites will be (silently) applied.

\begin{proposition}\label{prop_semi_associative}
For every $A$-invariant sets $\mrA$, $\mrB$, and  $\mrC$.

\ceq{\hfill\big(\mrA\cdot_{\!A}\mrB\big)\cdot_{\!A}\mrC}
{\subseteq}
{\mrA\cdot_{\!A}\big(\mrB\cdot_{\!A}\mrC\big)}
\end{proposition}
\begin{proof}
Let ${\mr a}{\cdot}{\mr b}{\cdot}{\mr c}$ be an arbitrary element of the l.h.s.\@ for some ${\mr a}\nonforkc_{\!A}{\mr b}$ and ${\mr a}{\cdot}{\mr b}\nonforkc_{\!A}{\mr c}$.
By extension (Lemma~\ref{lem_coheir_independence}),
there exists ${\mr c'}$ such that ${\mr a},{\mr b},{\mr a}{\cdot}{\mr b}\nonforkc_{\!A}{\mr c'}\equiv_{A,\,{\mr a}{\cdot}{\mr b}}{\mr c}$.
By transitivity (again Lemma~\ref{lem_coheir_independence}),
${\mr a}\nonforkc_{\!A}{\mr b}{\cdot}{\mr c'}$.
Therefore ${\mr a}{\cdot}{\mr b}{\cdot}{\mr c'}$ belongs to the r.h.s.
Finally,
as ${\mr c'}\equiv_{A,\,{\mr a}{\cdot}{\mr b}}{\mr c}$,
also ${\mr a}{\cdot}{\mr b}{\cdot}{\mr c}$ belongs to the r.h.s.\@ by invariance.
\end{proof}

Let $\mrA$ be a non empty set.
If $\mrA\cdot_{\!A}\mrA\subseteq\mrA$ we say that it is \emph{idempotent\/} (over $A$).

\begin{corollary}\label{corol_min_idempotent}
Assume $\mrB\subseteq\mrA$ are both $A$-invariant.
Then if $\mrA$ is idempotent,
also $\mrB\cdot_{\!A}\mrA$ is idempotent.
% Similarly,
% if $\mrA$ is a right-ideal,
% also  $\mrB\cdot_{\!A}\mrA$ is a right-ideal.
\end{corollary}
\begin{proof}
We check that if $\mrA$ is idempotent so is $\mrB\cdot_{\!A}\mrA=\mrA$

\ceq{\hfill\big(\mrB\cdot_{\!A}\mrA\big)\ \cdot_{\!A}\ \big(\mrB\cdot_{\!A}\mrA\big)}
    {\subseteq}
    {\big(\mrB\cdot_{\!A}\mrA\big)\ \cdot_{\!A}\ \big(\mrA\cdot_{\!A}\mrA\big)}

\ceq{}
    {\subseteq}
    {\mrB\cdot_{\!A}\Big(\mrA\cdot_{\!A}\big(\mrA\cdot_{\!A}\mrA\big)\Big)}\hfill by the lemma above

\ceq{}{\subseteq}{\mrB\cdot_{\!A}\mrA}
% 
% The proof of the second claim is similar.
\end{proof}

We show that,
under the assumption of stationarity and independence,
there is a natural correspondence between the semigroup multiplication of two elements and the operation $\cdot_{\!A}$ between their orbits.


\begin{proposition}\label{prop_orbits_main}
Assume $\nonforkc_{\!A}$ is $1$-stationary,
see Definition~\ref{def_coheir_stationary}.Then for every ${\mr a}\nonforkc_{\!A}{\mr b}$ 

\ceq{\hfill\O({\mr a}{\cdot}{\mr b}/A)}{=}{\O({\mr a}/A)\cdot_{\!A}\O({\mr b}/A)}
\end{proposition}
\begin{proof} 
We prove two inclusions,
only the second one requires stationarity.

\begin{itemize}
\item[$\subseteq$] As ${\mr a}\nonforkc_{\!A}{\mr b}$ holds by hypothesis,
${\mr a}{\cdot}{\mr b}\in\O({\mr a}/A)\cdot_{\!A}\O({\mr b}/A)$.
Hence the inclusion follows by invariance.

\item[$\supseteq$] By invariance it suffices to show the l.h.s.\@ contains ${\mr a}\cdot_{\!A}\O({\mr b}/A)$.
Let ${\mr b'}\in\O({\mr b}/A)$ be such that ${\mr a}\nonforkc_{\!A}{\mr b'}$.
We claim that ${\mr a}{\cdot}{\mr b'}\in\O({\mr a}{\cdot}{\mr b}/A)$.
Both ${\mr b}$ and ${\mr b'}$ satisfy ${\mr a}\nonforkc_{\!A}{\mr x}\equiv_A{\mr b}$.
By $1$-stationarity,
${\mr b'}\equiv_{A,\,{\mr a}}{\mr b}$.
Hence ${\mr a}{\cdot}{\mr b}\equiv_A{\mr a}{\cdot}{\mr b'}$ which proves the claim.
\end{itemize}\vskip-1.2\baselineskip
\end{proof}

\begin{corollary}[(associativity)]\label{corol_orbits_associative}
Let $M$ be a model and assume $\nonforkc_{\!M}$ is $1$-stationary.
Then for every $M$-invariant sets $\mrA$,
$\mrB$ and  $\mrC$.

\ceq{\hfill\big(\mrA\cdot_{\!M}\mrB\big)\cdot_{\!M}\mrC}
{=}
{\mrA\cdot_{\!M}\big(\mrB\cdot_{\!M}\mrC\big)}
\end{corollary}

\begin{proof}
We can assume that $\mrA$, $\mrB$ and $\mrC$ are $M$-orbits of elements of $\mrU$.
Say ${\mr a}$, ${\mr b}$, and ${\mr c}$ respectively.
As we are working over models,
we can assume that ${\mr a}\nonforkc_{\!A}{\mr b}$ and ${\mr a}{\cdot}{\mr b}\nonforkc_{\!A}{\mr c}$.
By Proposition~\ref{prop_orbits_main} the set on the l.h.s.\@ equals $\O({\mr a}{\cdot}{\mr b}{\cdot}{\mr c}/M)$.
By a similar argument the set on the r.h.s.\@ equals $\O({\mr a'}{\cdot}{\mr b'}{\cdot}{\mr c'}/M)$ for some elements ${\mr a'}$, ${\mr b'}$, and ${\mr c'}$.
Proposition~\ref{prop_semi_associative} proves that inclusion $\subseteq$ holds in general.
But inclusion between orbits amounts to equality.
\end{proof}

\begin{lemma}\label{lem_Hindman}
Let $M$ be a model and assume $\nonforkc_{\!M}$ is $1$-stationary.
If $\mrA$ is minimal among the  $M$-invariant,
idempotent,
type-definable sets then $\mrA=\O({\mr a}/M)$ for some element ${\mr a}$.
\end{lemma}
\begin{proof}
By Corollary~\ref{corol_min_idempotent},
for every ${\mr a}\in\mrA$ the set $\O({\mr a}/M)\cdot_{\!M}\mrA$ is idempotent.
It is also type-definable and contained in $\mrA$,
therefore by minimality $\O({\mr a}/M)\cdot_{\!M}\mrA=\mrA$.
Then there is a ${\mr b}\in\mrA$ such that ${\mr a}\nonforkc_M{\mr b}$ and ${\mr a}{\cdot}{\mr b}={\mr a}$.
By associativity, the set $\O({\mr a}/M)\cdot_{\!M}\O({\mr b}/M)$ is idempotent.
By Corollary~\ref{corol_orbits_associative},
it coincides with $\O({\mr a}/M)$.
The theorem follows by minimality.
\end{proof}
\end{comment}

\section{Indempotent orbits in semigroups}\label{semigroups}

\def\medrel#1{\parbox[t]{6ex}{$\displaystyle\hfil #1$}}
\def\ceq#1#2#3{\parbox[t]{22ex}{$\displaystyle #1$}\medrel{#2}{$\displaystyle #3$}}

In this and the following sections we focus on semigroups definable in a first-order structure.
For a lighter notation, we identify our semigroup with $\mrU$,
which here denotes the domain of a sort in a many-sorted monster model.
The language contains, among others,
the symbol \emph{$\ \cdot\ $} which is interpreted as a binary associative operation on $\mrU$.

We fix a set of parameters $A$,
not necessarily all of the same sort.
For any two sets $\mrA,\mrB\subseteq\mrU$ we define

\ceq{\hfill\emph{$\mrA\cdot_{\!A}\mrB$}}
{=}
{\Big\{ {\mr a}{\cdot}{\mr b}\ :\ {\mr a}\in\mrA, \ {\mr b}\in\mrB\textrm{ and }\ {\mr a}\cnonfork_{\!A}{\mr b}\Big\}}

In this and the next section we abbreviate $\O({\mr a}/A)$, 
the orbit of ${\mr a}$ under $\Aut(\mrU/A)$, 
with \emph{${\mr a}_A$}.
We write \emph{${\mr a}\cdot_{\!A}\mrB$} for $\O({\mr a}/A)\cdot_{\!A}\mrB$.
Similarly for \emph{$\mrA\cdot_{\!A}{\mr b}$} 
and \emph{${\mr a}\cdot_{\!A}{\mr b}$}.

By the invariance of $\cnonfork_{\!A}$,
for every $f\in\Aut(\mrU/A)$ we have $f[\mrA\cdot_{\!A}\mrB]=f[\mrA]\cdot_{\!A}f[\mrB]$.
Therefore when $\mrA$ and $\mrB$ are invariant over $A$,
also $\mrA\cdot_{\!A}\mrB$ is invariant over $A$.
Below we mainly deal with invariant sets.

\begin{proposition}\label{prop_semi_associative}
For every $A$-invariant sets $\mrA$, $\mrB$, and  $\mrC$.

\ceq{\hfill\mrA\cdot_{\!A}\big(\mrB\cdot_{\!A}\mrC\big)}
{\subseteq}
{\big(\mrA\cdot_{\!A}\mrB\big)\cdot_{\!A}\mrC}
\end{proposition}
\begin{proof}
Let ${\mr a}{\cdot}{\mr b}{\cdot}{\mr c}$ be an arbitrary element of the l.h.s.\@ for some ${\mr a}\cnonfork_{\!A}{\mr b}{\cdot}{\mr c}$ and ${\mr b}\cnonfork_{\!A}{\mr c}$.
By extension (Lemma~\ref{lem_coheir_independence}),
there exists ${\mr a'}$ such that 
${\mr a'}\equiv_{A,\,{\mr b}{\cdot}{\mr c}}{\mr a}\nonforkc_{\!A}{\mr b}{\cdot}{\mr c},\,{\mr a},\,{\mr c}$.
By transitivity (again Lemma~\ref{lem_coheir_independence}),
${\mr a'}{\cdot}{\mr b}\cnonfork_{\!A}{\mr c}$.
Therefore ${\mr a'}{\cdot}{\mr b}{\cdot}{\mr c}$ belongs to the r.h.s.
Finally,
as ${\mr a'}\equiv_{A,\,{\mr b}{\cdot}{\mr c}}{\mr a}$,
also ${\mr a}{\cdot}{\mr b}{\cdot}{\mr c}$ belongs to the r.h.s.\@ by invariance.
\end{proof}

Let $\mrA$ be a non empty set.
When $\mrA\cdot_{\!A}\mrA\subseteq\mrA$, we say that it is \emph{idempotent\/} (over $A$).

\begin{corollary}\label{corol_min_idempotent}
Assume $\mrB\subseteq\mrA$ are both $A$-invariant.
Then if $\mrA$ is idempotent,
also $\mrA\cdot_{\!A}\mrB$ is idempotent.
% Similarly,
% if $\mrA$ is a left-ideal,
% also  $\mrA\cdot_{\!A}\mrB$ is a left-ideal.
\end{corollary}
\begin{proof}
We check that if $\mrA$ is idempotent so is $\mrA\cdot_{\!A}\mrB$

\ceq{\hfill\big(\mrA\cdot_{\!A}\mrB\big)\ \cdot_{\!A}\ \big(\mrA\cdot_{\!A}\mrB\big)}
    {\subseteq}
    {\mrA\ \cdot_{\!A}\ \big(\mrA\cdot_{\!A}\mrB\big)}\hfill because $\mrA\cdot_{\!A}\mrB\subseteq\mrA$

\ceq{}
    {\subseteq}
    {\big(\mrA\cdot_{\!A}\mrA\big)\cdot_{\!A}\mrB}\hfill by the lemma above

\ceq{}{\subseteq}{\mrA\cdot_{\!A}\mrB}
\end{proof}

We show that, under the assumption of stationarity,
the operation $\cdot_{\!A}$ is a associative.
The quotient map $\mrU\to\mrU/{\equiv_A}$ fails short of being a homeomorphism.


\begin{proposition}\label{prop_orbits_main}
Assume $\nonforkc_{\!A}$ is $1$-stationary,
see Definition~\ref{def_coheir_stationary}.
Fix ${\mr a}\cnonfork_{\!A}{\mr b}$ arbitrarily.
Then ${\mr a'}{\cdot}{\mr b'}\equiv_A{\mr a}{\cdot}{\mr b}$ for every ${\mr a'}\equiv_A{\mr a}$ and  ${\mr b'}\equiv_A{\mr b}$. Or, in other words,

\ceq{\hfill({\mr a}{\cdot}{\mr b})_A}{=}{{\mr a}\cdot_{\!A}{\mr b}.}
\end{proposition}
\begin{proof} 
We prove two inclusions,
only the second one requires stationarity.

\begin{itemize}
\item[$\subseteq$] As ${\mr a}\cnonfork_{\!A}{\mr b}$ holds by hypothesis,
${\mr a}{\cdot}{\mr b}\in{\mr a}\cdot_{\!A}{\mr b}$.
Hence the inclusion follows by invariance.

\item[$\supseteq$] By invariance it suffices to show that 
the l.h.s.\@ contains ${\mr a}\cdot_{\!A}\{{\mr b}\}$.
By extension (Lemma~\ref{lem_coheir_independence}), there is ${\mr a'}\in{\mr a}_A$ be such that ${\mr a'}\cnonfork_{\!A}{\mr b}$.
We claim that ${\mr a'}{\cdot}{\mr b}\in({\mr a}{\cdot}{\mr b})_A$.
Both ${\mr a}$ and ${\mr a'}$ satisfy ${\mr a}\equiv_A{\mr x}\cnonfork_{\!A}{\mr b}$.
By $1$-stationarity,
${\mr a}\equiv_{A,\,{\mr b}}{\mr a'}$.
Hence ${\mr a}{\cdot}{\mr b}\equiv_A{\mr a'}{\cdot}{\mr b}$ which proves the claim.
\end{itemize}\vskip-1.2\baselineskip
\end{proof}

\begin{corollary}[(associativity)]\label{corol_orbits_associative}
Let $M$ be a model and assume $\nonforkc_{\!M}$ is $1$-stationary.
Then for every $M$-invariant sets $\mrA$,
$\mrB$ and  $\mrC$.

\ceq{\hfill\mrA\cdot_{\!M}\big(\mrB\cdot_{\!M}\mrC\big)}
{=}
{\big(\mrA\cdot_{\!M}\mrB\big)\cdot_{\!M}\mrC}
\end{corollary}

\begin{proof}
We can assume that $\mrA$, $\mrB$ and $\mrC$ are $M$-orbits of elements of $\mrU$.
Say ${\mr a}$, ${\mr b}$, and ${\mr c}$ respectively.
As we are working over models,
we can assume that ${\mr a}\cnonfork_M{\mr b}{\cdot}{\mr c}$ and ${\mr b}\cnonfork_M{\mr c}$.
By Proposition~\ref{prop_orbits_main} the set on the l.h.s.\@ equals $({\mr a}{\cdot}{\mr b}{\cdot}{\mr c})_M$.
By a similar argument the set on the r.h.s.\@ equals $({\mr a'}{\cdot}{\mr b'}{\cdot}{\mr c'})_M$ for some elements ${\mr a'}$, ${\mr b'}$, and ${\mr c'}$.
Proposition~\ref{prop_semi_associative} proves that inclusion $\subseteq$ holds in general.
But inclusion between orbits amounts to equality.
\end{proof}

\begin{lemma}\label{lem_Hindman}
Let $M$ be a model and assume $\nonforkc_{\!M}$ is $1$-stationary.
If $\mrA$ is minimal among the
idempotent sets that are
type-definable over $M$, then $\mrA=\O({\mr b}/M)$ for some (any) element ${\mr b}\in\mrA$.
\end{lemma}
\begin{proof}
By Corollary~\ref{corol_min_idempotent},
for every ${\mr b}\in\mrA$ the set $\mrA\cdot_{\!M}{\mr b}$ is idempotent.
It is also type-definable and contained in $\mrA$,
therefore by minimality $\mrA\cdot_{\!M}{\mr b}=\mrA$.
Then there is a ${\mr a}\in\mrA$ such that ${\mr a}\cnonfork_M{\mr b}$ and ${\mr a}{\cdot}{\mr b}={\mr b}$.
By associativity, the set ${\mr a}\cdot_{\!M}{\mr b}$ is idempotent.
By Corollary~\ref{corol_orbits_associative},
it coincides with $({\mr a}{\cdot}{\mr b})_M={\mr b}_M$.
The theorem follows by minimality.
\end{proof}

\begin{corollary}\label{corol_idempotent}
Under the same assumptions of the lemma above, every type-definable idempotent set contains an element with an idempotent orbit.\QED
\end{corollary}

\section{Hindman theorem}\label{Hindman}

\def\dotgt{\ooalign{$>$\cr$\cdot$\cr}}
\def\dotlt{\ooalign{$\kern1ex\cdot$\cr$<$\cr}}
\def\dotcl{ {\rm cl}^{\hbox{\scriptsize\dotlt}} }
% \def\dotcl{\ooalign{{\rm cl}\cr{\raisebox{1ex}{\hbox{\scriptsize\dotlt}}}\cr} }

Here the theory of idempotents presented in Section~\ref{semigroups} is merged with 
the proof of Ramsey's theorem to obtain Hindman's theorem in a straightforward way.

Let $<$ be a transitive relation on a semigroup $\mrU$.
We say that $<$ is \emph{upward directed\/} 
if for every ${\mr a},{\mr b}$ there is ${\mr c}$ such that ${\mr a},{\mr b}<{\mr c}$. 
A set $\mrA\subseteq\mrU$ is \emph{\dotlt-closed\/} 
if ${\mr a}{\cdot}{\mr b}\in\mrA$ 
for every ${\mr a},{\mr b}\in\mrA$ such that ${\mr a}<{\mr b}$.
A set $\mrA\subseteq\mrU$ is \emph{cofinal\/} 
if for every ${\mr a}\in\mrU$ there is ${\mr b}\in\mrA$ such that ${\mr a}<{\mr b}$. 

For $A\subseteq\mrU$ we write

\ceq{\hfill\emph{$\dotcl(A)$}}{=}{\Big\{{\mr a_1}\kern-0.5ex\cdot\dots\cdot{\mr a_n}\ :\ \textrm{ for }{\mr a_1}<\dots<{\mr a_n} \textrm{ in } A\Big\}}.

The main result of this section is the following generalization of the theorem of Hindman. 

% Let $G$ be an infinite semigroup
% and let ${\mr\bar a}\in G^{\le\omega}$.
% We write $\fp_n({\mr\bar a})$ for the sets of products of $n$ elements of ${\mr\bar a}$ taken in increasing order.
% Namely,
% 
% \ceq{\hfill\emph{$\fp_n({\mr\bar a})$}}{=}{\Big\{{\mr a_{i_1}}\kern-0.5ex\cdot\dots\cdot{\mr a_{i_m}}\ :\quad i_1<\dots<i_m<|\bar a|,\ \ m\le n\Big\}}.
% 
% We agree that when ${\mr\bar a}$ is the empty tuple then $\fp_n({\mr\bar a})=\0$.
% Finally we define
% 
% \ceq{\hfill\emph{$\fp({\mr\bar a})$}}{=}{\bigcup_{n\in\omega}\fp_n({\mr\bar a})}.
% 
% This section is dedicated to the proof of the following theorem.

\theoremstyle{mio}
\newtheorem{Hindman}[thm]{Hindman Theorem}
\begin{Hindman}\label{thm_Hindman}
Let $G$ be an infinite semigroup and 
let $<$ be a transitive upward directed relation on $G$.
Then for every finite coloring of $G$ 
there is an infinite monochromatic \dotlt-closed $A\subseteq G$.
\end{Hindman}

Note that this implies that every commutative semigroup $G$ has an infinite monochromatic subset $B$ closed under finite sums of distinct elements (well-order $G$ and take $B\subseteq A$ such that $B,<\,\simeq\,\omega,<\,$).

Our proof follows closely the proof of Ramsey's theorem~\ref{thm_Ramsey}.
The novelty is all in Lemma~\ref{lem_Hindman}.


\begin{proof}
We interpret $G$ as a structure in a language $L$ 
that extends the language of multiplicative groups 
with a symbol for $<$ and for each subset of $G$.
Let $\U$ be a saturated elementary superstucture of $G$.
As observed in Remark~\ref{rk_coheir_stationary}, 
the language makes $\nonforkc_G$ trivially $1$-stationary.

We write ${\mr\Aa}$ for the type-definable set $\{{\mr x} : G<{\mr x}\}$ which is non empty because $<$ is upward directed.

We claim that ${\mr\Aa}$ is idempotent. 
In fact, if ${\mr a},{\mr b}\in{\mr\Aa}$ and ${\mr a}\cnonfork_G{\mr b}$ 
then, as $G<{\mr a},{\mr b}$, we must have that ${\mr a}<{\mr b}$. 
Therefore, from the \dotlt-closure of $\mrA$ we infer ${\mr a}{\cdot}{\mr b}\in{\mr\Aa}$.

Let ${\mr c}$ be an element of $\mrA$ with idempotent orbit as given by Corollary~\ref{corol_idempotent}.
Let $p({\mr x})\in S(\U)$ be a global coheir of $\tp({\mr c}/G)$.
Let ${\mr\bar c}$ be a tuple such that

\ceq{\hfill {\mr c_i}}{\models}{p_{\restriction G,\,\dotcl({\mr c_{\restriction i} } ) }({\mr x}).}

In particular, ${\mr\bar c}$ is a coheir sequence. 
By the idempotency of ${\mr c}_G$ and Proposition~\ref{prop_orbits_main}, 
${\mr a}\equiv_G{\mr c}$ for all ${\mr a}\in \dotcl({\mr\bar c})$.
It follows in particular that $\dotcl({\mr\bar c})$ is monochromatic, say \textit{red}.
Now, we use the sequence ${\mr\bar c}$ to define ${\mr\bar a}\in G^\omega$
such that $\dotcl({\mr\bar a})$ is red.

Assume as induction hypothesis that $\dotcl({\mr a_{\restriction i}},\,{\mr\bar c})$ is red.
Our goal is to find ${\mr a_i}$ such that the same property holds for ${\mr a_{\restriction i+1}},\,{\mr\bar c}$.

Let $\phi({\mr a_{\restriction i}},\,{\mr c_i},\,{\mr c_{\restriction i}})$ 
be the sentence that says that 
$\dotcl({\mr a_{\restriction i}},\,{\mr c_i},\,{\mr c_{\restriction i}})$ is red.
As ${\mr\bar c}$ is a coheir sequence we can find  ${\mr a_i}$ 
such that $\phi({\mr a_{\restriction i}},\,{\mr a_i},\,{\mr c_{\restriction i}})$.
Hence $\dotcl({\mr a_{\restriction i+1}},\,{\mr c_{\restriction i}})$ is red.
As ${\mr\bar c}$ is indiscernible over $G$, 
this is equivalent to $\dotcl({\mr a_{\restriction i+1}},\,{\mr\bar c})$ being red.
\end{proof}


\section{Hales-Jewett Theorem}

Hales-Juvett's theorem is a purely combinatorial statement that implies van der Waerden's theorem.

We need a few definitions. 
Let $\mrW$ be an idempotent set that is type-definable over $A$.
We say that a set $\mrA\subseteq\mrW$ is a \emph{left-ideal\/} in $\mrW$ if $\mrW\cdot_{\!A}\mrA\subseteq\mrA$.
We say that an element ${\mr a}$ is \emph{left-minimal\/} in $\mrW$ if 
${\mr a}\in\mrW\cdot_{\!A}{\mr b}$ for every ${\mr b}\in\mrW\cdot_{\!A}{\mr a}$.
In other words, ${\mr a}$ is left-minimal 
if $\mrW\cdot_{\!A}{\mr a}$, i.e.\@ the left-ideal generated by the orbit of ${\mr a}$, is minimal among the type-definable left-ideals.
The ambient set $\mrW$ and the set of parameters $A$ are often implicit in the context.

\begin{proposition}\label{prop_minimal_existence1}
Every invariant left-ideal contains a left-minimal element with idempotent orbit.
\end{proposition}
\begin{proof}
Let $\mrA\subseteq\mrW$ be left-ideal invariant over $A$.
For every ${\mr b}\in\mrA$ the left-ideal $\mrW\cdot_{\!A}{\mr b}\subseteq\mrA$ is type-definable over $A$. 
By compacteness we can require that it is minimal. 
As ${\mr b}\cdot_{\!A}\mrW$ is clearly idempotent, by Corollary~\ref{corol_idempotent} it contains an element ${\mr a}$ with idempotent orbit. Therefore ${\mr a}$ is the required left-minimal element.
\end{proof}

\begin{proposition}\label{prop_minimal_existence2}
Let $M$ be a model and assume $\nonforkc_{\!M}$ is $1$-stationary.
Let ${\mr a}$ have idempotent orbit. 
Then 
\begin{itemize}
\item[1.] $\big({\mr a}\cdot_M\mrW\big)\cap\big(\mrW\cdot_M{\mr a}\big)$ 
contains some ${\mr b}$ with idempotent orbit;
\item[2.] moreover, if ${\mr a}$ is left-minimal, ${\mr a}\equiv_M{\mr b}$ for every ${\mr b}$ as in \ssf{1}.
\end{itemize}
\end{proposition}
\begin{proof} 
Note, parenthetically, that the set in \ssf{1} may not be type-definable, 
therefore Corollary~\ref{corol_idempotent} does not apply 
directly and we need an indirect argument.
\begin{itemize}
\item[1.] Pick ${\mr c}\in\mrW\cdot_M{\mr a}$ with idempotent orbit.
Such ${\mr c}$ exists by Corollary~\ref{corol_idempotent}.
From the idempotency of ${\mr a}_M$ we obtain ${\mr c}\in{\mr c}\cdot_M{\mr a}$. 
% From the left-minimality of ${\mr a}$ we infer that ${\mr a}\in{\mr c}\cdot_M\mrW$ 
% and, by the idempotency of ${\mr c}_M$, that ${\mr a}_M={\mr c}\cdot_M{\mr a}$.
Now it is immediate to verify that any ${\mr b}\in{\mr a}\cdot_M{\mr c}\cdot_M{\mr a}$ is as required by \ssf{1}.
\item[2.] From ${\mr b}\in{\mr a}\cdot_M\mrW$ and idempotency of ${\mr a}_M$ 
we obtain ${\mr b}_M={\mr a}\cdot_M{\mr b}$. 
From the left-minimality of ${\mr a}_M$ we infer that ${\mr a}\in\mrW\cdot_M{\mr b}$. Hence ${\mr a}_M={\mr a}\cdot_M{\mr b}$, by the idempotency of ${\mr b}$. Therefore ${\mr a}_M={\mr b}_M$, which proves \ssf{2}.
\end{itemize}\vskip-1.2\baselineskip
\end{proof}

The following is a technical lemma that is required for the proof of the main theorem.

\begin{proposition}\label{prop_HJ_tecnical}
Let $M$ be a model and assume $\nonforkc_{\!M}$ is $1$-stationary.
Let $\sigma:\mrV\to\mrU$ be a definable semigroup homomorphism.
Then 
\begin{itemize}
\item[1.] $\sigma\big[{\mr a}_M\big]=(\sigma\,{\mr a})_M$

\item[2.]
$\sigma\big[{\mr a}\cdot_M{\mr b}\big]=\sigma\,{\mr a}\cdot_M\sigma\,{\mr b}$.
\end{itemize}
\end{proposition}
\begin{proof}\ \ssf{1.}  
As ${\mr a}\equiv_M{\mr a'}$ implies $\sigma\,{\mr a}\equiv_M\sigma\,{\mr a'}$,
inclusion $\subseteq$ is clear. 
For the converse, note that the type 
$\E{\mr y}\,\big[\sigma\,{\mr y}={\mr x}\,\wedge\,{\mr y}\equiv_M{\mr a}\big]$ 
is trivially realized by $\sigma\,{\mr a}$.
By invariance it is equivalent to a type over $A$.
Therefore it is realized by all elements of $(\sigma\,{\mr a})_M$.
Hence all elements of $(\sigma\,{\mr a})_M$ are the image of some element in ${\mr a}_M$.

\def\medrel#1{\parbox[t]{6ex}{$\displaystyle\hfil #1$}}
\def\ceq#1#2#3{\parbox[t]{39ex}{$\displaystyle #1$}\medrel{#2}{$\displaystyle #3$}}
\ssf{2.} \  
We have to prove the following equality\smallskip

\ceq{\hfill\Big\{\sigma({\mr a'}{\cdot}{\mr b'})\ :\ {\mr a}\equiv_M{\mr a'}\cnonfork_M{\mr b'}\equiv_M{\mr b} \Big\}}
{=}
{\Big\{{\mr a'}{\cdot}{\mr b'}\ :\ \sigma\,{\mr a}\equiv_M{\mr a'}\cnonfork_M{\mr b'}\equiv_M\sigma\,{\mr b} \Big\}.}\smallskip

It suffices to prove one inclusion because by Proposition~\ref{prop_orbits_main} both sides are orbits. 
We prove $\subseteq$. 
Note that ${\mr a'}\cnonfork_M{\mr b'}$ implies $\sigma\,{\mr a'}\cnonfork_M\sigma\,{\mr b'}$.
Hence the set on l.h.s.\@ is contained in the following\smallskip

\hfil$\Big\{\sigma({\mr a'}{\cdot}{\mr b'})\ :\ \sigma\,{\mr a'}\cnonfork_M\sigma\,{\mr b'},\ {\mr a'}\equiv_M{\mr a},\  {\mr b'}\equiv_M{\mr b} \Big\}$.\smallskip

which is in turn contained in the set on the r.h.s.
\end{proof}


We present two versions of the main theorem.
First we prove an abstract algebraic version due to Sabine Koppelberg which is easier to state and to prove~\cite{Koppelberg}.
Let $G$ be a semigroup.
A \emph{nice subsemigroup\/} of $G$ is a subsemigroup $C$ with the property that if ${\mr a}{\cdot}{\mr b}\in C$ then both ${\mr a},{\mr b}\in C$.


\theoremstyle{mio}
\newtheorem{HalesJewett}[thm]{Hales-Jewett Theorem}
\begin{HalesJewett}[(algebraic version)]\label{thm_abstract_HJ}
Let $G$ be a semigroup and let $C\subset G$ be a nice subsemigroup.
Let $\Sigma$ be a finite set of retractions of $G$ to $C$, that is, 
homomorphisms $\sigma:G\to C$ such that $\sigma_{\restriction C}={\rm id}_C$.
Then, for every finite coloring of $C$,
there is a ${\mr g}\in G\sm C$ such that $\{\sigma\,{\mr g}:\sigma\in\Sigma\}$ is monochromatic.
\end{HalesJewett}

\begin{proof}
Let $G\preceq\mrV$.
Here $\mrV$ is a monster model in a language that contains 
a symbol for multiplication and for all subsets of $G$.
As observed in Remark~\ref{rk_coheir_stationary}, 
this makes $\nonforkc_G$ trivially $1$-stationary.
Let $\mrU$ be the definable set such that $C=G\cap\mrU$.
By elementarity, $\mrU$ is a nice subsemigroup of $\mrV$.
The language contains also symbols for 
the retractions $\sigma:\mrV\to\mrU$.

Let ${\mr a}\in\mrU$ be left-minimal with idempotent orbit over $G$.
Such ${\mr a}$ exists by  Proposition~\ref{prop_minimal_existence1}.

Now we move to $\mrV$ as ambient semigroup.
By claim \ssf{1} in Proposition~\ref{prop_minimal_existence2}
there is a ${\mr b}\in\big({\mr a}\cdot_G\mrV\big)\cap\big(\mrV\cdot_G{\mr a}\big)$ 
with idempotent orbit.
We can further require that ${\mr b}\in\mrV\sm\mrU$: in the proof of claim \ssf{1}, with $\mrV$ for $\mrU$, 
by nicety we can choose ${\mr c}\in\mrV\sm\mrU$.
Now, from ${\mr b}\in\big({\mr a}\cdot_G\mrV\big)\cap\big(\mrV\cdot_G{\mr a}\big)$
and Proposition~\ref{prop_HJ_tecnical}, we obtain 
$\sigma\,{\mr b}\in\big({\mr a}\cdot_G\mrU\big)\cap\big(\mrU\cdot_G{\mr a}\big)$
for all $\sigma\in\Sigma$.
As $\sigma\,{\mr b}$ is also idempotent, 
we apply Proposition~\ref{prop_minimal_existence2} to conclude that 
$\sigma\,{\mr b}\equiv_G{\mr a}$.
In particular the set $\{\sigma\,{\mr b}:\sigma\in\Sigma\}$ is monochromatic. 

Though the element ${\mr b}$ above need not belong to $G\sm C$,
by elementarity $G\sm C$ contains some ${\mr g}$ with the same property and this proves the theorem.
\end{proof}

Finally we show how the classical Hales-Jewett's theorem follows from its abstract version.


\begin{HalesJewett}\label{thm_HalesJewett}
Let $C$ be an infinite semigroup.
Fix a tuple of variable $x$ and let $F\subseteq C^{|x|}$ be a finite set.
Fix also a finite coloring of $C$.
Then there is a non constant term $t(x)$ 
of the language of semigroups with parameters in $C$
such that $\{ t(a): a\in F\}$ is monochromatic.
\end{HalesJewett}

\begin{proof}
Let $G$ be the set of terms $t(x)$ in the language of semigroups 
with parameters in $C$ and free variables in $x$.
Then $G$ is a semigroup under the natural operation.
For every $a\in C^{|x|}$ the map $\sigma_a:t(x)\mapsto t(a)$ is a retraction.
Hence we can apply the theorem above.
\end{proof}


\section{Notes and references}

The original proof of the Hales-Jewett Theorem by Alfred Hales and Robert Jewett is combinatorial~\cite{HJ}.
An alternative proof, also combinatorial, has been given by Sheron Shelah~\cite{Shelah}.
Our proof uses tools similar to those introduced by Andreas Blass in~\cite{Blass},
but we use saturated models where he uses Stone-Check compactification.


\begin{biblist}[]\normalsize

\bib{Blass}{article}{
   author={Blass, Andreas},
   title={Ultrafilters: where topological dynamics $=$ algebra $=$
   combinatorics},
   journal={Topology Proc.},
   volume={18},
   date={1993},
   pages={33--56},
   note={Also \href{http://de.arxiv.org/abs/math/9309208}{arXiv:math/9309208}}
}

\bib{Hindman}{article}{
   author={Hindman, Neil},
   title={Finite sums from sequences within cells of a partition of $N$},
   journal={J. Combinatorial Theory Ser. A},
   volume={17},
   date={1974},
   pages={1--11},
}

\bib{HJ}{article}{
   author={Hales, A. W.},
   author={Jewett, R. I.},
   title={Regularity and positional games},
   journal={Trans. Amer. Math. Soc.},
   volume={106},
   date={1963},
   pages={222--229},
}

\bib{Koppelberg}{article}{
   author={Koppelberg, Sabine},
   title={The Hales-Jewett theorem via retractions},
   booktitle={Proceedings of the 18th Summer Conference on Topology and its
   Applications},
   journal={Topology Proc.},
   volume={28},
   date={2004},
   number={2},
   pages={595--601},
}

\bib{Shelah}{article}{
   author={Shelah, Saharon},
   title={Primitive recursive bounds for van der Waerden numbers},
   journal={J. Amer. Math. Soc.},
   volume={1},
   date={1988},
   number={3},
   pages={683--697},
}

\end{biblist}

\begin{comment}

\begin{proposition}
Let $G$ be a semigroup and let $C\subset G$ be a nice subsemigroup.
Let $\Sigma$ be a countable set of retractions of $G$ to $C$.
Then for every finite coloring of $C$ there is a ${\mr\bar g}\in (G\sm C)^\omega$ 
such that the sets 
$\fp \{\sigma({\mr g_{\restriction\,\omega\sm n}})\,:\,\sigma\in\Sigma_0 \}$ are all monochromatic, 
where $\Sigma_0\subseteq\Sigma$ are arbitrary finite sets 
and $n=n_{\Sigma_0}$.
\end{proposition}

Recall that $\sigma({\mr g_{\restriction\,\omega\sm n}})$ is the tuple $\<{\sigma(\mr g_{i+n} } ): i<\omega\>$. 
In the theorem above, we have stretched definition of $\fp(\mbox{-})$ and applied it to sets of tuples of equal length.
Precisely, we enhance the definition of $\fp_n(\mbox{-})$ as follows 

\ceq{\hfill\fp_n\{{\mr\bar g^j}\ :\ j\in J\} }{=}{\Big\{{\mr g^{j_1}_{i_1}}\kern-0.5ex\cdot\dots\cdot{\mr g^{j_n}_{i_n}}\ :\quad i_1<\dots<i_n<\alpha, \ \  j_1,\dots,j_n\in J\Big\}}.

Finally $\fp(\mbox{-})$ is defined as the union of the $\fp_n(\mbox{-})$.


\begin{proof}
Reasoning as in the proof of Theorem~\ref{thm_abstract_HJ}, 
and with the same notation,
we obtain an element ${\mr v}\in\mrV\sm\mrU$ with idempotent orbit 
and such that all $\sigma({\mr v})$ for $\sigma\in\Sigma$
have the same type over $G$.

Let $p({\mr x})\in S(\mrV)$ be a global coheir of $\tp({\mr v}/G)$ and let ${\mr\bar v}$ 
be a coheir sequence such that ${\mr v_i}\models p_{\restriction A_i }({\mr x})$ where 
$A_i=G\, \cup\, \fp\{\sigma({\mr v_{\restriction i}})\ :\ \sigma\in\Sigma \}$.

Now, we use the sequence ${\mr\bar v}$ to define the ${\mr\bar g}$ required by the theorem.
Assume $\Sigma=\{\sigma_i:i<\omega\}$. 
Assume as induction hypothesis that $\fp\{\sigma_i({\mr g_{\restriction i}},\,{\mr\bar c}) : i<n\}$ is monochromatic.
Our goal is to find ${\mr a_i}$ such as the same property holds for ${\mr a_{\restriction i}},\,{\mr a_i},\,{\mr\bar c}$.


Let $\phi({\mr a_{\restriction i}},\,{\mr c_i},\,{\mr c_{\restriction i}})$ be the sentence that says $\fp_{i+1}({\mr a_{\restriction i}},\,{\mr c_i},\,{\mr c_{\restriction i}})$ is monochromatic.
As ${\mr\bar c}$ is a coheir sequence we can find  ${\mr a_i}\in M$ such that $\phi({\mr a_{\restriction i}},\,{\mr a_i},\,{\mr c_{\restriction i}})$.
  Hence $\fp_{i+1}({\mr a_{\restriction i}},\,{\mr a_i},\,{\mr c_{\restriction i}})$ is monochromatic.
 As ${\mr\bar c}$ is indiscernible over $G$, this is equivalent to  $\fp({\mr a_{\restriction i}},\,{\mr a_i},\,{\mr\bar c})$.

\end{proof}

\section{Hales-Jewett + Hindman \ = \ Carlson}
 V. Bergelson, A. Blass, and N. Hindman, Partition theorems for spaces of variable words,
Proc. London Math. Soc. 68 (1994), 449-476. MR 95i:05107


\begin{theorem}
Let $G$ be a semigroups and let $C\subset G$ be a nice subsemigroup.
Fix a finite coloring of $G$ and ${\mr\bar g}\in G^\omega$.
Then there is a sequence of retractions $\sigma_i:G\to C$ and 
an increasing tuple ${\mr\bar s}\in\fp({\mr\bar g})^\omega$ such that
$\{\sigma_i({\mr s_i}):i<\omega\}$ is monochromatic disjoint of $C$..
\end{theorem}

% 
% \section{Crap (if this is publicly available, it's just by errror)}
% 
% \noindent\llap{\textcolor{red}{\Large\danger}\kern1.5ex}The following terminology in not standard.We say that the set $\mrB\subseteq\U^{|{\mr x}|}$, typically a definable set, is \emph{strongly quasi-invariant over $A$\/} if for every definable set $\mrD$ either $\mrB\cap\mrD$ or $\mrB\cap\neg\mrD$ is quasi-invariant.
% 
% \begin{proposition}If $\mrB$ is strongly quasi-invariant over $A$ and $\<{\mr\D_i}:i<n\>$ is a finite sequence of definable sets that covers $\mrB$, then $\mrB\cap{\mr\D_i}$ is strongly quasi-invariant over $A$ for some $i$.\QED
% \end{proposition}
% 
% We say that the type $p({\mr x})\subseteq L(\U)$ is \emph{strongly quasi-invariant over $A$\/} if $\phi({\mr\U})$ is strongly quasi-invariant over $A$ for every $\phi({\mr x})$ conjunction of formulas in $p({\mr x})$.% So, the type $p({\mr x})$ is quasi-invariant if the set $p({\mr\V})$ is invariant, where $\V$ is an large saturated extension of $\U$, see Exercise~\ref{ex_quasi_inv_type}.
% 
% \begin{proposition}
% Every strongly quasi-invariant type has an extension to a global strongly quasi-invariant type.
% \end{proposition}
% 
% \begin{proof}
% Let $q({\mr x})\subseteq L(\U)$ be a strongly quasi-invariant type and let  $p({\mr x})\subseteq L(\U)$ be a maximally consistent  strongly quasi-invariant type.We claim that $p({\mr x})$ is complete.If not, then there are some formulas $\phi({\mr x})\in L(\U)$ and  $\psi({\mr x})\in p$ such that $\psi({\mr x})\wedge\phi({\mr x})$ and $\psi({\mr x})\wedge\neg\phi({\mr x})$. This contradicts Proposition~\ref{}.
% \end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Product of types}\label{tipi_prodotto}


\begin{lemma}\label{lem_tensor}
Let $p({\mr x})\in S(\U)$ be a global type invariant over $A$.
Let ${\gr a}\equiv_A{\gr a'}$.
Then  ${\gr a},{\mr b}\equiv_A{\gr a'},{\mr b'}$ for all ${\mr b}\models p_{\restriction A,{\gr a}}({\mr x})$ and  ${\mr b'}\models p_{\restriction A,{\gr a'}}({\mr x})$.

\end{lemma}

\begin{proof}
Let $\phi({\mr x\,};{\gr z})\in L(A)$.
If $\phi({\mr b\,};{\gr a})$ then $\phi({\mr x\,};{\gr a})\in p$ and, by invariance, $\phi({\mr x\,};{\gr a'})\in p$.
As  ${\mr b'}\models p_{\restriction A,{\gr a'}}({\mr x})$, we obtain $\phi({\mr b'\,};{\gr a'})$.

\end{proof}

Lemma~\ref{lem_tensor} ensures that the definition below is well-defined, i.e.\@ that it does not depend on ${\gr a},{\mr b}$.



\begin{definition}\label{def_prodotto_tipi}
Let $p({\mr x})\in S(\U)$ be an $A$-invariant type.
For $q({\gr z})\in S(A)$ we define

\ceq{\hfill\mbox{\emph{$q(z)\otimes_{\!A} p({\mr x})$}}}{\deq}{\tp({\gr a\,};{\mr b}/A)}\quad for some ${\gr a}\models q({\gr z})$ and ${\mr b}\models p_{\restriction A,{\gr a}}({\mr x})$.

When $q({\gr z})\in S(\U)$, we define

\ceq{\hfill\mbox{\emph{$q(z)\otimes p({\mr x})$}}}{\deq}{\bigcup_{A\subseteq B}\ q_{\restriction B}(z)\otimes_B p({\mr x})}.\QED
\end{definition}

Note that $q({\gr z})\otimes p({\mr x})$ is consistent, and therefore a complete global type.
In fact, it is immediate to verify that if $A\subseteq B'\subseteq B''$ then $q_{\restriction B'}({\gr z})\otimes p({\mr x})\ \subseteq\ q_{\restriction B''}({\gr z})\otimes p({\mr x})$.


\begin{proposition}
Let $q({\gr z}), p({\mr x})\in S(\U)$ be $A$-invariant types.
Then $q(z)\otimes p({\mr x})$ is also $A$-invariant.
And if they are finitely satisfiable in $A$ then so is $q(z)\otimes p({\mr x})$.
\end{proposition}

\begin{proof}
Let $\phi(z,x,u)\in L(A)$.
Let $\phi(z,x,c)\in q(z)\otimes p({\mr x})$ and let $c'\equiv_Ac$.
Fix $a\models q_{\restriction A,c,c'}$ and $b\models p_{\restriction A,c,c',a}$.
From the invariance of $q$ we obtain $c\equiv_{A,a}c'$.
From the invariance of $p$ we obtain  $c\equiv_{A,a,b}c'$.
As $\phi(a,b,c)$ hold by the choice of $a$ and $b$, also $\phi(a,b,c')$ holds.
It follows that $\phi(z,x,c')\in q({\gr z})\otimes p({\mr x})$ which proves the invariance of $q({\gr z})\otimes p({\mr x})$.

Let $\phi(z,x)\in L(B)$ be a formula in $q(z)\otimes p({\mr x})$.
Let $a\models q_{\restriction B}(z)$.
Then $\phi(a,x)\in p$ and, by finite satisfiability, there is a $b'\in A^{|x|}$ such that $\phi(a,b')$.
Then $\phi(z,b')\in q$ and, by finite satisfiability $\phi(a',b')$ holds for some $a'\in A^{|z|}$.
\end{proof}





La seguente proposizione mostra che possiamo ragionevolmente parlare di tipo delle di Morley di $p$.
Questo paragrafo \`e dedicato alla descrizione sintattica di questo tipo.

\begin{proposition}\label{prop_tiposequenzaMorley}
Sia $p\in S_x(\U)$ un tipo globale $A\jj$invariante e supponiamo che $a$ e $b$ siano due sequenze di Morley di $p$ su $A$.
Allora $a\equiv_A c$.

\end{proposition}
\begin{proof}
%Possiamo assumere che $a=\<a_i:i<\omega\>$ e $\bar c=\<c_i:i<\omega\>$ abbiano lunghezza $\omega$.

Per indiscernibilit\`a, \`e sufficiente mostrare che $a_{\restriction i}\equiv_A{\mr c_{\restriction i}}$ per ogni $i<\omega$.
Ragioniamo per induzione, assumiamo l'equivalenza come ipotesi induttiva, fissiamo una formula $\phi(\bar x_{\restriction i},{\mr x})\in L(A)$ e dimostriamo che 

\ceq{\hfill \phi(a_{\restriction i},{\mr a_i})}{\iff}{\phi({\mr c_{\restriction i}},{\mr c_i})} 

Se $\phi(a_{\restriction i},{\mr a_i})$ allora $\phi(a_{\restriction i},{\mr x})\in p$.
Per l'ipotesi induttiva e per l'invarianza di $p$ otteniamo che anche  $\phi({\mr c_{\restriction i}},{\mr x})\in p$ e di qui $\phi({\mr c_{\restriction i}},{\mr c_i})$.
L'equivalenza segue per simmetria.
\end{proof}

Per poter semplificare la definizione~\ref{def_prodotto_tipi} abbiamo bisogno del seguente lemma tecnico:

\begin{lemma}\label{lemma_prodotto}
Dati $p({\mr x}), q(y)\in S(\U)$, e due insiemi $A_i$, per $i=0,1$ su cui $q(y)$ \`e invariante, fissiamo $\phi(x,y)\in L(A_0\cap A_1)$ e delle tuple $a_i,b_i$ tali che $a_i\models p_{\restriction A_i}$ e $b_i\models q_{\restriction A_i,a_i}$.
Allora $\phi(a_0,b_0)\iff\phi(a_1,b_1)$.
\end{lemma}
\begin{proof}
Supponiamo per cominciare che $A_0=A_1$ e denotiamo questo insieme con $A$.
Assumiamo $\phi(a_0,b_0)$ e quindi, per la completezza di $q$, che $\phi(a_0,y)\in q$.
Per la completezza di $p$  abbiamo che $a_0\equiv_Aa_1$.
Quindi, per l'invarianza di $q$ otteniamo $\phi(a_1,y)\in q$ e da questo segue $\phi(a_1,b_1)$.

Per concludere, consideriamo il caso $A_0\neq A_1$.
Sia $A=A_0\cup A_1$ e fissiamo $a_2\models  p_{\restriction A}$ e $b_2\models q_{\restriction A,a_2}(y)$.
Per quanto sopra dimostrato otteniamo $\phi(a_0,b_0)\iff\phi(a_2,b_2)$ ed anche $\phi(a_2,b_2)\iff\phi(a_1,b_1)$.
\end{proof}

Conviene immaginarsi questa operazione di prodotto come il passo induttivo per la costruzione di una sequenza di Morley.

\begin{definition}\label{def_prodotto_tipi}
Dati $p({\mr x}),q(y)\in S(\U)$ dove $q(y)$ \`e un tipo invariante, definiamo il prodotto di $p$ e $q$ come il tipo:

%\ceq{\hfill p({\mr x})\otimes q(y)}{=}{\Big\{\phi(x,y)\ :\ \phi(b,c) \textrm{ per qualche } a\models p_{\restriction A},\ b\models q_{\restriction A,a}(y) ed $A$ t\Big\}}

\ceq{\hfill\mbox{\emph{$p({\mr x})\otimes q(y)$}}}{=}{\Big\{\phi(x,y)\ :\ \textrm{esistono } a,b\ \models\ \phi(x,y)\ \wedge\ p_{\restriction A}({\mr x})\ \wedge\ q_{\restriction A,a}(y)\Big\}}

L'insieme $A$ nella definizione \`e uno qualsiasi che contiene i parametri di $\phi(x,y)$ e su cui $q(y)$ \`e invariante.
Il lemma~\ref{lemma_prodotto} assicura che la definizione non dipende dal particolare insieme scelto.\QED
\end{definition}

Il lemma~\ref{lemma_prodotto} ha anche la seguente importante conseguenza:

\begin{corollary}\label{cor_otimes_completo}
Se $p({\mr x}),q(y)\in S(\U)$ e $q(y)$ \`e invariante, allora $p({\mr x})\otimes q(y)$ \`e un tipo completo.
\end{corollary}

\begin{proof}
Sia $\phi(x,y)\in L(\U)$.
Fissiamo un insieme $A$ contenente i parametri di $\phi(x,y)$ e su cui $q(y)$ sia invariante.
Fissiamo $a,b$ arbitrari tali che $a\models p_{\restriction A}({\mr x})$ e $b\models q_{\restriction A,a}(y)$.
Dal lemma~\ref{lemma_prodotto} otteniamo che $\phi(x,y)\in p({\mr x})\otimes q(y)$ se e solo se $\phi(a,b)$.
\end{proof}


\begin{corollary}
Se $p({\mr x}),q(y)\in S(\U)$ sono tipi globali $A\jj$invarianti, allora anche $p({\mr x})\otimes q(y)$ \`e $A\jj$invariante.
\end{corollary}

\begin{proof}
Sia $\phi(x,y,z)\in L$, sia $c$ arbitrario tale che  $\phi(x,y,c)\in p({\mr x})\otimes q(y)$, e sia $c'\equiv_Ac$.
Fissiamo $a\models p_{\restriction A,c,c'}$.
Poich\'e $p$ \`e invariante su $A$, otteniamo $a,c\equiv_Aa,c'$.
Ora fissiamo un $b$ arbitrario tale che $b\models q_{\restriction A,c,c',a}$.
Per l'invarianza di $q$ su $A$ otteniamo  $a,b,c\equiv_Aa,b,c'$ e quindi $\phi(a,b,c')$.
Seque che $\phi(x,y,c)\in p({\mr x})\otimes q(y)$.
\end{proof}

\begin{proposition}
Se $p({\mr x}),q(y)\in S(\U)$ sono finitamente soddisfacibili su $A$, allora $p({\mr x})\otimes q(y)$ \`e finitamente soddisfacibile su $A$.
\end{proposition}

\begin{proof}
Sia $\phi(x,y)\in p({\mr x})\otimes q(y)$ arbitraria e fissiamo un $B$ contenente $A$ ed i parametri di $\phi(x,y)$.
Quindi esistono $a,b\models\phi(x,y)\,\wedge\,p_{\restriction B}({\mr x})\,\wedge\,q_{\restriction B,a}(y)$.
Allora $\phi(a,y)\in q$, e quindi $\phi(a,b')$ per un qualche $b'\in A$.
Allora $\phi(x,b')\in p$, e quindi $\phi(a',b')$ per qualche $a'\in A$.
\end{proof}


Dato $p({\mr x})\in S(\U)$ un tipo globale invariante.
Sia $\<x_i:i<\omega\>$ una sequenza di tuple di variabili con $|x|=|x_i|$.
Definiamo induttivamente

\ceq{\hfill p^{(1)}(x_0)}{=}{p(x_0)}; 

\ceq{\hfill p^{(n+1)}(x_0,\dots,x_n)}{=}{p^{(n)}(x_0,\dots,x_{n-1})\otimes p(x_n)};

\ceq{\hfill p^{(\omega)}(x_i:i<\omega)}{=}{\bigcup_{n<\omega}p^{(n+1)}(x_0,\dots, x_n)}.

La seguente proposizione giustifica la definizione di $p^{(\omega)}$, la dimostrazione \`e immediata.

\begin{proposition}\label{prop_p^omega_Morley}
Sia $p({\mr x})\in S(\U)$ un tipo globale $A\jj$invariante.
Allora le seguenti affermazioni sono equivalenti
\begin{itemize}
\item[1.]$\<c_i:i<\omega\>$ \`e una sequenze di Morley di $p$ su $A$;
\item[2.] $\<c_i:i<\omega\>\models p^{(\omega)}|_{\!A}$
\end{itemize}
\end{proposition}

La seguente proposizione torner\`a utile nei prossimi paragrafi, si osservi che  non \`e una conseguenza della proposizione~\ref{prop_p^omega_Morley} perch\'e qui l'invarianza su $A$ non \`e tra le ipotesi.

\begin{proposition}
Sia $p({\mr x})\in S(\U)$ un tipo globale invariante ed $A$ un insieme arbitrario.
Allora ogni $\<c_i:i<\omega\>\models p^{(\omega)}|_{\!A}$ \`e una sequenza di indiscernibili su $A$.
\end{proposition}


\begin{proof}
\`E sufficiente verificare che se $\<c_i:i<\omega\>\models p^{(\omega)}|_{\!A}$ allora $c_{i_0},\dots,c_{i_n}\models p^{(n+1)}|_{\!A}$ per ogni $i_0<\dots<i_n<\omega$.

\end{proof}
\end{comment}




\end{document}
