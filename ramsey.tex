% !TEX root = creche.tex
\chapter{Ramsey theory}
\label{ramsey}

In Section~\ref{Ramsey} we prove Ramsey's theorem and in Section~\ref{EM} we present its major application in model theory: 
the Ehrenfeucht-Mostowski construction of indiscernibles.

In the remaining sections we prove two important results of Ramsey theory.
These results will not be used elsewhere in these notes.
Our only purpose is to illustrate a concrete (relatively speaking) application of the notion of coheir.

\def\medrel#1{\parbox[t]{6ex}{$\displaystyle\hfil #1$}}
\def\ceq#1#2#3{\parbox[t]{12ex}{$\displaystyle #1$}\medrel{#2}{$\displaystyle #3$}}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Ramsey's theorem from coheir sequences}
\label{Ramsey}

In this chapter we are interested in finite partitions.
We may represent the partition of a set $X$ into $k$ subsets with a map $f:X\to (k]$.
The elements of $(k]=\{1,\dots,k\}$ are also called \emph{colors,}
and the partition a \emph{coloring,}
or \emph{$k$-coloring,} of $X$.
We say that $Y\subseteq X$ is \emph{monochromatic\/} if $f_{\restriction Y}$ is constant on $Y$.

Let $M$ be an arbitrary infinite set.
Fix $n,k<\omega$ and fix a coloring $f$ of the set of all \emph{$n$-subsets} of $M$,
also known as the \emph{complete $n$-uniform hypergraph\/} with vertex set $M$,

\ceq{\hfill f}{:}{ \binom{M}{n}=M^{(n)}\ \ \to\ \ (k]}.

We say that $H\subseteq M$ is a \emph{monochromatic set\/} if $f$ is constant on $H^{(n)}$.
In combinatorics, monochromatic sets are also called \emph{homogeneous sets.}

The following is a very famous theorem which we prove here in an unusual (and overly convoluted)  way.
Our purpose is to illustrate the method of proof of Theorem~\ref{thm_Hindman}.
In the latter the model theoretic overhead really pays off.

\theoremstyle{mio}
\newtheorem{Ramsey}[thm]{Ramsey Theorem}
\begin{Ramsey}\label{thm_Ramsey}
Let $M$ be an infinite set and fix some positive integers $n$ and $k$.
Fix an arbitrary $k$-coloring of $M^{(n)}$.
Then there is an infinite monochromatic set $H\subseteq M$.
\end{Ramsey}
\begin{proof}
Let $L$ be a language that contains $k$ relation symbols $r_1,\dots,r_k$ of arity $n$.
Given a $k$-coloring $f$ we define a structure with domain $M$.
The interpretation the relation symbol $r_i$ is

%\ceq{\hfill r_i^M}{=}{\Big\{ ({\mr a_0},\dots,a_{n-1})\ :\ |\{{\mr a_0},\dots,a_{n-1}\}|=n \ \textrm { e \ }f\big(\{{\mr a_0},\dots,a_{n-1}\}\big)= i\Big\}}

%\ceq{\hfill r_i^M}{=}{\Big\{ \<{\mr a_0},\dots,{\mr a_{n-1}}\>\ :\  \big|\big\{{\mr a_0},\dots,{\mr a_{n-1}}\big\}\big|=n \ \textrm { and \ }f\big(\big\{{\mr a_0},\dots,{\mr a_{n-1}}\big\}\big)= i\Big\}} 

\ceq{\hfill r_i^M}{=}{\Big\{  a\in M^n \ : \ |\range(a)|=n \ \textrm{ and } \ f\big(\range(a)\big)= i\Big\}.} 

We may assume that $M$ is an elementary substructure of some large saturated model $\U$.
Let $q({\mr x})$, where $|{\mr x}|=1$, be the type that says that ${\mr x}$ is not in $M$.
Let $p({\mr x})\in S(\U^{\mr x})$ be an extension of $q({\mr x})$ that is finitely satisfied in $M$.
Finally, let ${\mr\bar c}=\<{\mr c_i}:i<\omega\>$ be a coheir sequence of $p({\mr x})$ over $M$.

There is a first-order sentence saying that the formulas $r_i({\mr x_1},\dots,{\mr x_n})$ are a coloring of $M^{(n)}$.
Then by elementarity the same holds in $\U$.
By indiscernibility,
all tuples of $n$ distinct elements of ${\mr\bar c}$ have the same color, say $1$.

%\ceq{\ssf{\#}\hfill M}{\models}{\A {\mr x_0},\dots,{\mr x_{n-1}}\ \left[\bigwedge_{0\le i<j<n} {\mr x_i}\neq {\mr x_j}\quad\imp\quad\bigvee_{i<k}r_i({\mr x_0},\dots,{\mr x_{n-1}})\right].}

The theorem is proved if we can find in $M$ a sequence $\bar a=\<a_i:i<\omega\>$ with color $1$.
We construct $a_{\restriction i}$ by induction on $i$ as follows.

Assume as induction hypothesis that the subsequences of length $n$ of $a_{\restriction i},{\mr c_{\restriction n}}$ have all color $1$.
Our goal is to find $a_i\in M$ such that the same property holds for $a_{\restriction i},a_i,{\mr c_{\restriction n}}$.
By the indiscernibility of ${\mr\bar c}$,
the property holds for  $a_{\restriction i},{\mr c_{\restriction n}},{\mr{c_n}}$, and this can be written by a formula $\phi(a_{\restriction i},{\mr c_{\restriction n}},{\mr{c_n}})$.
As ${\mr\bar c}$ is a coheir sequence,
by Lemma~\ref{lem_coheir_property} we can find  $a_i\in M$ such that  $\phi(a_{\restriction i},{\mr c_{\restriction n}},a_i)$.
So,
as the order is irrelevant,
$a_{\restriction i},a_i,{\mr c_{\restriction n}}$ satisfies the induction hypothesis.
\end{proof}

% \begin{exercise}\label{ex_Ramsey_order}
%   Let $I,<_I$ be an linear order without largest element.
%   Let $f$ be a coloring of $I^{(n)}$.
%   Prove that there is a monochromatic subset $H\subseteq I$ that is ordered as $\omega$.
% \end{exercise}

\begin{exercise}
  Let $M$ be an arbitrary model.
  Let $\phi(x,y)\in L(M)$, where $|x|=|y|=1$.
  Prove that there is a sequence $\langle a_i:i<\omega\rangle$ in $M$ such that 

  \hfil$\phi(a_i,a_j)\iff\phi(a_h,a_k)$

  for every $i<j<\omega$ and $h<k<\omega$.
\end{exercise}

% \begin{exercise}\label{ex_Ramsey_random}
%     Let $M$ be a graph with the property that for every finite $A\subseteq M$ there is a $c\in M$ such that $A\subseteq r(c,\U)$. 
%     (This holds in particular when $M$ is a random graph.)
%     Prove that for every finite coloring of the edges of $M$, there is a subgraph that is complete and monochromatic.
% \end{exercise}

\begin{exercise} Let $M$ be a graph with the property that for every finite $A\subseteq M$ there is a $c\in M$ such that $A\subseteq r(c,\U)$. 
    A star in $M$ is a subgraph whose edges all share a common vertex. We say that a coloring of the edges of $M$ is locally finite if there is a $k$ such that every star has at most $k$ colors.
    Prove that for every locally finite coloring of the edges of $M$, there is an infinite monochromatic complete subgraph.
\end{exercise}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{The Ehrenfeucht-Mostowski theorem}\label{EM}

Let $I,<_I$ be an infinite linear order.
To minimize notation, we assume throughout the section that $I$ has no largest element.
It is immediate how to tweak the definition below so that it makes sense without this assumption.

Let ${\mr\bar a}$ be an $I$-sequence.
Fix a tuple of variables ${\mr\bar x}=\<{\mr x_i}: i<\omega\>$.
We write \emph{$p({\mr\bar x})\;=\;\textrm{{\small EM}-tp}({\mr\bar a}/A)$} and say that $p({\mr\bar x})$ is the \emph{Ehren\-feucht-Mostowski type\/} of ${\mr\bar a}$ over $A$ if

\ceq{\hfill p({\mr\bar x})}{=}{\Big\{\phi({\mr\bar x})\in L(A)\ :\ \phi({\mr a_{\restriction I_0}})\ \textrm{ holds for every }\ I_0\in I^{(\omega)}\Big\}.}

Where \emph{$I^{(\omega)}$\/} is the set of subsets of $I$ ordered as $\omega$.
As ${\mr\bar x}$ is of order-type $\omega$, the expression $\phi({\mr a_{\restriction I_0}})$ is sound.

Note that if ${\mr\bar a}$ is $A$-indiscernible then $\EMtp({\mr\bar a}/A)$ is a complete type,
and vice versa.

\begin{remark}
  Let $I,<_I$ and $J,<_J$ be infinite linear orders with no largest element.
  Let ${\mr\bar c}=\<{\mr c_i}:i\in I\>$ be a sequence of $A$-indiscernibles.
  By compactness, there is a sequence of $A$-indiscernibles ${\mr\bar a}=\<{\mr a_j}:j\in J\>$ such that $\EMtp({\mr\bar a}/A)=\EMtp({\mr\bar c}/A)$.
\end{remark}

% \theoremstyle{mio}
% \newtheorem{EhrenfeuchtMostowski}[thm]{Ehrenfeucht-Mostowski Theorem}
% \begin{EhrenfeuchtMostowski}\label{thm_EM}
% Let $I,<_I$ be an infinite linear order.
% Then for every sequence ${\mr\bar a}=\<{\mr a_i}:i\in I\>$ there is a sequence ${\mr\bar c}=\<{\mr c_i}:i<\omega\>$ of $A$-indiscernibles such that $\EMtp({\mr\bar a}/A)\subseteq\tp({\mr\bar c}/A)$.
% \end{EhrenfeuchtMostowski}

Finally, we can state the Ehrenfeucht-Mostowski theorem.

\begin{void}[Ehrenfeucht-Mostowski Theorem]\label{thm_EM}
  Let $I,<_I$ be an infinite linear order with no largest element.
  Then for every sequence ${\mr\bar a}=\<{\mr a_i}:i\in I\>$ there is an $A$-indiscernible sequence ${\mr\bar c}=\<{\mr c_i}:i<\omega\>$ such that $\EMtp({\mr\bar a}/A)\subseteq\tp({\mr\bar c}/A)$.  
\end{void}
\begin{proof}
Let $q({\mr\bar x})=\EMtp({\mr\bar a}/A)$.
Any realization of the following type is a sequence of $A$-indiscernibles ${\mr\bar c}$ as required by the theorem.

\ceq{\hfill q({\mr\bar x})}
{\cup}
{\Big\{\phi({\mr x_{\restriction I_0}})\iff\phi({\mr x_{\restriction J_0}})\ :\  \phi({\mr\bar x})\in L(A), \ I_0, J_0\in\omega^{(\omega)} \Big\}.}

We will prove that any finite subset of the type above is realized by a subsequence of ${\mr\bar a}$.
First note that $q({\mr\bar x})$ is realized by ${\mr a_{\restriction H}}$ for every $H\subseteq I^{(\omega)}$.
Then we only need to pay attention to the set on the right.

We prove that for $k$ and $n$ arbitrarily large and every $\phi_1({\mr\bar x}),\dots,\phi_k({\mr\bar x})\in L(A)$ there is an infinite $H\subseteq\omega$ such that ${\mr a_{\restriction H}}$ realizes

\ceq{\ssf{\#}}
{}
{\Big\{\phi_i({\mr x_{\restriction I_0}})\iff\phi_i({\mr x_{\restriction J_0}})\ :\  I_0, J_0\in\omega^{(\omega)}\textrm{ and } i\in(k]\Big\}.}

Let $n$ be larger than any $i$ such that ${\mr x_i}$ occurs in $\phi_1({\mr\bar x}),\dots,\phi_k({\mr\bar x})$.
Consider the subsets of $(k]$ as colors and let $f$ be the coloring of $I^{(n)}$ that maps $I_0$ to the set $\big\{i\ :\ \phi_i({\mr a_{\restriction I_0}})\big\}$.
By the Ramsey theorem,
there is some infinite monochromatic set $H\subseteq I$ with the order type of $\omega$.
Hence

\ceq{}
{}
{\Big\{\phi_i({\mr a_{\restriction I_0}})\iff\phi_i({\mr a_{\restriction J_0}})\ :\  I_0, J_0\in H^{(n)}\textrm{ and } i\in(k]\Big\}.}

As $H$ has order type $\omega$,
it is immediate that ${\mr a_{\restriction H}}$ re√∏alizes \ssf{\#}
as required.
\end{proof}

\begin{proposition}\label{prop_indiscernibles_set_model}
Let ${\mr\bar a}=\<{\mr a_i}:i\in I\>$ be a sequence of $A$-indiscernibles.
Then ${\mr\bar a}$ is indiscernible over some model $M$ containing $A$.
\end{proposition}

\begin{proof}
Fix a model $M$ containing $A$.
By Theorem~\ref{thm_EM} and the remark there is an $I$-sequence of $M$-indiscernibles ${\mr\bar c}$ such that $\EMtp({\mr\bar a}/M)\subseteq\EMtp({\mr\bar c}/M)$.
As ${\mr\bar a}$ is an $A$-indiscernible sequence ${\mr\bar a}\equiv_A{\mr\bar c}$.
Therefore $h\,{\mr\bar c}={\mr\bar a}$ for some $h\in\Aut(\U/A)$.
Hence ${\mr\bar a}$ is indiscernible over $h[M]$.
\end{proof}

\begin{exercise}
  Let $I,<_I$ and $J,<_J$ be infinite linear orders with no largest element.
  Prove that for every sequence $\bar a=\<a_i:i\in I\>$ there is an $A$-indiscernible sequence $\bar c=\<c_i:i\in J\>$ such that $\mbox{EM-tp}(\bar a/A)\subseteq\mbox{EM-tp}(\bar c/A)$.
\end{exercise}

\begin{exercise}
  Let $\bar a=\<a_i:i\in I\>$ be an $A$-indiscernible sequence with no largest element and let $J$ with $|J|\le \kappa$ be a linear order extending $I$.
  Prove that there is an $A$-indiscernible sequence that extends $\bar a$. I.e. some $\bar c=\<c_i:i\in J\>$ such that $c_{\restriction I}=\bar a$.
\end{exercise}

\begin{exercise}
  Let $p(x)\in S(\U)$ be a global type invariant over $A$.
  Let $a,b\models p_{\restriction A}(x)$.
  Prove that there is a sequence $\bar c=\<c_i:i<\omega\>$ such that $a,\bar c$ and $b,\bar c$ are both sequences of $A$-indiscernibles.
\end{exercise}

\begin{exercise}\label{ex_symmetry_ind}
  Let $\<c_i:i<\omega\>$ be an indiscernible sequence.
  Prove that there is an indiscernible sequence $\<d_i:i<\omega\>$ such that $d_0,d_1 = c_1,c_0$.
\end{exercise}

\begin{exercise}
  Let $\<\D_i:i<\omega\>$ be an $A$-indiscernible sequence in $\U^\eq$.
  Prove that there is a formula $\phi(x\,;z)\in L$ and an $A$-indiscernible sequence $\<b_i:i<\omega\>$ in $\U^z$ such that $\D_i=\phi(\U\,;b_i)$.
\end{exercise}

%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%
\section{Idempotent orbits in semigroups}\label{semigroups}

\def\medrel#1{\parbox[t]{6ex}{$\displaystyle\hfil #1$}}
\def\ceq#1#2#3{\parbox[t]{18ex}{$\displaystyle #1$}\medrel{#2}{$\displaystyle #3$}}

In this and the following sections we focus on semigroups definable in a first-order structure.
For a lighter notation, we assume that the semigroup operation \emph{$\ \cdot\ $} is among the symbols of $L$ and that the whole monster model is a semigroup \emph{$\mrS$\/} = $\U$. 

In this section we work over a given model $S\preceq\mrS$.
For any two sets $\mrA,\mrB\subseteq\mrS$ we define

\ceq{\hfill\emph{$\mrA*\mrB$}}
{=}
{\Big\{ {\mr a}{\cdot}{\mr b}
\ :\ 
{\mr a}\in\mrA, \ {\mr b}\in\mrB\textrm{ and }\ {\mr a}\cnonfork_S{\mr b}\Big\}}

In this and the next section we abbreviate $\Orbit({\mr a}/S)$, 
the orbit of ${\mr a}$ under $\Aut(\U/S)$, 
by \emph{$({\mr a})_S$}.
When ajacent to $*$, we write ${\mr a}$ for $({\mr a})_S$.
E.g.\@ we write \emph{$\mrA*{\mr b}$} for $\mrA*({\mr b})_S$ and \emph{${\mr a}*{\mr b}$} for $({\mr a})_S*{\mr b}$.

\begin{proposition}\label{prop_typedef_Ab}
If $\mrA$ is type definable over $S$ then so is $\mrA*{\mr b}$ 
for any ${\mr b}$.
\end{proposition}
\begin{proof}
  Let $p({\mr x}\,;{\mr z})$ the type in Remark~\ref{rem_heir_type}.
  Then the set $\mrA*{\mr b}$ is defined by the type $q({\mr y})=\E {\mr x},{\mr z}\ \big[ {\mr y}={\mr x}{\cdot}{\mr z}\ \wedge\ {\mr x}\in\mrA \ \wedge\ p({\mr x}\,;{\mr z})\big]$.
\end{proof}

From the invariance of $\cnonfork_S$ it follows immediately that $f[\mrA*\mrB]=f[\mrA]*f[\mrB]$ for every $f\in\Aut(\U/S)$.
%
Therefore, when $\mrA$ and $\mrB$ are invariant over $S$,
also $\mrA*\mrB$ is invariant over $S$.
Below we are mostly concerned with sets that are type-definable, therefore invariant, over $S$.

\begin{proposition}\label{prop_semi_associative}
For every $S$-invariant sets $\mrA$, $\mrB$, and $\mrC$\smallskip

\ceq{\hfill\mrA*\big(\mrB*\mrC\big)}
{\subseteq}
{\big(\mrA*\mrB\big)*\mrC}
\end{proposition}
\begin{proof}
Let ${\mr a}{\cdot}{\mr b}{\cdot}{\mr c}$ be an arbitrary element of the l.h.s.\@ where ${\mr a}\cnonfork_S{\mr b}{\cdot}{\mr c}$ and ${\mr b}\cnonfork_S{\mr c}$.
By extension (Lemma~\ref{lem_coheir_independence}),
there exists ${\mr a'}$ such that 
${\mr a}\equiv_{S,\,{\mr b}{\cdot}{\mr c}}{\mr a'}\cnonfork_S{\mr b}{\cdot}{\mr c},\,{\mr b},\,{\mr c}$.
By transitivity (again Lemma~\ref{lem_coheir_independence}),
${\mr a'}{\cdot}{\mr b}\cnonfork_S{\mr c}$.
Therefore ${\mr a'}{\cdot}{\mr b}{\cdot}{\mr c}$ belongs to the r.h.s.
Finally, as ${\mr a'}\equiv_{S,\,{\mr b}{\cdot}{\mr c}}{\mr a}$,
also ${\mr a}{\cdot}{\mr b}{\cdot}{\mr c}$ belongs to the r.h.s.\@ by $S$-invariance.
\end{proof}

We show that, under the assumption of stationarity,
$*$ is an operation on  $\U^{\mr x}/{\equiv_S}$.

\begin{proposition}\label{prop_orbits_main}
Assume $\cnonfork_S$ is stationary,
see Definition~\ref{def_coheir_stationary}.
Fix ${\mr a}\cnonfork_S{\mr b}$ arbitrarily.
Then ${\mr a'}{\cdot}{\mr b'}\equiv_S{\mr a}{\cdot}{\mr b}$ for every 
${\mr a'}\equiv_S{\mr a}$ and  ${\mr b'}\equiv_S{\mr b}$ such that
${\mr a'}\cnonfork_S{\mr b'}$.
Or, in other words, $({\mr a}{\cdot}{\mr b})_S={\mr a}*{\mr b}$.
\end{proposition}
%
\begin{proof}
  By invariance we can assume ${\mr b}={\mr b'}$.
  By stationarity, ${\mr a}\equiv_{S,\,{\mr b}}{\mr a'}$.
  Hence ${\mr a}{\cdot}{\mr b}\equiv_S{\mr a'}{\cdot}{\mr b}$.
\end{proof}

\begin{corollary}[ (associativity)]\label{corol_orbits_associative}
Assume $\cnonfork_{\!S}$ is stationary.
Then for every $S$-invariant sets $\mrA$,
$\mrB$ and  $\mrC$.

\ceq{\hfill\mrA*\big(\mrB*\mrC\big)}
{=}
{\big(\mrA*\mrB\big)*\mrC}
\end{corollary}

\begin{proof}
We can assume that $\mrA$, $\mrB$ and $\mrC$ are $S$-orbits.
Say of ${\mr a}$, ${\mr b}$, and ${\mr c}$ respectively.
As we are working over a model,
we can assume that ${\mr a}\cnonfork_S{\mr b}{\cdot}{\mr c}$ and ${\mr b}\cnonfork_S{\mr c}$.
By Proposition~\ref{prop_orbits_main} the set on the l.h.s.\@ equals $({\mr a}{\cdot}{\mr b}{\cdot}{\mr c})_S$.
By a similar argument the set on the r.h.s.\@ equals $({\mr a'}{\cdot}{\mr b'}{\cdot}{\mr c'})_S$ for some elements ${\mr a'}$, ${\mr b'}$, and ${\mr c'}$.
Proposition~\ref{prop_semi_associative} proves that inclusion $\subseteq$ holds in general.
But inclusion between orbits amounts to equality.
\end{proof}

Let $\mrA$ be a nonempty set.
When $\mrA*\mrA\subseteq\mrA$, we say that $\mrA$ is \emph{idempotent.}
We say that ${\mr a}\in\mrS$ is \emph{idempotent\/} if it has idempotent orbit.
Note that if $\mrA$ is idempotent and $\mrB\subseteq\mrA$, then also $\mrA*\mrB$ is idempotent.

\begin{lemma}\label{lem_Hindman}
Assume $\cnonfork_S$ is stationary.
If $\mrA$ is minimal among the
idempotent sets that are
type-definable over $S$, then $\mrA=({\mr b})_S$ for ${\mr b}\in\mrA$.
\end{lemma}

\begin{proof}
Pick arbitrarily some ${\mr b}\in\mrA$.
%
The set $\mrA*{\mr b}$ is contained in $\mrA$, idempotent and 
type-definable over $S$ by Proposition~\ref{prop_typedef_Ab}.
%
Therefore by minimality $\mrA*{\mr b}=\mrA$.
%
Let ${\mr\Aa'}\subseteq\mrA$ contain those ${\mr a}$ such that 
${\mr a}*{\mr b}=({\mr b})_S$.
%
This set is nonempty because ${\mr b}\in\mrA*{\mr b}$.
%
It is easy to verify that ${\mr\Aa'}$ is type-definable over $S,{\mr b}$.
%
As it is clearly invariant over $S$, it is type-definable over $S$.
%
By associativity, it is idempotent.
%
Hence, by minimality, ${\mr\Aa'}=\mrA$.
%
Then ${\mr b}\in{\mr\Aa'}$, which implies ${\mr b}*{\mr b}=({\mr b})_S$.
%
That is, ${\mr b}$ is idempotent.
%
Finally, by minimality, $\mrA=({\mr b})_S$.
\end{proof}

\begin{corollary}\label{corol_idempotent}
Under the same assumptions of the lemma above, every type-definable 
idempotent set contains an idempotent element.
\end{corollary}

% \begin{exercise}[ (van der Waerden's theorem)]
%   Prove that for every finite coloring of $\NN$ and for every $n<\omega$, there is a monochromatic arithmetical progression of length $n$.
%   An \textit{arithmetical progression\/} of length $n$ is a sequence of natural numbers $\langle a_i : i\le n\rangle$ such that $a_{i+1} - a_i$ is constant for $i<n$.
% \end{exercise}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%  
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Hindman's theorem}\label{Hindman}

In this section we merge the theory of idempotents presented in Section~\ref{semigroups}
with the proof of Ramsey's theorem to obtain Hindman's theorem in a straightforward way.
% Though this theorem is not explicitely stated in Newelski's papers, 
% our proof may be deduced from his work (though the generalization to semigroups may require some work).

Let ${\mr\bar a}$ be a tuple of elements of $\U^{\mr x}$ of length $\le\omega$.
We write $\fp\,{\mr\bar a}$ for the set of finite products of elements 
of ${\mr\bar a}$ taken in increasing order. 
Namely, 

\ceq{\hfill\emph{$\fp\,{\mr\bar a}$}}
{=}
{\Big\{{\mr a_{i_0}}\kern-0.5ex\cdot\dots\cdot{\mr a_{i_k}}\ :\quad i_0<\dots<i_k<|{\mr\bar a}|,\ \ k<|{\mr\bar a}|\Big\}}. 

% Let ${\mr\bar a}$ be a tuple of elements of $\U$ of length $\le\omega$. 
% For any $n\le|{\mr\bar a}|$ we write $\fp_n\,{\mr\bar a}$ for the set of 
% finite products of $\le n$ elements of ${\mr\bar a}$ taken in increasing order.
% Namely,
% 
% \ceq{\hfill\emph{$\fp_n\,{\mr\bar a}$}}{=}{\Big\{{\mr a_{i_0}}\kern-0.5ex\cdot\dots\cdot{\mr a_{i_k}}\ :\quad i_0<\dots<i_k<|{\mr\bar a}|,\ \ k< n\Big\}}.
% 
% When $n=|{\mr\bar a}|$ we write \emph{$\fp\,{\mr\bar a}$}. 
\bigskip
Let \emph{$\cpaw$\/} be a relation on $\U$.
Let $\mrA,\mrC\subseteq\U$.
We say that $\mrA$ is \emph{$\cpaw$-covered by $\mrC$\/} 
if for every ${\mr a_1},\dots,{\mr a_n}\in\mrA$ there are infinitely many ${\mr c}\in\mrC$ such that ${\mr a_i}\cpaw{\mr c}$ for all $i$.
When $\mrA=\mrC$ we simply sat that $\mrA$ is \emph{$\cpaw$-covered.}
We say that $\mrA$ is \emph{\cpawdot-closed\/} 
if ${\mr a}\cpaw{\mr b}\cpaw{\mr c}$ implies ${\mr a}\cpaw{\mr b}{\cdot}{\mr c}$ 
for all ${\mr a},{\mr b},{\mr c}\in\mrA$.
A \emph{$\cpaw$-chain\/} in $\U$ is a tuple ${\mr\bar a}\in\U^{\le\omega}$ such that ${\mr a_i}\cpaw{\mr a_{i+1}}$.

The requirements on  $\cpaw$ are hardly restrictive.
For example, on a free semigroup we can take the preorder relation given by the length of the words.
%
Or, on any semigroup $S$, we could take the trivial relation $S^2$ --the theorem below would remain nontrivial.

\theoremstyle{mio}
\newtheorem{Hindman}[thm]{Hindman's Theorem}
\begin{Hindman}\label{thm_Hindman}
Let $\cpaw$ be a relation on a semigroup $S$.
%
Assume that $S$ is  \cpawdot-closed and $\cpaw$-covered.
%
Then for every finite coloring of $S$ 
there is an infinite $\cpaw$-chain $\bar a$ such that $\fp\,\bar a$ is monochromatic.
\end{Hindman}

This implies that every commutative semigroup $S$ has an infinite monochromatic subset closed under finite sums of distinct elements (order $S$ arbitrarily).

Our proof follows closely the proof of Ramsey's theorem~\ref{thm_Ramsey}.
%
The novelty is all in Lemma~\ref{lem_Hindman}.

\begin{proof}
We interpret $S$ as a structure in a language 
that extends the natural language of semigroups
with a symbol for $\cpaw$ and one for each subset of $S$.
%
Let $\mrS$ be a saturated elementary superstructure of $S$.
%
As observed in Remark~\ref{rk_coheir_stationary}, 
the language makes $\cnonfork_S$ trivially stationary.

We write ${\mr\S'}$ for the type-definable set $\{{\mr x} : S\cpaw{\mr x}\}$,
which is nonempty because $S$ is $\cpaw$-covered.
%
We claim that ${\mr\S'}$ is idempotent.
%
In fact, if ${\mr a},{\mr b}\in{\mr\S'}$ 
then, as $S\cpaw{\mr a},{\mr b}$ and ${\mr a}\cnonfork_S{\mr b}$, 
we must have that ${\mr a}\cpaw{\mr b}$.
%
Therefore, from the \cpawdot-closure of $\cpaw$ we infer ${\mr a}{\cdot}{\mr b}\in{\mr\S'}$.

Let ${\mr g_0}$ be an idempotent element of ${\mr\S'}$
as given by Corollary~\ref{corol_idempotent}.
Let ${\mr g_1}$ realize ${\mr g_0}\equiv_S{\mr x}\cnonfork_S{\mr g_0}$.
%
Assume for definiteness that ${\mr g_0}$ has color $1$.
%
Now, we define $\bar a\in S^\omega$ inductively such that all elements of $\fp\,\bar a$ have color $1$.

Assume inductively that we have $a_{\restriction i}\in S^i$ 
such that all elements of $\fp(a_{\restriction i},\,{\mr g_0})$ have color $1$.
%
Our goal is to find $a_i$ 
such that the same property holds for $\fp(a_{\restriction i+1},\,{\mr g_0})$.

Note that $\fp(a_{\restriction i},\,{\mr g_1}\,,{\mr g_0})$ has color $1$.
In fact, ${\mr g_1}\equiv_S{\mr g_0}\equiv_S{\mr g_1}{\cdot}{\mr g_0}$.
Now, ${\mr g_1}\cnonfork_S{\mr g_0}$ yields some $a_i\in S$ such that  $\fp(a_{\restriction i+1},\,{\mr g_0})$ has color 1.
\end{proof}

\begin{exercise}
  The following claim is too strong to be true.
  For every finite coloring of $\NN^{(2)}$ there is an infinite sequence $\bar a=\<a_i:i<\omega\>$ in $\NN$ such that $\fp(\bar a)^{(2)}$ is monochromatic.
  Replace $\fp(\bar a)^{(2)}$ with a (slightly) smaller set that makes the claim true.
\end{exercise}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{The Hales-Jewett Theorem}
\label{HJ}

The Hales-Jewett Theorem is a purely combinatorial statement 
that implies the van der Waerden Theorem.

Throughout this section we assume that $\cnonfork_{\!S}$ is stationary.

We work with the same notation as Section~\ref{semigroups}.
We need a few definitions.
Let $\mrC\subseteq\mrS$ be an idempotent set.
If $\varnothing\neq\mrA\subseteq\mrC$ is such that $\mrC*\mrA\subseteq\mrA$, we say that $\mrA$ is a \emph{left ideal\/} of $\mrC$.
When $\mrC$ is clear we omit reference to it.
% We arte interested in left ideal that are type-definable (over $S$).
A \emph{minimal\/} left ideal is one that does not properly contain any other left ideal.
The following fact is immediate.

\begin{fact}\label{fact_mli}
  The following are equivalent for any $\mrM$ that is a left ideal of $\mrC$
  \begin{itemize}
    \item [1.] $\mrM$ is minimal
    \item [2.] $\mrM=\mrM*{\mr b}$ for every ${\mr b}\in\mrM$
    \item [3.] $\mrM=\mrC*{\mr b}$ for every ${\mr b}\in\mrM$
  \end{itemize}
\end{fact}

Moreover, when ${\mr b}$ is not in $\mrM$, we have the following.

\begin{fact}\label{fact_mli2}
   Let $\mrM$ be a minimal left ideal of $\mrC$.
   Then $\mrM*{\mr b}$ is a minimal left ideal for any ${\mr b}\in\mrC$.
\end{fact}

\begin{proof}
  Clearly, $\mrM*{\mr b}$ is a left ideal.
  Let ${\mr a}*{\mr b}$, for some ${\mr a}\in\mrM$, be an arbitrary element of $\mrM*{\mr b}$.
  By Fact~\ref{fact_mli}, it sufficies to prove that $\mrM*{\mr b}*{\mr a}*{\mr b}=\mrM*{\mr b}$.
  This holds, in fact ${\mr b}*{\mr a}\in\mrM$, hence $\mrM*{\mr b}*{\mr a}=\mrM$ by the minimality of $\mrM$.
\end{proof}

Now we prove the existence of minimal left ideals.

\begin{fact}
  Let $\mrC$ be a type-definable idempotent set. Then $\mrC$ contains a minimal left ideal which is type-definable.
\end{fact}

\begin{proof}
  Construct inductively a descending chain of type-definable left ideals ${\mr\M_i}$ where ${\mr\M_0}=\mrC$ and ${\mr\M_{i+1}}={\mr\M_i}*{\mr b_i}$ for some ${\mr b_i}\in{\mr\M_i}$.
  By compactness the chain stabilizes at some ordinal yielding some type-definable left ideal ${\mr\M_\alpha}$ which is minimal as it satisfies \ssf2 in the above fact.
\end{proof}

It is also interesting to note that we can define, in the obvious way, \textit{right ideals\/} and even \textit{two-sided ideals.}
But note the proof of the above fact would not apply because, in general, ${\mr b}*\mrC$ is not type-definable.
However for two-sided ideals we have the following remarkable fact (which is not needed in the sequel).

\begin{fact}\label{fact_two_sided_ideal}
  Let $\mrC$ be a type-definable idempotent set.
  Define \smallskip

  \ceq{\hfill\mrK}{=}{\bigcup\big\{\mrM\ :\ \mrM\text{ a minimal left ideal of }\mrC\big\}}\smallskip

  Then $\mrK$ is a minimal two-sided ideal.
\end{fact}

\begin{proof}
  Clearly, $\mrK$ is a left ideal.
  To prove that $\mrK$ is also a right ideal note that, by Fact~\ref{fact_mli2}, for every ${\mr a}\in\mrC$ 

  \ceq{\hfill\mrK*{\mr a}}{=}{\bigcup\big\{\mrM*{\mr a}\ :\ \mrM\text{ a minimal left ideal of }\mrC\big\}}\medrel{\subseteq}$\mrK$.\smallskip

  As for minimality, it sufficies to prove that any two-sided ideal $\mrH$ contains any minimal left ideal $\mrM$.
  Note that $\mrH\cap\mrM$ is not empty in fact, as $\mrH$ is in particular a right ideal $\mrH*\mrM\subseteq\mrH\cap\mrM$.
  As $\mrH\cap\mrM$ is in particular a left ideal and it is contained in $\mrM$, by minimality, it coincides with $\mrM$.
\end{proof}

Note that every left ideal is an idempotent set and therefore contains idempotent elements.

\begin{lemma}\label{lem_leftideal}
  Let $\mrC$ be a type-definable idempotent set.
  Let $\mrM$ be a minimal left ideal of $\mrC$.
  Let ${\mr u},{\mr v}\in\mrM$ be two idempotents.
  Then the followings hold (to avoid notation overload, we confuse the elements of $\mrC$ with their orbits)
  \begin{itemize}
    \item [1.] ${\mr a}*{\mr u}={\mr a}$ for every ${\mr a}\in\mrM$ 
    \item [2.] $*$ is a group operation on ${\mr u}*\mrM$ with identity ${\mr u}$
    \item [3.] ${\mr a}\mapsto{\mr v}*{\mr a}$ define a group isomorphism between ${\mr u}*\mrM$ and ${\mr v}*\mrM$
    \item [4.] if ${\mr u}$ and ${\mr v}$ are distinct (i.e.\@ have distict orbits), then ${\mr u}*\mrM$ and ${\mr v}*\mrM$ are disjoint
    \item [5.] $\mrM$ is covered by sets of the form ${\mr u}*\mrM$ as ${\mr u}\in\mrM$ ranges over the idempotents
    % \item [6.] if ${\mr b}\in\mrC$ is an idempotent, ${\mr u}*{\mr b}={\mr u}$ and ${\mr b}*{\mr u}$ is idempotent.
    \item [6.] if ${\mr b}\in\mrC$ is an idempotent, then ${\mr b}*\mrM*{\mr b}$ contains an idempotent.\smallskip
  \end{itemize}
\end{lemma}

\begin{proof}
  \ssf1. 
  By minimality $\mrM*{\mr u}=\mrM$.
  Therefore ${\mr a'}*{\mr u}={\mr a}$ for some ${\mr a'}\in\mrM$.
  Then ${\mr a}*{\mr u}={\mr a'}*{\mr u}*{\mr u}={\mr a}$.

  \ssf2. 
  By \ssf1 and idempotency, ${\mr u}$ is an identity of ${\mr u}*\mrM$.
  It suffices to prove the existence of a left inverse (in fact, by algebra, this is also a right inverse).
  Pick any ${\mr a}\in{\mr u}*\mrM$.
  From $\mrM*{\mr a}=\mrM$ we obtain that ${\mr u}*\mrM*{\mr a}={\mr u}*\mrM$.
  Then ${\mr u}*{\mr a'}*{\mr a}={\mr u}$ for some ${\mr a'}\in\mrM$.
  This proves that ${\mr u}*{\mr a'}$ is the left inverse of ${\mr a}$.

  \ssf3.
  By \ssf1, the map ${\mr a}\mapsto{\mr v}*{\mr a}$ is a semigroup homomorphism.
   By \ssf1 and \ssf2, its inverse is ${\mr a}\mapsto{\mr u}*{\mr a}$.
   So, ${\mr a}\mapsto{\mr v}*{\mr a}$ is a group isomomorphism.

  \ssf4. 
  Suppose there is an ${\mr a}\in{\mr u}*\mrM\cap{\mr v}*\mrM$.
  Let ${\mr a'}\in\mrM$ be such that ${\mr a}*{\mr a'}={\mr u}$.
  Then ${\mr u}\in{\mr v}*\mrM*{\mr a'}={\mr v}*\mrM$.
  Then ${\mr u}$ is an identity in the group ${\mr v}*\mrM$.

  \ssf5.
  Let ${\mr a}\in\mrM$.
  As $\mrM*{\mr a}=\mrM$, the set $\{ {\mr c}\in\mrM\,:\, {\mr c}* {\mr a} =  {\mr a}\}$ is nonempty.
  As this is a type-definable idempotent set, it contains an idempotent element ${\mr u}$.
  Then ${\mr a}\in{\mr u}*\mrM$.
  
  \ssf6. 
  As $\mrM*{\mr b}$ is a minimal left ideal by Fact~\ref{fact_mli2}, it contains an idempotent element ${\mr u}\in\mrM*{\mr b}$.
  It is immediate to verify that ${\mr b}*{\mr u}$ is the required idempotent.
\end{proof}

The following is a technical lemma that is required in the proof of the main theorem.

\begin{proposition}\label{prop_HJ_tecnical}
Let $\sigma:\mrS\to\mrS$ be a semigroup homomorphism definable over $M$.
Then 
\begin{itemize}
\item[1.] $\sigma\big[({\mr a})_S\big]=(\sigma\,{\mr a})_S$

\item[2.]
$\sigma\big[{\mr a}*{\mr b}\big]=\sigma\,{\mr a}*\sigma\,{\mr b}$.
\end{itemize}
\end{proposition}
\begin{proof}\ \ssf{1.}  
As ${\mr a}\equiv_S{\mr a'}$ implies $\sigma\,{\mr a}\equiv_S\sigma\,{\mr a'}$,
inclusion $\subseteq$ is clear.
For the converse, note that the type 
$\E{\mr y}\,\big[\sigma\,{\mr y}={\mr x}\,\wedge\,{\mr y}\equiv_S{\mr a}\big]$ 
is trivially realized by $\sigma\,{\mr a}$.
By invariance it is equivalent to a type over $S$.
Therefore it is realized by all elements of $(\sigma\,{\mr a})_S$.
Hence all elements of $(\sigma\,{\mr a})_S$ are the image of some element in $({\mr a})_S$.

\def\medrel#1{\parbox[t]{6ex}{$\displaystyle\hfil #1$}}
\def\ceq#1#2#3{\parbox[t]{39ex}{$\displaystyle #1$}\medrel{#2}{$\displaystyle #3$}}
\ssf{2.} \  
We have to prove the following equality\smallskip

\ceq{\hfill\Big\{\sigma({\mr a'}{\cdot}{\mr b'})\ :\ {\mr a}\equiv_S{\mr a'}\cnonfork_S{\mr b'}\equiv_S{\mr b} \Big\}}
{=}
{\Big\{{\mr a'}{\cdot}{\mr b'}\ :\ \sigma\,{\mr a}\equiv_S{\mr a'}\cnonfork_S{\mr b'}\equiv_S\sigma\,{\mr b} \Big\}.}\smallskip

It suffices to prove one inclusion because by Proposition~\ref{prop_orbits_main} both sides are orbits.
We prove $\subseteq$.
Note that ${\mr a'}\cnonfork_S{\mr b'}$ implies $\sigma\,{\mr a'}\cnonfork_S\sigma\,{\mr b'}$.
Hence the set on l.h.s.\@ is contained in the following\smallskip

\hfil$\Big\{\sigma({\mr a'}{\cdot}{\mr b'})\ :\ \sigma\,{\mr a'}\cnonfork_S\sigma\,{\mr b'},\ {\mr a'}\equiv_S{\mr a},\  {\mr b'}\equiv_S{\mr b} \Big\}$\smallskip

which is in turn contained in the set on the r.h.s.
\end{proof}
 
The following theorem is an elegant rephrasing of the celebrated Hales-Jewett Theorem.
Let $S$ be a semigroup.
A subsemigroup $C$ is \emph{nice\/} if it has the property that if $a{\cdot}b\in C$ then $a,b\in C$.

\begin{void}[Hales-Jewett Theorem (Koppelberg's formulation)]\label{thm_abstract_HJ}
Let $S$ be a semigroup with an infinite nice subsemigroup $C$.
Let $\Sigma$ be a finite set of retractions of $S$ onto $C$, that is, 
homomorphisms $\sigma:S\to C$ such that $\sigma_{\restriction C}={\rm id}_C$.
Then, for every finite coloring of $C$,
there is an $a\in S\sm C$ such that $\{\sigma\,a:\sigma\in\Sigma\}$ is monochromatic.
\end{void}

\begin{proof}
Let $\mrS$ be a saturated elementary extension of $S$ in a language that expands the language of semigroups with a symbol for all subsets of $S$.
As observed in Remark~\ref{rk_coheir_stationary}, this makes $\cnonfork_S$ stationary.
The language contains also symbols for the retractions $\sigma:S\to C$.
Let $\mrC$ be the interpretation of $C$ in $\mrS$.
Then $\sigma:\mrS\to\mrC$.

By nicety, $\mrS\sm\mrC$ is a left ideal of $\mrS$ (as a matter of fact, a two-sided ideal).
Let $\mrM\subseteq \mrS\sm\mrC$ be minimal a left ideal of $\mrS$.
Let $\mrN\subseteq\mrC$ be a minimal left ideal of $\mrC$.
Let ${\mr v}\in\mrN$ be an idempotent.
By Proposition~\ref{prop_HJ_tecnical}, for every retraction $\sigma$, we have that $\sigma(\mrM)*{\mr v}$ is a left ideal contained in $\mrN$.
Therefore they all coincide with $\mrN$.
Let ${\mr u}\in{\mr v}*\mrM*{\mr v}$ be an idempotent.
Then $\sigma({\mr u})$ is an idempotent of ${\mr v}*\mrN$.
As ${\mr v}*\mrN$ contains only one idempotent orbit, $\sigma({\mr u})\equiv_S{\mr v}$ for every $\sigma$.
In particular $\{\sigma({\mr u})\,:\,\sigma\in\Sigma\}$ is monochromatic.
As $\Sigma$ is finite , the theorem follows by elementarity.
\end{proof}

Finally we derive the classical Hales-Jewett Theorem from the above algebraic version.

\begin{void}[Hales-Jewett Theorem (classical formulation)]\label{thm_HalesJewett}
  Let $C$ be an infinite semigroup.
  Let $F\subseteq C$ be a finite set.
  Then, given any finite coloring of $C$, there is a non-constant term $t(x)$ in the language of semigroups with parameters in $C$ such that the set $\{ t(a)^C: a\in F\}$ is monochromatic ($x$ is a single variable and $t(a)^C$ is the evaluation of $t(a)$ in $C$).
\end{void}

\begin{proof}
  Let $S$ be the set of the terms n the language of semigroups with parameters in $C$ where at most the variable $x$ occur.
  Then $S$ is a semigroup under the natural operation and $C$ is a nice subgroup.
  For every $a\in C$ the map $\sigma_a$ that takes $t(x)$ to $t(a)^C$.
  These are a retraction of $S$ onto $C$.
  Hence we can apply Theorem~\ref{thm_abstract_HJ}.
\end{proof}

We also derive a famous consequence of the Hales-Jewett Theorem.
An \textit{arithmetical progression\/} of length $k$ is a sequence of natural numbers $\langle n{+}m{\cdot}i : i<k\rangle$ for some $n,m\in\NN$.

\begin{void}[van der Waerden's Theorem]
  For every finite coloring of $\NN$ and for every $k<\omega$, there is a monochromatic arithmetical progression of length $k$.
\end{void}

\begin{proof}
  Let $C=\NN$ and let $S$ be the semigroup of terms in the language of semigroups with parameters in $\NN$ where at most the variable $x$ occur.
  That is terms of the form $n{+}m{\cdot}x$ for some $n,m\in\NN$.
  Then $\NN$ is a nice subsemigroup of $S$.
  For $i<k$ let $\sigma_i$ be the retraction that takes $n{+}m{\cdot}x\in S$ to $n{+}m{\cdot}i\in\NN$.
  Apply Theorem~\ref{thm_abstract_HJ} to obtain some $n,m\in\NN$ such that the set $\{n{+}m{\cdot}i\ :\ i<k\}$ is monochromatic.
\end{proof}

% \begin{exercise}\label{thm_hom_HJ}
%   Let $\Sigma$ be a finite set of homomorphisms $\sigma:S\to C$ 
%   between infinite semigroups such that the following intersection is nonempty for all $c\in C$

%   \ceq{\hfill\Sigma^{-1}[c]}{=}{\bigcap_{\sigma\in\Sigma}\sigma^{-1}[c]}

%   Prove that, for every finite coloring of $C$, for some $g\in S$ the set 
%   $\{\sigma\,g\ :\ \sigma\in\Sigma\}$ is monochromatic.
% \end{exercise}

% \begin{proof}
% Let $G*C$ be free product of the two semigroups.
% That is, $G*C$ contains finite sequences of elements of $G\cup C$, below called \textit{words}, that alternate elements in $G$ with elements in $C$.
% The product of two words is obtained concatenating them and, when it applies, replacing two contiguous elements of the same group by their product.
% Note that $C$ is a nice subsemigroups of $G*C$.

% Any homomorphism $\sigma:G\to C$ extends canonically to a retraction of $G*C$ to $C$.
% In fact, this extension is unique: the elements of $G$ that occur in a word are replaced by their image under $\sigma$, finally the elements in the resulting sequence are multiplied.
% This extension is denoted by the same symbol $\sigma$.

% Apply Theorem~\ref{thm_abstract_HJ} to obtain some $w\in G*C$ such that 
% $\{\sigma \,w:\sigma\in\Sigma\}$ is monochromatic.
% %
% Suppose $w=c_0\cdot g_0\cdots\cdots c_n\cdot g_n$ for some $g_i\in G$ and $c_i\in C$, 
% where one or both of $c_0$ or $g_n$ could be absent. Pick some $h_i\in\Sigma^{-1}[c_i]$ and 
% let $g=h_0\cdot g_0\cdots\cdots h_n\cdot g_n$.
% %
% Then $\{\sigma\,g:\sigma\in\Sigma\}$ is monochromatic as required to complete the proof.
% \end{proof}

\begin{exercise}
  Let $\M$ be a type-definable minimal left ideal of $\C$.
  Let $u\in\M$ be an idempotent.
  Prove that $u*\M$ is a minimal right ideal of $\C$.
\end{exercise}

\begin{exercise}
  Let $\M$ and $\N$ be type-definable minimal left ideals of $\C$.
  Let $u\in\M$ and $v\in\N$ be idempotents.
  Prove that $u*\M$ and $v*\N$ are isomorphic groups.
\end{exercise}

\begin{exercise}
  For every finite coloring of $\NN$ and every $k<\omega$, 
  there is an infinite sequence $\bar a=\<a_i(x):i<\omega\>$ of nonconstant univariate polynomials with coefficients in $\NN$ such that $\big\{a(i): a(x)\in\fp(\bar a),\ i<k\big\}$ is monochromatic.
  Can we require that the $a_i(x)$ have increasing degrees?
\end{exercise}

\begin{exercise}
Prove that 

 \hfil$\displaystyle\bigcup\big\{\M\ :\ \M\text{ a minimal left ideal of }\C\big\} =\bigcup\big\{\M\ :\ \M\text{ a minimal right ideal of }\C\big\}$.

\end{exercise}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Notes and references}

The first application of the algebraic structure of $\beta S$ 
(the Stone-\v{C}ech compactification of a semigroup $S$) 
to Ramsey Theory is the celebrated Galvin-Glazer proof of Hindman's theorem. 
Here we have used saturated models in place of Stone-\v{C}ech compactification.
The idea to replace the semigroup $\beta S$ with types has been pioneered by Ludomir Newelski
in the study of applications of topological dynamics to model theory.
Our exposition follows~\cite{CZ}.

The original proof of the Hales-Jewett Theorem by Alfred Hales and Robert Jewett is combinatorial.
An alternative proof, also combinatorial, has been given by Saharon Shelah.
The formulation with retractions is from~\cite{Koppelberg}.

\begin{biblist}[]\normalsize
  \bib{CZ}{article}{
   author={Colla, Eugenio},
   author={Zambella, Domenico},
   title={Ramsey's coheirs},
   journal={J. Symb. Log.},
   volume={87},
   date={2022},
   number={1},
   pages={377--391},
   note={\href{https://arxiv.org/abs/1901.04363}{arXiv:1901.04363}},
  %  issn={0022-4812},
  %  review={\MR{4404631}},
  %  doi={10.1017/jsl.2019.93},
}\smallskip
  \bib{Koppelberg}{article}{
  author={Koppelberg, Sabine},
  title={The Hales-Jewett theorem via retractions},
  booktitle={Proceedings of the 18th Summer Conference on Topology and its Applications},
  journal={Topology Proc.},
  volume={28},
  date={2004},
  number={2},
  pages={595--601},
}
  \end{biblist}

\begin{comment}

\begin{proposition}
Let $G$ be a semigroup and let $C\subset G$ be a nice subsemigroup.
Let $\Sigma$ be a countable set of retractions of $G$ to $C$.
Then for every finite coloring of $C$ there is a ${\mr\bar g}\in (G\sm C)^\omega$ 
such that the sets 
$\fp \{\sigma({\mr g_{\restriction\,\omega\sm n}})\,:\,\sigma\in\Sigma_0 \}$ are all monochromatic, 
where $\Sigma_0\subseteq\Sigma$ are arbitrary finite sets 
and $n=n_{\Sigma_0}$.
\end{proposition}

Recall that $\sigma({\mr g_{\restriction\,\omega\sm n}})$ is the tuple $\<{\sigma(\mr g_{i+n} } ): i<\omega\>$. 
In the theorem above, we have stretched definition of $\fp(\mbox{-})$ and applied it to sets of tuples of equal length.
Precisely, we enhance the definition of $\fp_n(\mbox{-})$ as follows 

\ceq{\hfill\fp_n\{{\mr\bar g^j}\ :\ j\in J\} }{=}{\Big\{{\mr g^{j_1}_{i_1}}\kern-0.5ex\cdot\dots\cdot{\mr g^{j_n}_{i_n}}\ :\quad i_1<\dots<i_n<\alpha, \ \  j_1,\dots,j_n\in J\Big\}}.

Finally $\fp(\mbox{-})$ is defined as the union of the $\fp_n(\mbox{-})$.


\begin{proof}
Reasoning as in the proof of Theorem~\ref{thm_abstract_HJ}, 
and with the same notation,
we obtain an element ${\mr v}\in\mrV\sm\U^{\mr x}$ with idempotent orbit 
and such that all $\sigma({\mr v})$ for $\sigma\in\Sigma$
have the same type over $G$.

Let $p({\mr x})\in S(\mrV)$ be a global coheir of $\tp({\mr v}/G)$ and let ${\mr\bar v}$ 
be a coheir sequence such that ${\mr v_i}\models p_{\restriction A_i }({\mr x})$ where 
$A_i=G\, \cup\, \fp\{\sigma({\mr v_{\restriction i}})\ :\ \sigma\in\Sigma \}$.

Now, we use the sequence ${\mr\bar v}$ to define the ${\mr\bar g}$ required by the theorem.
Assume $\Sigma=\{\sigma_i:i<\omega\}$. 
Assume as induction hypothesis that $\fp\{\sigma_i({\mr g_{\restriction i}},\,{\mr\bar c}) : i<n\}$ is monochromatic.
Our goal is to find ${\mr a_i}$ such as the same property holds for ${\mr a_{\restriction i}},\,{\mr a_i},\,{\mr\bar c}$.


Let $\phi({\mr a_{\restriction i}},\,{\mr c_i},\,{\mr c_{\restriction i}})$ be the sentence that says $\fp_{i+1}({\mr a_{\restriction i}},\,{\mr c_i},\,{\mr c_{\restriction i}})$ is monochromatic.
As ${\mr\bar c}$ is a coheir sequence we can find  ${\mr a_i}\in S$ such that $\phi({\mr a_{\restriction i}},\,{\mr a_i},\,{\mr c_{\restriction i}})$.
  Hence $\fp_{i+1}({\mr a_{\restriction i}},\,{\mr a_i},\,{\mr c_{\restriction i}})$ is monochromatic.
 As ${\mr\bar c}$ is indiscernible over $G$, this is equivalent to  $\fp({\mr a_{\restriction i}},\,{\mr a_i},\,{\mr\bar c})$.

\end{proof}

\section{Hales-Jewett + Hindman \ = \ Carlson}
 V. Bergelson, A. Blass, and N. Hindman, Partition theorems for spaces of variable words,
Proc. London Math. Soc. 68 (1994), 449-476. MR 95i:05107


\begin{theorem}
Let $G$ be a semigroups and let $C\subset G$ be a nice subsemigroup.
Fix a finite coloring of $G$ and ${\mr\bar g}\in G^\omega$.
Then there is a sequence of retractions $\sigma_i:G\to C$ and 
an increasing tuple ${\mr\bar s}\in\fp({\mr\bar g})^\omega$ such that
$\{\sigma_i({\mr s_i}):i<\omega\}$ is monochromatic disjoint of $C$..
\end{theorem}

% 
% \section{Crap (if this is publicly available, it's just by errror)}
% 
% \noindent\llap{\textcolor{red}{\Large\warning}\kern1.5ex}The following terminology in not standard.We say that the set $\mrB\subseteq\U^{|{\mr x}|}$, typically a definable set, is \emph{strongly quasi-invariant over $S$\/} if for every definable set $\mrD$ either $\mrB\cap\mrD$ or $\mrB\cap\neg\mrD$ is quasi-invariant.
% 
% \begin{proposition}If $\mrB$ is strongly quasi-invariant over $S$ and $\<{\mr\D_i}:i<n\>$ is a finite sequence of definable sets that covers $\mrB$, then $\mrB\cap{\mr\D_i}$ is strongly quasi-invariant over $S$ for some $i$.
% \end{proposition}
% 
% We say that the type $p({\mr x})\subseteq L(\U)$ is \emph{strongly quasi-invariant over $S$\/} if $\phi(\U^{\mr x})$ is strongly quasi-invariant over $S$ for every $\phi({\mr x})$ conjunction of formulas in $p({\mr x})$.% So, the type $p({\mr x})$ is quasi-invariant if the set $p({\mr\V})$ is invariant, where $\V$ is an large saturated extension of $\U$, see Exercise~\ref{ex_quasi_inv_type}.
% 
% \begin{proposition}
% Every strongly quasi-invariant type has an extension to a global strongly quasi-invariant type.
% \end{proposition}
% 
% \begin{proof}
% Let $q({\mr x})\subseteq L(\U)$ be a strongly quasi-invariant type and let  $p({\mr x})\subseteq L(\U)$ be a maximally consistent  strongly quasi-invariant type.We claim that $p({\mr x})$ is complete.If not, then there are some formulas $\phi({\mr x})\in L(\U)$ and  $\psi({\mr x})\in p$ such that $\psi({\mr x})\wedge\phi({\mr x})$ and $\psi({\mr x})\wedge\neg\phi({\mr x})$. This contradicts Proposition~\ref{}.
% \end{proof}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Product of types}\label{tipi_prodotto}


\begin{lemma}\label{lem_tensor}
Let $p({\mr x})\in S(\U)$ be a global type invariant over $S$.
Let ${\gr a}\equiv_A{\gr a'}$.
Then  ${\gr a},{\mr b}\equiv_A{\gr a'},{\mr b'}$ for all ${\mr b}\models p_{\restriction A,{\gr a}}({\mr x})$ and  ${\mr b'}\models p_{\restriction A,{\gr a'}}({\mr x})$.

\end{lemma}

\begin{proof}
Let $\phi({\mr x\,};{\gr z})\in L(A)$.
If $\phi({\mr b\,};{\gr a})$ then $\phi({\mr x\,};{\gr a})\in p$ and, by invariance, $\phi({\mr x\,};{\gr a'})\in p$.
As  ${\mr b'}\models p_{\restriction A,{\gr a'}}({\mr x})$, we obtain $\phi({\mr b'\,};{\gr a'})$.

\end{proof}

Lemma~\ref{lem_tensor} ensures that the definition below is well-defined, i.e.\@ that it does not depend on ${\gr a},{\mr b}$.



\begin{definition}\label{def_prodotto_tipi}
Let $p({\mr x})\in S(\U)$ be an $S$-invariant type.
For $q({\gr z})\in S(A)$ we define

\ceq{\hfill\mbox{\emph{$q(z)\otimes__S p({\mr x})$}}}{\deq}{\tp({\gr a\,};{\mr b}/A)}\quad for some ${\gr a}\models q({\gr z})$ and ${\mr b}\models p_{\restriction A,{\gr a}}({\mr x})$.

When $q({\gr z})\in S(\U)$, we define

\ceq{\hfill\mbox{\emph{$q(z)\otimes p({\mr x})$}}}{\deq}{\bigcup_{S\subseteq B}\ q_{\restriction B}(z)\otimes_B p({\mr x})}.
\end{definition}

Note that $q({\gr z})\otimes p({\mr x})$ is consistent, and therefore a complete global type.
In fact, it is immediate to verify that if $A\subseteq B'\subseteq B''$ then $q_{\restriction B'}({\gr z})\otimes p({\mr x})\ \subseteq\ q_{\restriction B''}({\gr z})\otimes p({\mr x})$.


\begin{proposition}
Let $q({\gr z}), p({\mr x})\in S(\U)$ be $S$-invariant types.
Then $q(z)\otimes p({\mr x})$ is also $S$-invariant.
And if they are finitely satisfiable in $S$ then so is $q(z)\otimes p({\mr x})$.
\end{proposition}

\begin{proof}
Let $\phi(z,x,u)\in L(A)$.
Let $\phi(z,x,c)\in q(z)\otimes p({\mr x})$ and let $c'\equiv_Ac$.
Fix $a\models q_{\restriction A,c,c'}$ and $b\models p_{\restriction A,c,c',a}$.
From the invariance of $q$ we obtain $c\equiv_{S,a}c'$.
From the invariance of $p$ we obtain  $c\equiv_{S,a,b}c'$.
As $\phi(a,b,c)$ hold by the choice of $a$ and $b$, also $\phi(a,b,c')$ holds.
It follows that $\phi(z,x,c')\in q({\gr z})\otimes p({\mr x})$ which proves the invariance of $q({\gr z})\otimes p({\mr x})$.

Let $\phi(z,x)\in L(B)$ be a formula in $q(z)\otimes p({\mr x})$.
Let $a\models q_{\restriction B}(z)$.
Then $\phi(a,x)\in p$ and, by finite satisfiability, there is a $b'\in A^{|x|}$ such that $\phi(a,b')$.
Then $\phi(z,b')\in q$ and, by finite satisfiability $\phi(a',b')$ holds for some $a'\in A^{|z|}$.
\end{proof}





La seguente proposizione mostra che possiamo ragionevolmente parlare di tipo delle di Morley di $p$.
Questo paragrafo \`e dedicato alla descrizione sintattica di questo tipo.

\begin{proposition}\label{prop_tiposequenzaMorley}
Sia $p\in S_x(\U)$ un tipo globale $S$-invariante e supponiamo che $a$ e $b$ siano due sequenze di Morley di $p$ su $S$.
Allora $a\equiv_A c$.

\end{proposition}
\begin{proof}
%Possiamo assumere che $a=\<a_i:i<\omega\>$ e $\bar c=\<c_i:i<\omega\>$ abbiano lunghezza $\omega$.

Per indiscernibilit\`a, \`e sufficiente mostrare che $a_{\restriction i}\equiv_A{\mr c_{\restriction i}}$ per ogni $i<\omega$.
Ragioniamo per induzione, assumiamo l'equivalenza come ipotesi induttiva, fissiamo una formula $\phi(\bar x_{\restriction i},{\mr x})\in L(A)$ e dimostriamo che 

\ceq{\hfill \phi(a_{\restriction i},{\mr a_i})}{\iff}{\phi({\mr c_{\restriction i}},{\mr c_i})} 

Se $\phi(a_{\restriction i},{\mr a_i})$ allora $\phi(a_{\restriction i},{\mr x})\in p$.
Per l'ipotesi induttiva e per l'invarianza di $p$ otteniamo che anche  $\phi({\mr c_{\restriction i}},{\mr x})\in p$ e di qui $\phi({\mr c_{\restriction i}},{\mr c_i})$.
L'equivalenza segue per simmetria.
\end{proof}

Per poter semplificare la definizione~\ref{def_prodotto_tipi} abbiamo bisogno del seguente lemma tecnico:

\begin{lemma}\label{lemma_prodotto}
Dati $p({\mr x}), q(y)\in S(\U)$, e due insiemi $A_i$, per $i=0,1$ su cui $q(y)$ \`e invariante, fissiamo $\phi(x,y)\in L(A_0\cap A_1)$ e delle tuple $a_i,b_i$ tali che $a_i\models p_{\restriction A_i}$ e $b_i\models q_{\restriction A_i,a_i}$.
Allora $\phi(a_0,b_0)\iff\phi(a_1,b_1)$.
\end{lemma}
\begin{proof}
Supponiamo per cominciare che $A_0=A_1$ e denotiamo questo insieme con $S$.
Assumiamo $\phi(a_0,b_0)$ e quindi, per la completezza di $q$, che $\phi(a_0,y)\in q$.
Per la completezza di $p$  abbiamo che $a_0\equiv_Aa_1$.
Quindi, per l'invarianza di $q$ otteniamo $\phi(a_1,y)\in q$ e da questo segue $\phi(a_1,b_1)$.

Per concludere, consideriamo il caso $A_0\neq A_1$.
Sia $A=A_0\cup A_1$ e fissiamo $a_2\models  p_{\restriction A}$ e $b_2\models q_{\restriction A,a_2}(y)$.
Per quanto sopra dimostrato otteniamo $\phi(a_0,b_0)\iff\phi(a_2,b_2)$ ed anche $\phi(a_2,b_2)\iff\phi(a_1,b_1)$.
\end{proof}

Conviene immaginarsi questa operazione di prodotto come il passo induttivo per la costruzione di una sequenza di Morley.

\begin{definition}\label{def_prodotto_tipi}
Dati $p({\mr x}),q(y)\in S(\U)$ dove $q(y)$ \`e un tipo invariante, definiamo il prodotto di $p$ e $q$ come il tipo:

%\ceq{\hfill p({\mr x})\otimes q(y)}{=}{\Big\{\phi(x,y)\ :\ \phi(b,c) \textrm{ per qualche } a\models p_{\restriction A},\ b\models q_{\restriction A,a}(y) ed $S$ t\Big\}}

\ceq{\hfill\mbox{\emph{$p({\mr x})\otimes q(y)$}}}{=}{\Big\{\phi(x,y)\ :\ \textrm{esistono } a,b\ \models\ \phi(x,y)\ \wedge\ p_{\restriction A}({\mr x})\ \wedge\ q_{\restriction A,a}(y)\Big\}}

L'insieme $S$ nella definizione \`e uno qualsiasi che contiene i parametri di $\phi(x,y)$ e su cui $q(y)$ \`e invariante.
Il lemma~\ref{lemma_prodotto} assicura che la definizione non dipende dal particolare insieme scelto.
\end{definition}

Il lemma~\ref{lemma_prodotto} ha anche la seguente importante conseguenza:

\begin{corollary}\label{cor_otimes_completo}
Se $p({\mr x}),q(y)\in S(\U)$ e $q(y)$ \`e invariante, allora $p({\mr x})\otimes q(y)$ \`e un tipo completo.
\end{corollary}

\begin{proof}
Sia $\phi(x,y)\in L(\U)$.
Fissiamo un insieme $S$ contenente i parametri di $\phi(x,y)$ e su cui $q(y)$ sia invariante.
Fissiamo $a,b$ arbitrari tali che $a\models p_{\restriction A}({\mr x})$ e $b\models q_{\restriction A,a}(y)$.
Dal lemma~\ref{lemma_prodotto} otteniamo che $\phi(x,y)\in p({\mr x})\otimes q(y)$ se e solo se $\phi(a,b)$.
\end{proof}


\begin{corollary}
Se $p({\mr x}),q(y)\in S(\U)$ sono tipi globali $S$-invarianti, allora anche $p({\mr x})\otimes q(y)$ \`e $S$-invariante.
\end{corollary}

\begin{proof}
Sia $\phi(x,y,z)\in L$, sia $c$ arbitrario tale che  $\phi(x,y,c)\in p({\mr x})\otimes q(y)$, e sia $c'\equiv_Ac$.
Fissiamo $a\models p_{\restriction A,c,c'}$.
Poich\'e $p$ \`e invariante su $S$, otteniamo $a,c\equiv_Aa,c'$.
Ora fissiamo un $b$ arbitrario tale che $b\models q_{\restriction A,c,c',a}$.
Per l'invarianza di $q$ su $S$ otteniamo  $a,b,c\equiv_Aa,b,c'$ e quindi $\phi(a,b,c')$.
Seque che $\phi(x,y,c)\in p({\mr x})\otimes q(y)$.
\end{proof}

\begin{proposition}
Se $p({\mr x}),q(y)\in S(\U)$ sono finitamente soddisfacibili su $A$, allora $p({\mr x})\otimes q(y)$ \`e finitamente soddisfacibile su $A$.
\end{proposition}

\begin{proof}
Sia $\phi(x,y)\in p({\mr x})\otimes q(y)$ arbitraria e fissiamo un $B$ contenente $A$ ed i parametri di $\phi(x,y)$.
Quindi esistono $a,b\models\phi(x,y)\,\wedge\,p_{\restriction B}({\mr x})\,\wedge\,q_{\restriction B,a}(y)$.
Allora $\phi(a,y)\in q$, e quindi $\phi(a,b')$ per un qualche $b'\in A$.
Allora $\phi(x,b')\in p$, e quindi $\phi(a',b')$ per qualche $a'\in A$.
\end{proof}


Dato $p({\mr x})\in S(\U)$ un tipo globale invariante.
Sia $\<x_i:i<\omega\>$ una sequenza di tuple di variabili con $|x|=|x_i|$.
Definiamo induttivamente

\ceq{\hfill p^{(1)}(x_0)}{=}{p(x_0)}; 

\ceq{\hfill p^{(n+1)}(x_0,\dots,x_n)}{=}{p^{(n)}(x_0,\dots,x_{n-1})\otimes p(x_n)};

\ceq{\hfill p^{(\omega)}(x_i:i<\omega)}{=}{\bigcup_{n<\omega}p^{(n+1)}(x_0,\dots, x_n)}.

La seguente proposizione giustifica la definizione di $p^{(\omega)}$, la dimostrazione \`e immediata.

\begin{proposition}\label{prop_p^omega_Sorley}
Sia $p({\mr x})\in S(\U)$ un tipo globale $A$-invariante.
Allora le seguenti affermazioni sono equivalenti
\begin{itemize}
\item[1.]$\<c_i:i<\omega\>$ \`e una sequenze di Morley di $p$ su $A$;
\item[2.] $\<c_i:i<\omega\>\models p^{(\omega)}|__S$
\end{itemize}
\end{proposition}

La seguente proposizione torner\`a utile nei prossimi paragrafi, si osservi che  non \`e una conseguenza della proposizione~\ref{prop_p^omega_Sorley} perch\'e qui l'invarianza su $A$ non \`e tra le ipotesi.

\begin{proposition}
Sia $p({\mr x})\in S(\U)$ un tipo globale invariante ed $A$ un insieme arbitrario.
Allora ogni $\<c_i:i<\omega\>\models p^{(\omega)}|__S$ \`e una sequenza di indiscernibili su $A$.
\end{proposition}


\begin{proof}
\`E sufficiente verificare che se $\<c_i:i<\omega\>\models p^{(\omega)}|__S$ allora $c_{i_0},\dots,c_{i_n}\models p^{(n+1)}|__S$ per ogni $i_0<\dots<i_n<\omega$.

\end{proof}
\end{comment}
