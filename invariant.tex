% !TEX root = creche.tex
\chapter{Invariant sets}
\label{invariant}

\def\medrel#1{\parbox[t]{5ex}{$\displaystyle\hfil #1$}}
\def\ceq#1#2#3{\parbox[t]{14ex}{$\displaystyle #1$}\medrel{#2}{$\displaystyle #3$}}

In this chapter, $L$ is a signature, $T$ is a complete theory without finite models, and $\U$ is a saturated model of inaccessible cardinality $\kappa$ strictly larger than $|L|$.
We use the same notation and make the same implicit assumptions as in Section~\ref{monster}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Invariance under a group action}\label{invariant_sets}

Let $G$ be a group that acts on $\U^{\gr z}$.
In this chapter we only consider $G=\Aut(\U/A)$, but for later applcation we introduce a more general notation.
Let $\grD\subseteq\U^{\gr z}$.
We say that $\grD$ is an \emph{invariant\/} under the action of $G$, or \emph{$G$-invariant,} if it is fixed setwise by $G$.
That is, $g\grD=\grD$ for every $g\in G$.
Yet in other words, if

\ceq{\ssf{is1.}\hfill {\gr a}\in\grD}{\iff}{g{\gr a}\in\grD}\hfill for every ${\gr a}\in\U^{\gr z}$ and every $g\in G$.

% Suppose that $\grD=\phi({\mr a}\,;\U^{\gr z})$ for some $\phi({\mr x}\,;{\gr z})\in L$ and that $\phi({\mr\U}\,;\U^{\gr z})$ is invariant (this is always the case when $G$ acts by automorphisms).
% Then \ssf{is1} is aquivalent to

% \ceq{\ssf{is2.}\hfill\phi({\mr a}\,;{\gr z})}{\iff}{\phi(g{\mr a}\,;{\gr z})}\hfill for every ${\mr a}\in\U^{\mr x}$ and every $g\in G$.

The definition of invariant type is less straightforward.
We need to introduce some notation.
Let $\phi({\mr x}\,;{\gr z})\in L$.
A \emph{$\phi$-formula\/} is a formula the form $\theta({\mr x}\,;{\gr\bar b})$ for some $\theta({\mr x}\,;{\gr\bar z})$ that is a Boolean combination of the formulas $\phi({\mr x}\,;{\gr z_i})$, where ${\gr\bar z}={\gr z_1},\dots,{\gr z_n}$, and some ${\gr\bar b}\in\U^{\gr\bar z}$.
A \emph{$\phi$-definable\/} set is a set  $\theta({\mr\U}\,;{\gr\bar b})$ definable by a $\phi$-formula.
We write $L_\phi(\Aa)$ for the set of $\phi$-formulas with parameters in $\Aa$.

We are mainly concerned in $\Delta$-types where $\Delta$ is either $L(\Aa)$ or $L_\phi(\Aa)$.
In the latter case $\Delta$-types are called \emph{$\phi$-types.}
We denote by \emph{$S_\phi(\Aa)$\/} the set of maximal $\phi$-types with parameters in $\Aa$.
Typically, $\Aa$ is either $\U$ or some small set $A\subseteq\U$.
Types in \emph{$S_{\phi}(\U)$\/} are called \emph{global $\phi$-types.}
% They may be identified with subsets of $\U^{\gr z}$.
% Namely, $p({\mr x})\in S_\phi(\Aa)$ is identified with
   
% \ceq{\hfill\grD}{=}{\Big\{{\gr b}\in\Aa^{\gr z}\ :\ \phi({\mr x}\,;{\gr b})\in p\Big\}.}

% \begin{proposition}
% Suppose $M$ realizes every consistent type $p({\gr z})\subseteq L(A)$.
% Let $D\subseteq M^{\gr z}$ be such that \ssf{is2} holds for $D$ when restricted to ${\gr a},{\gr b}\in M^{\gr z}$.
% Then $D$ is the trace on $M$ of some unique $A$-invariant set $\grD$.
% \end{proposition}
% 
% \begin{proof}
% The set $\grD$ is the union, for $p({\gr z})\in S(A)$, of the sets $p(\U)$ that intersect $D$.
% \end{proof}

Let $p({\mr x})\subseteq L(\U)$ be a consistent type.
For every formula $\phi({\mr x}\,;{\gr z})\in L$ we define

\ceq{\hfill\emph{$\gr\D_{p,\phi}$}}{=}{\Big\{{\gr a}\in\U^{\gr z}\ :\ \phi({\mr x}\,;{\gr a})\in p\Big\}.}

We can read the notation in two ways: either the tuple ${\gr z}$ has length $\omega$ and is the same for all formulas, or it is finite and depends on $\phi$.
This is possible because adding or erasing dummy variables to the tuple of ${\gr z}$ does not change ${\gr\D_{p,\phi}}$ in any relevant way; in particular, invariance is preserved.

A $\phi$-type $p({\mr x})$ can be identified with the set ${\gr\D_{p,\phi}}$.
Therefore any type $p({\mr x})\subseteq L(\U)$ can be identified with the collection of the sets ${\gr\D_{p,\phi}}$, where $\phi({\mr x}\,;{\gr z})$ ranges over $L$.

We say that $p({\mr x})\subseteq L(\U)$ is \emph{invariant\/} under the action of $G$, or \emph{$G$-invariant,} if for every formula $\phi({\mr x}\,;{\gr z})\in L$ 

\ceq{\ssf{it1.}\hfill\phi({\mr x}\,;{\gr a})\in p}{\IFF}{\phi({\mr x}\,;g{\gr a})\in p}\hfill for every ${\gr a}\in\U^{\gr z}$ and every $g\in G$.

Hence $p({\mr x})$ is invariant exactly when all the sets $\gr\D_{p,\phi}$ are.

%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%
\section{Invariance over a set of parameters}

We now consider the case $G=\Aut(\U/A)$.
We say \emph{invariant over $A$\/} for invariant under the action of $\Aut(\U/A)$ and we write \emph{$A$-invariant\/} for $\Aut(\U/A)$-invariant.

Note that by homogeneity \ssf{is1} con be restated as

\ceq{\ssf{is3.}\hfill{\gr a}\equiv_A{\gr b}}{\IMP}{{\gr a}\in\grD\iff{\gr b}\in\grD}\hfill for all ${\gr a},{\gr b}\in\U^{\gr z}$.

This gives a bound on the number of sets invariant over $A$.

\begin{proposition}\label{prop_numberIS}
Let $\lambda=|L_{\gr z}(A)|$.
There are at most $2^{2^{\lambda}}$ sets $\grD\subseteq\U^{\gr z}$ that are invariant over $A$.
\end{proposition}
\begin{proof}
By \ssf{is3}, sets that are invariant over $A$ are unions of equivalence classes of the relation $\equiv_A$, that is, unions of sets of the form $p(\U^{\gr z})$ where $p({\gr z})\in S\/(A)$.
Then the number of $A$-invariant sets is at most $2^{|S_{\gr z}(A)|}$.
Clearly $|S_{\gr z}(A)|\le 2^\lambda$.
\end{proof} 

The invariance of types can be rephrased in a similar way.
That is, $p({\mr x})$ is invariant over $A$ if 

\ceq{\ssf{it2.}\hfill  {\gr a}\equiv_A{\gr b}}{\IMP}{\Big(\phi({\mr x}\,;{\gr a})\in p\,\IFF\,\phi({\mr x}\,;{\gr b})\in p\Big)}\hfill for all $\phi({\mr x}\,;{\gr z})\in L$ and ${\gr a},{\gr b}\in\U^{\gr z}$.

% In words we say that $p({\mr x})\subseteq L(\U)$ \emph{does not split\/} over $A$.

If $p({\mr x})$ is a global $\phi$-types types \ssf{it2} is equivalent to

\ceq{\ssf{it2$^\prime$.}\hfill  {\gr a}\equiv_A{\gr b}}{\IMP}{p({\mr x})\,\proves\,\phi({\mr x}\,;{\gr a})\iff\phi({\mr x}\,;{\gr b})}\hfill for all ${\gr a},{\gr b}\in\U^{\gr z}$.

Finally, we note the following is useful characterization of \ssf{it2$'$}

\ceq{\ssf{it3.}\hfill {\gr a}\equiv_A{\gr b}}{\IMP}{\phi({\mr c}\,;{\gr a})\iff\phi({\mr c}\,;{\gr b})}\hfill for all ${\gr a},{\gr b}\in\U^{\gr z}$ and for all ${\mr c}\models p_{\restriction A,{\gr a},{\gr b}}$.

This, when $p({\mr x})\in S(\U)$, can be rephrased as

\ceq{\ssf{it3$'$.}\hfill {\gr a}\equiv_A{\gr b}}{\IMP}{{\gr a}\equiv_{A,\,{\mr c}}{\gr b}}\hfill for all ${\gr a},{\gr b}\in\U^{\gr z}$ and for all ${\mr c}\models p_{\restriction A,{\gr a},{\gr b}}$.

%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%
\section{Invariant types from the dual perspective}\label{dual_perspective}

In the previous sections the invariance of $p({\mr x})$ has been definend using the sets ${\gr\D_{p,\phi}}$.
Here we examine invariance using the formulas in $p({\mr x})$.

Let $G$ be a group that acts on $\U^{\mr x}$ and $\U^{\gr z}$.
Let $\phi({\mr x}\,;{\gr z})\in L$ be such that $\phi(\U^{\mr x}\,;\U^{\gr z})$ is invariant under the action of $G$.
In particular, $g[\theta({\mr\U}\,;{\gr\bar b})]=\theta({\mr\U}\,;g{\gr\bar b})$ for every $g\in G$.
Therefore $p({\mr x})\subseteq L_\phi(\U)$ is invariant if

\ceq{\hfill p({\mr x})\proves{\mr x}\in\mrD}{\IFF}{p({\mr x})\proves{\mr x}\in g\mrD}\hfill for every $\phi$-definable $\mrD\subseteq\U^{\mr x}$ and $g\in G$.

Note that when $G$ acts by automorphisms $\phi(\U^{\mr x}\,;\U^{\gr z})$ is invariant for all $\phi({\mr x}\,;{\gr z})\in L$.
% Therefore when $G$ acts by automorphisms the results below that are stated for $\phi$-types and $\phi$-formulas but holds also for types and formulas.

Let $\mrX\subseteq\U^{\mr x}$ be a nonempty $G$-invariant set.
At the first reading one may assume that $\mrX=\U^{\mr x}$.
% as, again, more generality is required only in Section~\ref{}.

A set $\mrD\subseteq\U^{\mr x}$ is \emph{$G$-generic\/} in $\mrX$ if finitely many $G$-translations of $\mrD$ cover $\mrX$; we say \emph{$n$-$G$-generic\/} if $\le n$ translates suffices.
Dually, we say that $\mrD$ is \emph{$G$-persistent\/} in $\mrX$ if the intersection of any finitely many $G$-translations of $\mrD$ has a solution in $\mrX$; we say \emph{$n$-$G$-persistent\/} when the request is limited to $\le n$ translates.
We may drop reference to $G$ and $\mrX$ when these are clear from the context.

\noindent\llap{\textcolor{red}{\Large\warning}\kern1.5ex}\ignorespaces
The terminology above non-standard.
In~\cite{CK} the authors write \textit{quasi-non-dividing\/} for \textit{persistent}.
Their terminology has good motivations, but it would be a mouthful in our context.

The same properties may be attributed to formulas (as these are identified with the set they define).
When the properties above are attributed to a type $p({\mr x})$, it is understood that they holds for every $\phi({\mr x})$ that is a conjunction of formulas in $p({\mr x})$.
See Exercise~\ref{ex_persistent_types} for an alternative characterization when $p({\mr x})$ is small.

\begin{fact}\label{fact_fip}
  Let $G$ and $\mrX$ be as above.
  The following are equivalent
  \begin{itemize}
    \item[1.] $\mrD$ is not $n$-generic in $\mrX$
    \item[2.] $\neg\mrD$ is $n$-persistent in $\mrX$.
  \end{itemize}
\end{fact}

\begin{proof}
  Immediate by spelling out the definitions\smallskip
  \begin{itemize}
    \item[1.] there are no $g_1,\dots,g_n\in G$ such that \smash{$\displaystyle\mrX\ \subseteq\ \bigcup_{i=1}^n g_i{\mr\D}$}
    \item[2.]  $\displaystyle\0\ \neq\ \mrX\,\cap\,\bigcap_{i=1}^n\neg g_i{\mr\D}$ for every $g_1,\dots,g_n\in G$.\qedhere
  \end{itemize} 
\end{proof}

\begin{theorem}\label{thm_generic_invariant}
  Let $G$, $\mrX$, and $\phi({\mr x}\,;{\gr z})\in L$ be as above.
  Let $p({\mr x})\in S_\phi(\U)$ be finitely satisfiable in $\mrX$.
  Then the following are equivalent
  \begin{itemize}
    \item[1.] $p({\mr x})$ is invariant
    \item[2.] $p({\mr x})\proves{\mr x}\in\mrD$ for every generic $\phi$-definable set $\mrD$
    \item[3.] $p({\mr x})\proves{\mr x}\in\mrD$ for every 2-generic $\phi$-definable set $\mrD$
    \item[4.] $p({\mr x})$ is 2-persistent
    \item[5.] $p({\mr x})$ is persistent.
  \end{itemize}
\end{theorem}

\begin{proof}
  \ssf1$\IMP$\ssf2.
  Let $g_1{\mr\D},\dots,g_n{\mr\D}$ be translations of $\mrD$ that cover $\mrX$.
  Negate \ssf2.
  By completeness, $p({\mr x})\proves {\mr x}\notin\mrD$.
  Hence, from invariance we obtain

  \ceq{\hfill p({\mr x})}{\proves}{{\mr x}\ \notin\ \bigcup_{i=1}^ng_i\mrD.}

  This contradicts the finite satisfiability of $p({\mr x})$ in $\mrX$.

  \ssf2$\IMP$\ssf3.
  Trivial.
  
  \ssf3$\IMP$\ssf4.
  Let $\mrD$ be defined by a conjunction of formulas in $p({\mr x})$.
  If $\mrD$ is not 2-persistent then, by Fact~\ref{fact_fip}, $\neg\mrD$ is 2-generic. 
  By \ssf3, $p({\mr x})\proves{\mr x}\notin\mrD$, a contradiction.

  \ssf4$\IMP$\ssf1.
  % uppose $p({\mr x})$ is not $(n+2)$-persistent and let $n$ be minimal.
  % Let $g_1,\dots,g_{n+2}\in G$ and $\theta({\mr x})\,;{\gr\bar b}$ witness this.
  % Then 
  If $p({\mr x})$ is not invariant then, by completeness, $p({\mr x})\proves\phi({\mr x}\,;{\gr b})\wedge\neg\phi({\mr x}\,;g{\gr b})$ for some $g\in G$.
  Clearly $\phi({\mr x}\,;{\gr b})\wedge\neg\phi({\mr x}\,;g{\gr b})$ is not 2-persistent as it is inconsistent with its $g$-translation.

  \ssf5$\IMP$\ssf4.
  Trivial.

  \ssf2$\IMP$\ssf5.
  By the same argument as in \ssf3$\IMP$\ssf4.
\end{proof}

Theorem~\ref{thm_generic_invariant} gives a condition for a global $\phi$-type to be invariant.
The following theorem gives a condition for the existence of global invariant $\phi$-types.
Ideally, we would like to prove that every persistent $\phi$-type extends to global persistent type.
Unfortunately this is not true -- we need a stronger property: \ssf2 of Theorem~\ref{thm_generic_invariant2}.
In~\cite{CK} this is called \textit{quasi-non-forking}.

\begin{theorem}\label{thm_generic_invariant2}
  Let $G$, $\mrX$, and $\phi({\mr x}\,;{\gr z})\in L$ be as above.
  Let $\mrD\subseteq\U^{\mr x}$ be a $\phi$-definable set.
  Then the following are equivalent 
  \begin{itemize}
    \item[1.] there is an invariant type $p({\mr x})\in S_\phi(\U)$ finitely satisfiable in $\mrX\cap\mrD$
    \item[2.] every finite cover of $\mrD$ by $\phi$-definable sets contains a persistent set
    \item[3.] every finite cover of $\mrD$ by $\phi$-definable sets contains a 2-persistent set.
  \end{itemize}
\end{theorem}

\begin{proof}
  \ssf1$\IMP$\ssf2.
  Suppose ${\mr\C_1},\dots,{\mr\C_n}$ cover $\mrD$ and pick $p({\mr x})$ as in \ssf1.
  By completeness, $p({\mr x})\proves {\mr x}\in{\mr\C_i}$ for some $i$.
  Then, by Theorem~\ref{thm_generic_invariant}, $\neg{\mr\C_i}$ is not generic.
  Therefore, by Fact~\ref{fact_fip}, ${\mr\C_i}$ is persistent.
  
  \ssf2$\IMP$\ssf3.
  Trivial.

  \ssf3$\IMP$\ssf1.
  Let $p({\mr x})$ be maximal among the $\phi$-types that contain ${\mr x}\in\mrD$ and are such that $\theta({\mr\U})$ satisfies \ssf3 for every $\theta({\mr x})$ that is conjunction of formulas in $p({\mr x})$.
  We claim that $p$ is a complete $\phi$-type.
  Suppose for a contradiction that $\theta({\mr x}),\neg\theta({\mr x})\notin p$.
  By maximality there is some formula $\psi({\mr x})$, a conjunction of formulas in $p({\mr x})$ and some ${\mr\C_1},\dots,{\mr\C_n}$ that cover both $\psi({\mr\U})\cap\theta({\mr\U})$ and $\psi({\mr\U})\smallsetminus\theta({\mr\U})$ and such that no ${\mr\C_i}$ is persistent.
  This is a contradiction because ${\mr\C_1},\dots,{\mr\C_n}$ cover $\psi({\mr\U})$ which satisfies \ssf3.
  It is only left to show that $p({\mr x})$ is finitely satisfiable in $\mrX$ and invariant.
  Finite satisfiability follows from percistency.
  Negate invariance.
  Then, by Theorem~\ref{thm_generic_invariant} and completeness, $p({\mr x})\proves {\mr x}\notin\mrB$ for some generic definable set $\mrB$.
  As $\neg\mrB$ is not persistent by Fact~\ref{fact_fip}, this contradics \ssf3.
\end{proof}

Unfortunatelly, genericy is not preserved under intersection.
For that, we need to press the concept to the next level of complexity.
This is required in Section~\ref{newelski}.

A set $\mrD\subseteq\U^{\mr x}$ is \emph{strongly generic\/} if the intersection of any finitely many translations of $\mrD$ is generic.
Dually, we say that $\mrD$ is \emph{weakly persistent\/} if the union of some finitely many translations of $\mrD$ is peristent.
Again, the same properties may be attributed to formulas and types.

\begin{lemma}\label{lem_strongly_generic}
  Let $G$ and $\mrX$ be as above.
  Then the intersection of finitely many strongly generic sets is strongly generic.
\end{lemma}

\begin{proof}
  As the theorem does not mention definability, we may assume that all sets mentioned below are subsets of $\mrX$.
  Let ${\mr\D}$ and ${\mr\C}$ be strongly generic and let $K\subseteq G$ be an arbitrary finite set.
  It suffices to prove that 
  
  \ceq{\hfill\mrB}{=}{\bigcap_{k\in K}k\,({\mr\C}\cap{\mr\D})}

  is generic. 
  Clearly $\mrB={\mr\C'}\cap{\mr\D'}$, where
  
  \ceq{\hfill{\mr\C'}}{=}{\bigcap_{k\in K}k\,{\mr\C}}
  \ceq{\hfill{\rm and}\hfill{\mr\D'}}{=}{\bigcap_{k\in K}k\,{\mr\D}.}

  Note that ${\mr\C'}$ and ${\mr\D'}$ are both strongly generic.
  In particular \smash{$\displaystyle\mrX=\bigcup_{h\in H}h\,\mr\D'$} for some finite $H\subseteq G$.
  As, trivially

  \ceq{\hfill\bigcup_{h\in H}h\,\mrB}{=}{\bigcup_{h\in H}\Big[h\,{\mr\C'}\ \cap\ h\,{\mr\D'}\Big]}

  we conclude that
  
  \ceq{\hfill\bigcup_{h\in H}h\,\mrB}{\supseteq}{\bigcap_{h\in H}h\,{\mr\C'}}

  The set on the r.h.s.\@ is (strongly) generic.
  Therefore also the set on the l.h.s.\@ is generic.
  The genericity of $\mrB$ follows.
\end{proof}

\begin{corollary}\label{corol_str_gen}
  Let $G$, $\mrX$, and $\phi({\mr x},;{\gr z})\in L$ be given.
  Let 
  
  \ceq{\hfill q({\mr x})}{=}{\{\theta({\mr x})\in L_\phi(\U)\ :\ \theta({\mr x})\textrm{ strongly generic }\}.}

  Then $q({\mr x})$ is finitely satisfiable in $\mrX$, strongly generic, and invariant.
\end{corollary}

\begin{proof}
  Strong genericity is an immediate consequence of Lemma~\ref{lem_strongly_generic}.
  Finite satisfiability is a consequence of genericity, see Exercise~\ref{ex_gen_sat}.
  As for invariance, note that any translate of a strongly generic formula is also strongly generic.
\end{proof}

\begin{corollary}\label{corol_q_w_pers}
  Let $\mrC\subseteq\mrX$ be $\phi$-type-definable and such that $q({\mr x})$ of Corollary~\ref{corol_str_gen} is finitely satisfied in $\mrC$.
  Then $\mrC$ is weakly persistent.
\end{corollary}

\begin{proof}
  Let $\theta({\mr x})\in L_\phi(\U)$ be such that $\mrC\subseteq\theta(\mrU)$.
  As $q({\mr x})$ is finitely satisfiable in $\theta(\mrU)$, we cannot have that $\neg\theta({\mr x})$ is strongly generic.
  Reasoning as for Fact~\ref{fact_fip} we prove that for every set $\mrD$ the following are equivalent
  \begin{itemize}
    \item[1.] $\mrD$ is not strongly $n$-generic in $\mrX$
    \item[2.] $\neg\mrD$ is weakly $n$-persistent in $\mrX$.
  \end{itemize}
  Therefore $\theta({\mr x})$ weakly persistent.
\end{proof}

\begin{exercise} 
  Prove that generic, invariant types that are closed under conjunction are strongly generic.
\end{exercise}

\begin{exercise}
  Show that generic sets are not closed under intersection.
  Hint: try e.g.\@ with the cyclic order in Example~\ref{ex_cyclic_order}.
\end{exercise}

% \begin{exercise}
%   Where in this section the assumption that $\mrX$ is $G$-invariant is used?
% \end{exercise}

\begin{exercise}\label{ex_gen_sat}
  Prove that every generic type is finitely satisfiable.
\end{exercise}

\begin{exercise}\label{ex_persistent_types}
  Let $G$, $\X$, and $\phi(x,;z)\in L$ be given.
  Prove that for every $p(x)\subseteq L_\phi(A)$ following are equivalent
  \begin{itemize}
    \item[1.] $p(x)$ is persistent
    \item[2.] $p(\U^x)$ is persistent.
  \end{itemize}
\end{exercise}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Heirs and coheirs}
\label{coheirs}

\def\medrel#1{\parbox[t]{6ex}{$\displaystyle\hfil #1$}}
\def\ceq#1#2#3{\parbox[t]{16ex}{$\displaystyle #1$}\medrel{#2}{$\displaystyle #3$}}

The easiest way to obtain types that are invariant over a model $M$ is via types that are finitely satisfiable in $M$.
We say that a type $p({\mr x})$ is \emph{finitely satisfiable\/} in $A$ if every conjunction of formulas in $p({\mr x})$ has a solution in $A^{\mr x}$.

\begin{proposition}\label{prop_coeredi_quasiinvarienti}
  Every type $p({\mr x})\subseteq L(\U)$ that is finitely satisfiable in $A$ is invariant over $A$.
\end{proposition}

\begin{proof}
  Note that $p({\mr x})$ is $\Aut(\U/A)$-persistent, in fact the same ${\mr a}\in A^{\mr x}$ that satisfies $\phi({\mr x})$ also satisfies every $\Aut(\U/A)$-translate of $\phi({\mr x})$.
  Then the proposition follows from Theorem~\ref{thm_generic_invariant}.
  (But a direct proof is also easy.)
\end{proof}

\begin{proposition}\label{prop_exisntence_coheirs}
  Every type $q({\mr x})\subseteq L(\U)$ that is finitely satisfiable in $A$ has an extension to a global type that is finitely satisfiable in $A$.
\end{proposition}

\begin{proof}
  Let $p({\mr x})\subseteq L(\U)$ be maximal among the types that contain $q({\mr x})$ and are finitely satisfiable in $A$.
  We prove that $p({\mr x})$ is complete.
  If for a contradiction $p({\mr x})$ contains neither $\psi({\mr x})$ nor $\neg\psi({\mr x})$, then  neither $p({\mr x})\cup\big\{\psi({\mr x})\big\}$ nor $p({\mr x})\cup\big\{\neg\psi({\mr x})\big\}$ are finitely satisfiable in $A$.
  This contradicts the finite satisfiability of $p({\mr x})$.
\end{proof}

In most cases we work with types that are finitely satisfiable over a model.
The reason is explained by the next proposition, which is clear by elementarity.

\begin{proposition}\label{prop_coher_over_model}
  Every consistent type over a model is finitely satisfiable in that model, that is, whenever $p({\mr x})\subseteq L(M)$ is consistent, $p({\mr x})$ is finitely satisfiable in $M$.
\end{proposition}

\begin{definition}\label{def_choeir_uno}
  A type $p({\mr x}) \subseteq L(\U)$ that is finitely satisfiable in $M$ is said to be a \emph{coheir\/} of $p_{\restriction M}({\mr x})$.
\end{definition}

In many cases it is useful to focus on elements instead of types.
We introduce the following notation to express that $\tp({\mr a}/M,{\gr b})$ is finitely satisfied in $M$.

\begin{definition}\label{def_coheir_idepencence}
  For every ${\mr a}\in\U^{\mr x}$ and ${\gr b}\in\U^{\gr z}$ we define

  \noindent\llap{\textcolor{red}{\Large\warning}\kern1.5ex}
  %
  \ceq{\hfill\emph{${\mr a}\cnonfork_M{\gr b}$}}
  {\IFF}
  {\phi(M^{\mr x},{\gr b})\neq\0
  \textrm{ for all }\phi({\mr x}\,;{\gr z})\in L(M) 
  \textrm{ such that }\phi({\mr a}\,;{\gr b})}.

  We say that $\tp({\mr a}/M,{\gr b})$ is a \emph{coheir} of $\tp({\mr a}/M)$, or, equivalently, that $\tp({\mr b}/M,{\gr a})$ is a \emph{heir} of $\tp({\mr b}/M)$.
  We define the type

  \ceq{\hfill\emph{${\mr x}\cnonfork_M{\gr b}$}}
  {=}
  {\Big\{\neg\phi({\mr x}\,;{\gr b})
  \ :\ 
  \phi({\mr x}\,;{\gr b})\in L(M)
  \textrm{ and } \phi(M^{\mr x}\,;{\gr b})=\0\Big\}.}

  We will write \emph{${\mr a}\equiv_M{\mr x}\cnonfork_M{\gr b}$} for the union of the types ${\mr x}\cnonfork_M{\gr b}$ and $\tp({\mr a}/M)$.
\end{definition}

The tuples ${\mr a}$ realizing ${\mr x}\cnonfork_M{\gr b}$ are exactly those such that ${\mr a}\cnonfork_M{\gr b}$.
Note that $\tp({\mr a}/M,{\gr b})$ is a coheir of $\tp({\mr a}/M)$ according to Definition~\ref{def_choeir_uno}, so the terminology is consistent.

We think of  ${\mr a}\cnonfork_M{\gr b}$ as saying that 
${\mr a}$ is \emph{independent\/} from ${\gr b}$ over $M$.
This is a strong notion of independence.
In general it is not symmetric, that is ${\mr b}\cnonfork_M{\gr a}$ is not equivalent to ${\gr a}\cnonfork_M{\mr b}$. In Chaper~\ref{stability} we will see that the symmetry of this repation is equivalent to stability.

We will use the following easy lemma without explicit reference.

\begin{lemma}\label{lem_coheir_independence}
  The following properties hold for all $M,{\mr a},{\mr b}$, and $c$
  \begin{itemize}
  \item[1.] ${\mr a}\cnonfork_M{\gr b}\ \ \IMP\ \ f{\mr a}\cnonfork_Mf{\gr b}$ \ \ 
            for every $f\in\Aut(\U/M)$\hfill \textit{invariance}
  \item[2.] ${\mr a}\cnonfork_M{\gr b}\ \ \IFF\ \ {\mr a_0}\cnonfork_M{\gr b_0}$
            \ for all finite ${\mr a_0}\subseteq{\mr a}$ and 
            ${\gr b_0}\subseteq{\gr b}$ \hfill\textit{finite character}
  \item[3.] ${\mr a}\cnonfork_Mc,{\gr b}$ \ and \ 
            $c\cnonfork_M{\gr b}\ \ \IMP\ \ {\mr a},c\cnonfork_M{\gr b}$
            \hfill\hfill\hfill\textit{transitivity}
  \item[4.] ${\mr a}\cnonfork_M{\gr b}\ \ \IMP\ \ $ 
            there exists ${\mr a'}\equiv_{M,\,{\gr b}}{\mr a}$ such that 
            ${\mr a'}\cnonfork_M{\gr b},c$
            \hspace{\stretch{20}}\textit{coheir extension}
  \item[5.] ${\mr a}\cnonfork_M{\gr b_1},{\gr b_2}$ \ and \ 
  ${\gr b_1}\equiv_M{\gr b_2}\ \ \IMP\ \ {\gr b_1}\equiv_{M,\,{\mr a}}{\gr b_2}$
            \hspace{\stretch{20}}\textit{non-splitting}
  \end{itemize}
\end{lemma}
\begin{proof}
  Properties \ssf{1}-\ssf{3} follow immediately from Definition~\ref{def_coheir_idepencence}.
  We prove \ssf{4}.
  Assume ${\mr a}\cnonfork_M{\gr b}$, that is, $\tp({\mr a}/M,{\gr b})$ is finitely satisfiable in $M$.
  By Proposition~\ref{prop_exisntence_coheirs} $\tp({\mr a}/M,{\gr b})$ extends to a global type $p({\mr x})$ that is finitely satisfiable in $M$.
  Then any ${\mr a'}\models p_{\restriction M,\,{\gr b},\,c}({\mr x})$ proves the lemma.
  The proof of \ssf{5} is left to the reader.
\end{proof}

\begin{proposition}\label{prop_saturate_heir}
  Let ${\mr a}\cnonfork_M{\gr b}$ then there is $\V\preceq\U$ that is isomorphic to $\U$ and such that ${\gr b}\in\V^{\gr z}$ and ${\mr a}\cnonfork_M\V$.
\end{proposition}

\begin{proof}
  Let $c$ be an enumeration of $\U$.
  Let $p(w,{\gr z})=\tp(c,{\gr b}/M)$.
  We can take $\V$ to be the structure enumerated by the tuple that realizes symultaneously $p(w,{\gr b}) $ and the following type 

  \ceq{\hfill\Big\{\neg\phi({\mr a},w,{\gr b})}{:}{\phi({\mr x},w,{\gr z})\in L(M),\ \ p(w,{\gr b})\imp\phi(M^{\mr x},w,{\gr b})=\0\Big\}.}

  We only need to prove consistency.
  If inconsistent, then 

  \ceq{\hfill\theta(w,{\gr b})}{\imp}{\bigvee_{i=1}^n\phi_i({\mr a},w,{\gr b})}
  
  for some $\theta(w,{\gr b})\in p$ and some $\phi_i({\mr x},w,{\gr b})$ such that $p(w,{\gr b})\imp\phi_i(M,w,{\gr b})=\0$.
  We obtain a contradiction because by elementarity we can replace ${\mr a}$ by some ${\mr a'}\in M^{\mr x}$.
\end{proof}

%Transitivity has dual version that holds under stronger assumptions.

The type ${\mr a}\equiv_M{\mr x}\cnonfork_M{\gr b}$ in Definition~\ref{def_coheir_idepencence} is the intersection of all global coheirs of $\tp({\mr a}/M)$.
%
Its consistency is guaranteed by the fact that $M$ is a model (see Proposition~\ref{prop_coher_over_model}).
%
However, in general it need not be a complete type over $M,{\gr b}$.
%
In fact, its completeness of this type is a property with important consequences.

\begin{definition}\label{def_coheir_stationary} We say that $\cnonfork_M$ is \emph{stationary\/} if ${\mr a}\equiv_M{\mr x}\cnonfork_M{\gr b}$ is a complete type over $M,{\gr b}$ for all finite tuples ${\gr b}$ and ${\mr a}$.
We say \emph{$n$-stationary\/} if we limit the request to tuples ${\mr a}$ of length $n$.
\end{definition}

An application of stationarity is given in Section~\ref{semigroups}.
Stationarity is often ensured by the following property, which will receive due attention in Section~\ref{stable_theories}.

\begin{proposition}
Let ${\mr x}$ be a tuple of variables of length $n$.
If for every $\phi({\mr x})\in L(\U)$ there is a formula $\psi({\mr x})\in L(M)$ such that $\phi(M^{\mr x})=\psi(M^{\mr x})$ then $\cnonfork_M$ is $n$-stationary.
\end{proposition}

\begin{proof}
Let ${\gr b}\in\U^{\gr z}$ and ${\mr a_1},{\mr a_2}\in\U^{\mr x}$ be such that ${\mr a_i}\cnonfork_M{\gr b}$ and ${\mr a_1}\equiv_M{\mr a_2}$.
We claim that ${\mr a_1}\equiv_{M,\,{\gr b}}{\mr a_2}$.
We need to prove that $\phi({\mr a_1}\,;{\gr b})\iff\phi({\mr a_2}\,;{\gr b})$ for every  $\phi({\mr x}\,;{\gr z})\in L(M)$.
Let $\psi({\mr x})\in L(M)$ be such that $\phi({\mr\U}\,;{\gr b})=\psi({\mr \U})$.
From ${\mr a_i}\cnonfork_M{\gr b}$ we obtain that  $\phi({\mr a_i}\,;{\gr b})\iff\psi({\mr a_i})$.
Finally, the claim follows because ${\mr a_1}\equiv_M{\mr a_2}$.
\end{proof}

% \begin{lemma}\label{lem_coheirext}
% If ${\gr a}\nonforkc_A{\mr c}$ then for every ${\gr b}$ there is ${\mr c'}$ such that ${\gr a},\,{\gr b}\nonforkc_A{\mr c'}\equiv_{A,\,{\gr a}}{\mr c}$.
% \end{lemma}

% \begin{exercise}.
% Prove that every invariant type $q({\mr x})\subseteq L(\U)$ can be extended to a global invariant type $p({\mr x})\in S(\U)$.(?)
% \end{exercise}

% We say that $p({\mr x})\in S(\U)$ is a \emph{global heir\/} of $p_{\restriction M}({\mr x})$ if  
% 
% \ceq{\hfill{\gr\D_{p,\phi}}\cap M^{\gr z}\neq\0}{\IFF}{{\gr\D_{p,\phi}}\neq\0}  for every formula $\phi({\mr x}\,;{\gr z})\in L$.

%Every type over a model has an extension to a global coheir.
%A satisfactory generalization of this notions to types over sets should guarantee this existence.
%Unfortunately, this is not possible in general and the definition Section~\hyperref[coheirs_sets]{\ref*{invariantL}.\ref*{coheirs_sets}} is as good as it gets.

% \begin{remark}\label{rk_coheir_stationary}
% %The stationarity of $\cnonfork_A$ over every set $A$, or just over every model, is equivalent to the stability of $T$, see Section~\hyperref[stable_teories]{\ref*{external}.\ref*{stable_teories}}.
% There are theories where the stationarity of $\cnonfork_M$ holds for some particular $M$.
% For example, if every subset of $M^n$ is $M$-definable then $\cnonfork_M$ is clearly $n$-stationary.
% This simple observation will help in the proof of Theorem~\ref{thm_Hindman}.
% For a natural example, let $T=T_{\rm dlo}$ and let $M\subseteq\U$ have the order type of $\RR$.
% By quantifier elimination every definable subset of $\U$ is a union of finitely many intervals.
% By Dedekind completeness, the trace on $M$ of any interval of $\U$ coincides with that of an $M$-definable interval.
% \end{remark}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\section{Morley sequences and indiscernibles}

In what follows $\alpha$ is some ordinal $\le\kappa$, typically $\omega$, and ${\mr x}$ is a tuple of variables of length $<\kappa$.

Let \mbox{$p({\mr x})\in S(\U)$} be a global type.
We say that ${\mr\bar c}=\<{\mr c_i}:i<\alpha\>$ is a \emph{Morley sequence\/} of $p({\mr x})$ over $A$ if for every $i<\alpha$

\ceq{\ssf{Ms.}\hfill {\mr c_i}}{\models}{p_{\restriction  A,\,{\mr c_{\restriction i}}}({\mr x})}.

When $p({\mr x})$ is finitely satisfiable in $A$, we say that ${\mr\bar c}$ is a \emph{coheir sequence\/} of $p({\mr x})$ over $A$.

When we say that ${\mr\bar c}$ is a coheir sequence over $A$ (with no explicit reference to a global type), we mean that \textit{there is\/} a type $p({\mr x})\in S(\U)$ that is finitely satisfiable in $A$ such that ${\mr\bar c}$ is a \emph{coheir sequence\/} of $p({\mr x})$.

The following is a convenient characterization of coheir sequences.

\begin{lemma}\label{lem_coheir_property}
The following are equivalent
\begin{itemize}
\item[1.] ${\mr\bar c}=\<{\mr c_n}:n<\omega\>$ is a coheir sequence over $M$
\item[2.] ${\mr c_n}\cnonfork_M{\mr c_{\restriction n}}$ and ${\mr c_{n+1}}\equiv_{M,\,{\mr c_{\restriction n}}}{\mr c_n}$ for every $n<\omega$.
\end{itemize}
\end{lemma}

\begin{proof}
\ssf{1}$\IMP$\ssf{2}.
Assume \ssf{1} and let $p({\mr x})\in S(\U)$ be a global type that is finitely satisfiable in $M$ and such that ${\mr c_i}\models p_{\restriction M,{\mr c_{\restriction i}}}({\mr x})$.
The requirement ${\mr c_{n+1}}\equiv_{M,{\mr c_{\restriction n}}} {\mr c_n}$ is clear.
Now, suppose $\phi({\mr c_{n+1}})$ for some $\phi({\mr x})\in L(M,{\mr c_{\restriction n+1}})$.
Then $\phi({\mr x})$ belongs to $p({\mr x})$, so $\phi({\mr\U})\cap M^{\mr x}\neq\0$ because $p({\mr x})$ is finitely satisfiable in $M$.
This proves ${\mr c_n}\cnonfork_M{\mr c_{\restriction n}}$.

\ssf{2}$\IMP$\ssf{1}.
Let $q({\mr x})=\{\phi({\mr x})\in L(M, {\mr\bar c})\,:\, \phi({\mr c_n}) \textrm{ holds for cofinitely many } n\}$.
%
We claim that $q({\mr x})$ is finitely satisfiable in $M$.
%
Let $\phi({\mr x}\,;{\mr z})\in L(M)$ be such that $\phi({\mr x}\,;{\mr c_{\restriction n}})\in q$.
%
By the definition of $q({\mr x})$, the formula $\phi({\mr c_m}\,;{\mr c_{\restriction n}})$ holds for all sufficiently large $m$.
%
Hence, from \ssf{2} we infer ${\mr c_m}\cnonfork_M{\mr c_{\restriction n}}$ and conclude that $\phi({\mr x}\,;{\mr c_{\restriction n}})$ is satisfied in $M$.

Let $p({\mr x})$ be any global extension of $q({\mr x})$ finitely saisfied in $M$.
%
We prove that ${\mr\bar c}$ is a Morley sequence of $p({\mr x})$ over $M$.
%
By \ssf{2} either ${\mr c_m}\models p_{\restriction  M,\,{\mr c_{\restriction n}}}({\mr x})$ for all $m\ge n$ or ${\mr c_m}\notmodels p_{\restriction  M,\,{\mr c_{\restriction n}}}({\mr x})$ for all $m\ge n$.
%
As $p({\mr x})$ extends $q({\mr x})$, the latter cannot occur.
\end{proof}

Let $(I,<_I)$ be a linear order.
A function ${\mr\bar a}:I\to\U^{\mr x}$ is said to be an \emph{$I$-sequence}, or simply a \emph{sequence\/} when $I$ is clear.
We will often introduce an $I$-sequence as ${\mr\bar a}=\<{\mr a_i}: i\in I\>$.

If $I_0\subseteq I$ we call ${\mr a_{\restriction I_0}}$ a \emph{subsequence\/} of ${\mr\bar a}$.
The subsets $I_0\subseteq I$ that are well-ordered by $<_I$, in particular the finite ones, are especially relevant.
When $I_0$ has order type $\alpha$, an ordinal, we identify ${\mr a_{\restriction I_0}}$ with a tuple of length $\alpha$.

Recall that \emph{$I^{(n)}$} denotes that the set of \emph{$n$-subsets\/} of $I$,  i.e.\@ the subsets of $I$ of cardinality $n$.
The notation \smallskip

\ceq{\hfill\emph{$\displaystyle\binom{I}{n}$}}{=}{I^{(n)}}

is also common.
\begin{definition}
Let $(I,<_I)$ be an infinite linear order and let ${\mr\bar a}$ be an $I$-sequence.
We say that ${\mr\bar a}$ is a \emph{sequence of indiscernibles\/} over $A$ or, an \emph{$A$-indiscernible sequence\/}, if ${\mr a_{\restriction I_0}}\equiv_A {\mr a_{\restriction I_1}}$ for every $I_0,I_1\in I^{(n)}$ and $n<\omega$.

\end{definition}

The indiscernibility condition can be formulated in a number of equivalent ways.
For example, we can require that, for every formula $\phi(x_1,\dots,x_n)\in L(A)$ and every pair of tuples in $I^n$ such that $i_0<\dots<i_n$ and $j_0<\dots<j_n$,


\ceq{\hfill\phi(a_{i_0},\dots,a_{i_n})}{\iff}{\phi(a_{j_0},\dots,a_{j_n})}

Alternatively, we can simply say that for all $i_0,\dots,i_n\in I$ the type $\tp(a_{i_0},\dots,a_{i_n}/A)$ only depends on the order type of $i_0,\dots,i_n$.

\begin{proposition}
Let $p({\mr x})\in S(\U)$ be a global $A$-invariant type and let ${\mr\bar c}=\<{\mr c_i}:i<\alpha\>$ be a Morley sequence of $p({\mr x})$ over $A$.
Then ${\mr\bar c}$ is an $A$-indiscernibles sequence.
\end{proposition}

\begin{proof}

%\def\ceq#1#2#3{\parbox[t]{20ex}{$\displaystyle #1$}{\hspace*{1ex}$\displaystyle #2$\hspace*{1ex}}{$\displaystyle #3$}}

We prove by induction on $n<\omega$ that

\ceq{\sharp\hfill {\mr c_{\restriction n}}}{\ \equiv_A}{\mr c_{\restriction I_0}}\ \ \ for every $I_0\subseteq\alpha$ of cardinality $n$.

For $n=0$ the claim is trivial.
We assume inductively that $\,\sharp\,$ above is true and prove that

\ceq{\hfill {\mr c_{\restriction n}},{\mr c_n}}{\equiv_A}{{\mr c_{\restriction I_0}},{\mr c_i}}\ \ \ for every $I_0<i<\alpha$.

As ${\mr\bar c}$ is  Morley sequence, ${\mr c_n}\equiv_{A,{\mr c_{\restriction n}}} {\mr c_i}$ whenever $n<i$.
Hence we can equivalently prove that

\ceq{\hfill {\mr c_{\restriction n}},{\mr c_i}}{\equiv_A}{{\mr c_{\restriction I_0}},{\mr c_i},}

which is equivalent to

\ceq{\hfill {\mr c_{\restriction n}}}{\equiv_{A,\,{\mr c_i}}}{{\mr c_{\restriction I_0}}.}

The latter holds by induction hypothesis $\,\sharp\,$ and the invariance of $p({\mr x})$ as formulated in \ssf{it3} of Section~\ref{invariant_sets}.
\end{proof}

%Let $I,<_I$ and $J,<_J$ be two infinite linear orders and let $a$ and $b$ be an $I$-sequence, respectively a $J$-sequence
%Note that the expression $a\equiv_A b$ is meaningless unless there is a unique isomorphism between $I,<_I$ and $J,<_J$.However it always make sense, even for non isomorphic orders, when $a$ and $b$ are indiscernibles over $A$.In fact, we agree that \emph{$a\equiv_A b$\/} means $a_{\restriction I_0}\equiv_A b_{\restriction J_0}$ for every finite $I_0\subseteq I$ and $J_0\subseteq J$ of equal cardinality.% That being said, the following proposition is immediate.


% \begin{proposition}\label{prop_embedding_indsc_seq}
% Let $J,<_J$ be an infinite linear orders of cardinality $<\kappa$ and let $a$ be an $A$-in\-dis\-cern\-i\-ble $J$-sequence.

% Let $I,<_I$ be another infinite linear order, and $b$ and  $A$-in\-dis\-cern\-i\-ble $I$-sequence such that $a\equiv_Ab$.Let $f:J\to I$ be an embedding of linear orders.Then $h(a_i)=b_{f(i)}$ for some $h\in\Aut(\U/A)$.
% \end{proposition}


% 
% \begin{exercise}
% Let $c=\<{\mr c_i}:i<\alpha \>$ be a constant sequence, i.e.\@ ${\mr c_0}={\mr c_i}$ for all $i$.Prove that $c$ is a Morley sequence over $A$ if and only if ${\mr c_0}\in(\dcl A)^{\mr x}$ and that $c$ is a coheir sequence over $A$ if and only if  ${\mr c_0}\in A^{\mr x}$.
% \end{exercise}



% \begin{exercise}
% The following are equivalent
% \begin{itemize}
%  \item[1.] $\grD$ is invariant over $M$;
%  \item[2.] $c_0\in\grD\iff c_1\in\grD$ for every $M$-indiscernible sequence $\<c_i:i<\omega\>$ 
% \end{itemize}
% 
% \end{exercise}


\begin{exercise}
  Let $\bar a$ be a sequence such that $a_{\restriction I_0}\equiv a_{\restriction I_1}$ for every $I_0,I_1$ such that $I_0<I_1$.
  Prove that $\bar a$ is a sequence of indiscernibles.
  \end{exercise}


  \section{Notes and references}

  
  \begin{biblist}[]\normalsize
    \bib{CK}{article}{
   author={Chernikov, Artem},
   author={Kaplan, Itay},
   title={Forking and dividing in ${\rm NTP}_2$ theories},
   journal={J. Symbolic Logic},
   volume={77},
   date={2012},
  %  number={1},
   pages={1--20},
  %  issn={0022-4812},
  %  review={\MR{2951626}},
  %  doi={10.2178/jsl/1327068688},
}
    
  \end{biblist}

  